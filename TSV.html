<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VIA.STACK | MASTER LAB v133.4</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#050505;--panel:#0b0b0b;--border:#222;
  --gold:#ffd600;--green:#2ecc71;--red:#ff4444;
  --font-ui:'Inter',sans-serif;--font-mono:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#ccc;font-family:var(--font-ui);
  height:100vh;display:flex;flex-direction:column;overflow:hidden;
}
header{
  padding:20px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
}
.brand{font-weight:900;color:#fff}
.brand span{color:var(--gold)}
.status{font-family:var(--font-mono);font-size:.7rem;color:var(--green)}

#workspace{flex:1;padding:20px;display:flex;flex-direction:column}
textarea{
  flex:1;background:#000;border:1px solid #333;border-radius:12px;
  color:#ccc;font-family:var(--font-mono);font-size:12px;
  padding:15px;resize:none;
}

.actions{display:grid;grid-template-columns:2fr 1fr;gap:15px;padding:20px}
.btn{
  padding:18px;border-radius:40px;border:2px solid var(--gold);
  background:transparent;color:var(--gold);
  font-weight:900;text-transform:uppercase;cursor:pointer;
}
.btn.secondary{border-color:#444;color:#777}

.exports{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
  padding:0 20px 20px;
}
.btn-export{
  background:#111;border:1px solid #222;border-radius:16px;
  padding:18px;color:#777;font-weight:700;font-size:.65rem;
  text-transform:uppercase;cursor:pointer;
}

#overlay{
  position:fixed;top:0;left:0;right:0;
  padding:10px;text-align:center;
  font-family:var(--font-mono);font-size:10px;font-weight:bold;
  transform:translateY(-100%);transition:.3s;z-index:999;
}
#overlay.active{transform:translateY(0)}
</style>
</head>

<body>

<div id="overlay">PROCESSING…</div>

<header>
  <div class="brand">VIA.<span>STACK</span> // ADMIN</div>
  <div class="status" id="sys">READY</div>
</header>

<div id="workspace">
  <textarea id="raw" placeholder="PASTE TSV DATA (25-COLUMN CANONICAL)"></textarea>
</div>

<div class="actions">
  <button class="btn" onclick="align()">INITIATE ALIGNMENT</button>
  <button class="btn secondary" onclick="location.reload()">RESET</button>
</div>

<div class="exports">
  <button class="btn-export" onclick="exportPDF()">PDF</button>
  <button class="btn-export" onclick="exportJSON()">JSON</button>
  <button class="btn-export" onclick="exportTSV()">TSV</button>
  <button class="btn-export" onclick="exportCSV()">CSV</button>
  <button class="btn-export" onclick="exportJS()">JS</button>
  <button class="btn-export" onclick="exportTXT()">TXT</button>
</div>

<script>
/* ===================== CONSTANTS ===================== */
const COLS = 25;
const LOCK_HEAD = 15;   // stable metadata
const LOCK_TAIL = 7;    // date → status

/* ===================== STATE ===================== */
const UI={
 raw:document.getElementById('raw'),
 overlay:document.getElementById('overlay'),
 sys:document.getElementById('sys')
};
let HEADERS=[],ROWS=[];

/* ===================== CORE ALIGNER ===================== */
function normalizeRow(cols){
 if(cols.length === COLS) return cols;

 const head = cols.slice(0, LOCK_HEAD);
 const tail = cols.slice(cols.length - LOCK_TAIL);

 const middle = cols.slice(LOCK_HEAD, cols.length - LOCK_TAIL)
                   .join(' ')
                   .replace(/\s+/g,' ')
                   .trim();

 const rebuilt = head
   .concat(middle.split('\t').length ? [middle] : [])
   .concat(tail);

 // pad if short
 while(rebuilt.length < COLS) rebuilt.splice(COLS-LOCK_TAIL,0,"");

 return rebuilt.slice(0,COLS);
}

function align(){
 const txt=UI.raw.value.trim();
 if(!txt) return status('ERROR: NO DATA',true);

 const lines=txt.split(/\r?\n/).filter(l=>l.trim());
 HEADERS=lines[0].split('\t');

 if(HEADERS.length!==COLS){
   return status(`ERROR: HEADER ${HEADERS.length} ≠ ${COLS}`,true);
 }

 ROWS=[];
 let fixed=0;

 lines.slice(1).forEach((l,i)=>{
   let cols=l.split('\t');
   if(cols.length!==COLS){
     cols=normalizeRow(cols);
     fixed++;
   }
   ROWS.push(cols);
 });

 status(`ALIGNED ${ROWS.length} ROWS | AUTO-FIXED ${fixed}`);
}

/* ===================== EXPORTERS ===================== */
function exportTSV(){
 const tsv=[HEADERS.join('\t')].concat(ROWS.map(r=>r.join('\t'))).join('\n');
 download(tsv,'vault.tsv','text/plain');
}
function exportCSV(){
 const csv=[HEADERS.join(',')].concat(ROWS.map(r=>r.join(','))).join('\n');
 download(csv,'vault.csv','text/csv');
}
function exportTXT(){
 const txt=ROWS.map(r=>r.join(' | ')).join('\n');
 download(txt,'vault.txt','text/plain');
}
function exportJSON(){
 const data=ROWS.map(r=>{
  const o={};HEADERS.forEach((h,i)=>o[h]=r[i]||"");return o;
 });
 download(JSON.stringify(data,null,2),'vault.json','application/json');
}
function exportJS(){
 const data=ROWS.map(r=>{
  const o={};HEADERS.forEach((h,i)=>o[h]=r[i]||"");return o;
 });
 download(`const VAULT_DATA=${JSON.stringify(data,null,2)};`,'vault.js','application/javascript');
}
function exportPDF(){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF('l','mm','a4');
 doc.setFontSize(10);
 doc.text('VIA.STACK MASTER EXPORT',14,14);
 doc.autoTable({
  head:[HEADERS],
  body:ROWS,
  startY:20,
  styles:{fontSize:6,overflow:'linebreak'},
  theme:'grid'
 });
 doc.save('vault.pdf');
 status('PDF EXPORTED');
}

/* ===================== UTILS ===================== */
function download(content,name,type){
 const b=new Blob([content],{type});
 const u=URL.createObjectURL(b);
 const a=document.createElement('a');
 a.href=u;a.download=name;
 document.body.appendChild(a);a.click();
 setTimeout(()=>{
  document.body.removeChild(a);
  URL.revokeObjectURL(u);
  status(`${name.toUpperCase()} EXPORTED`);
 },300);
}
function status(msg,err){
 UI.overlay.textContent=msg;
 UI.overlay.style.background=err?'#ff4444':'#ffd600';
 UI.overlay.style.color=err?'#fff':'#000';
 UI.overlay.classList.add('active');
 setTimeout(()=>UI.overlay.classList.remove('active'),2000);
 UI.sys.textContent=msg;
}
</script>

</body>
