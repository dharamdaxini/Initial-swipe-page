:root {
    /* Deep Dark Palette */
    --bg: #000000;
    --card-bg: #111111;
    --overlay-bg: #0d0d0d;
    --border: #222222;
    
    /* Accents */
    --gold: #ffd600;
    --blue: #3498db;
    --text: #ffffff;
    --muted: #555555;

    /* Typography */
    --font-chem: 'Crimson Text', serif;
    --font-ui: 'Inter', sans-serif;
    --font-code: 'JetBrains Mono', monospace;
}

/* Global Reset */
* { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    outline: none; 
}

body { 
    margin: 0; 
    height: 100vh; 
    background: var(--bg); 
    color: var(--text);
    font-family: var(--font-ui); 
    overflow: hidden; 
    user-select: none;
    -webkit-user-select: none; 
    touch-action: none; 
}

/* Chemistry Formatting */
sub { font-size: 0.7em; vertical-align: sub; line-height: 0; }
sup { font-size: 0.7em; vertical-align: super; line-height: 0; }

/* HUD ARCHITECTURE */
#header { 
    width: 90%; 
    margin: calc(25px + env(safe-area-inset-top)) auto 0; 
    z-index: 100; 
    position: relative; 
}

.header-meta { 
    display: flex; 
    justify-content: space-between; 
    font-family: var(--font-code); 
    font-size: 0.7rem; 
    color: var(--muted); 
    letter-spacing: 2px; 
}

.progress-track { 
    width: 100%; 
    height: 2px; 
    background: #1a1a1a; 
    margin-top: 10px; 
    border-radius: 1px; 
    overflow: hidden; 
}

#progress-bar { 
    height: 100%; 
    background: var(--gold); 
    width: 0%; 
    transition: width 0.4s ease; 
}

/* THE SINGULARITY STACK */
#stack { 
    position: relative; 
    width: 92%; 
    max-width: 400px; 
    height: 72vh; 
    margin: 30px auto 0; 
    perspective: 1200px; 
}

.card { 
    position: absolute; 
    width: 100%; 
    height: 100%; 
    background: var(--card-bg); 
    border-radius: 40px; 
    border: 1px solid var(--border);
    padding: 45px; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    box-shadow: 0 30px 90px rgba(0,0,0,0.9);
    will-change: transform; 
    cursor: grab; 
    transform: translate3d(0,0,0);
}

.card-q { 
    font-family: var(--font-chem); 
    font-size: 1.9rem; 
    line-height: 1.4; 
    font-style: italic; 
    font-weight: 600; 
    text-align: center; 
    color: #f0f0f0; 
}

/* VECTOR HUD LABELS */
.swipe-label {
    position: absolute; 
    inset: 0; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: #000; 
    color: #fff; 
    font-weight: 900; 
    font-size: 2rem; 
    text-transform: uppercase;
    border-radius: 40px; 
    z-index: 999; 
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 0.1s;
}

/* Hint Specific Styling */
.sl-down-hint { 
    color: var(--blue) !important; 
    font-size: 1.3rem !important; 
    text-transform: none !important; 
    font-family: var(--font-chem) !important; 
}

/* LOGIC ANALYSIS OVERLAY */
.overlay {
    position: absolute; 
    inset: 0; 
    background: var(--overlay-bg); 
    z-index: 1100; 
    padding: 40px;
    opacity: 0; 
    pointer-events: none; 
    border-radius: 40px; 
    transition: opacity 0.3s ease;
    display: flex; 
    flex-direction: column; 
    justify-content: center;
}

.overlay.active { 
    opacity: 1; 
    pointer-events: auto; 
}

.overlay-label { 
    font-size: 0.7rem; 
    color: var(--gold); 
    font-family: var(--font-code); 
    margin-bottom: 10px; 
    letter-spacing: 2px; 
}

.overlay-body { 
    font-size: 1.2rem; 
    line-height: 1.6; 
    color: #bbb; 
    margin-bottom: 30px; 
    font-family: var(--font-chem); 
}

/* Action Button */
.btn { 
    width: 100%; 
    padding: 20px; 
    border-radius: 50px; 
    border: none; 
    background: #fff; 
    color: #000; 
    font-weight: 900; 
    text-transform: uppercase; 
    font-family: var(--font-ui); 
    cursor: pointer;
}

/* System Loader */
#loader { 
    position: fixed; 
    inset: 0; 
    background: #000; 
    z-index: 5000; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-family: var(--font-code); 
    color: var(--gold); 
    letter-spacing: 5px; 
}
/* =========================================
   V80.0 SAFE TEXT VISIBILITY PATCH
   ========================================= */

/* 1. Gesture-Safe Content Wrapping */
.card-q, .overlay-body, .swipe-label {
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    max-height: 80%; /* Ensures room for swipe labels */
    overflow: hidden;
}

/* 2. Independent Overlay Physics */
.overlay {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
}

/* 3. Small Screen Adaptive Scaling (Height-Based) */
@media (max-height: 740px) {
    #stack { margin: 20px auto 0; height: 75vh; }
    .card { padding: 30px 25px; }
    .card-q { font-size: 1.5rem; line-height: 1.3; }
}

@media (max-height: 600px) {
    .card-q { font-size: 1.3rem; }
    .header-meta { margin-bottom: 5px; font-size: 0.6rem; }
    #header { margin-top: 15px; }
}

/* 4. Global Boundary Safety */
body, html {
    overflow: hidden;
    position: fixed; /* Prevents "bounce" on iOS */
    width: 100%;
}
/* ===== ALCHEMIST LAB STANDARD v132.50 ===== */

.alch-card {
  border: 2px solid #222;
  padding: 20px;
  margin-bottom: 30px;
  background: #fff;
  color: #000;
  font-family: var(--font-serif);
}

.alch-meta {
  font-family: var(--font-mono);
  font-size: 9pt;
  font-weight: bold;
  margin-bottom: 10px;
}

.alch-question {
  font-family: "Crimson Text", serif;
  font-size: 17pt;
  margin: 15px 0;
}

.alch-options {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin: 15px 0;
}

.alch-option {
  border: 1px solid #333;
  padding: 8px;
  text-align: center;
  font-family: "Inter", sans-serif;
  font-size: 10pt;
}

.alch-logic {
  border-left: 5px solid #2979ff;
  padding-left: 12px;
  margin: 15px 0;
  font-style: italic;
}

.alch-exec {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

.alch-steps {
  font-variant: small-caps;
  color: #2979ff;
}

.alch-steps div {
  margin-bottom: 8px;
}

.alch-anchor {
  text-align: right;
  font-family: "Inter", sans-serif;
  font-size: 9pt;
}

.alch-anchor div {
  margin-bottom: 6px;
}

.alch-hint {
  background: #000;
  color: #fff;
  padding: 10px;
  margin-top: 15px;
  font-family: "Inter", sans-serif;
  font-size: 10pt;
}

const puppeteer = require('puppeteer');

async function generateProtocolPDF(htmlContent) {
    const browser = await puppeteer.launch();
    const page = await browser.newPage();
    
    await page.setContent(htmlContent, { waitUntil: 'networkidle0' });
    
    // Wait for Fonts and MathJax
    await page.evaluateHandle('document.fonts.ready');
    await page.evaluate(() => {
        // Trigger KaTeX or MathJax rendering here if not pre-rendered
        return window.typesetPromise || Promise.resolve();
    });

    await page.pdf({
        path: 'research_protocol_v132.pdf',
        format: 'A4',
        printBackground: true,
        margin: { top: '0', right: '0', bottom: '0', left: '0' }
    });

    await browser.close();
}
