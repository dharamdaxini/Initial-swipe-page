<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V81.68 - Final</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
<style>
/* --- CORE INDUSTRIAL UI --- */
:root { --bg: #000; --card: #111; --gold: #ffd600; --serif: 'Libre Baskerville', serif; --ui: 'Outfit', sans-serif; --code: 'JetBrains Mono', monospace; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; height: 100vh; background: var(--bg); color: #fff; font-family: var(--ui); overflow: hidden; touch-action: none; }

#header { width: 92%; margin: calc(20px + env(safe-area-inset-top)) auto 0; z-index: 100; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--code); font-size: 0.75rem; color: #444; margin-bottom: 8px; }
.progress-track { width: 100%; height: 2px; background: #111; overflow: hidden; }
#progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.4s ease; }

#stack { position: relative; width: 92%; max-width: 420px; height: calc(100vh - 180px - env(safe-area-inset-top)); margin: 25px auto 0; perspective: 1200px; }
.card { position: absolute; width: 100%; height: 100%; background: var(--card); border-radius: 32px; border: 1px solid #222; padding: 40px 30px; display: flex; flex-direction: column; justify-content: center; z-index: 1; transition: filter 0.4s ease, opacity 0.4s ease; }
.card.study-active { filter: blur(20px) brightness(0.2); opacity: 0.5; }

.card-q { font-family: var(--serif); font-size: clamp(1.4rem, 5.5vw, 1.9rem); line-height: 1.5; font-weight: 700; text-align: center; pointer-events: none; transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1); }

.study-drawer { position: absolute; inset: 0; padding: 40px 20px; z-index: 10; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transform: translateY(30px); transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); }
.study-drawer.active { opacity: 1; visibility: visible; transform: translateY(0); }

.study-header { font-size: 0.7rem; color: #555; font-family: var(--code); letter-spacing: 4px; font-weight: 900; text-transform: uppercase; margin-bottom: 20px; }
.bullet-item { font-size: 1.1rem; line-height: 1.8; color: #ccc; font-family: var(--serif); margin-bottom: 20px; padding-left: 24px; position: relative; list-style:none; }
.bullet-item::before { content: ""; position: absolute; left: 0; top: 12px; width: 6px; height: 6px; background: var(--gold); border-radius: 50%; }
.principle-text { font-size: 1.3rem; line-height: 1.5; color: var(--gold); font-family: var(--serif); font-style: italic; border-top: 1px solid #222; padding-top: 20px; }

.swipe-label { position: absolute; top: 60px; left: 0; width: 100%; display: none; justify-content: center; font-weight: 900; font-size: 1.2rem; color: var(--gold); z-index: 2000; }
#loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--gold); letter-spacing: 4px; }
</style>
</head>
<body>

<div id="loader">ALCHEMIST V81.68</div>
<div id="header">
    <div class="header-meta"><span>STRESS TEST MATRIX</span><span id="xp-ui">0 XP</span></div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
    <div id="sl-up" class="swipe-label">↑ SUBMIT DATA</div>
    <div id="study-drawer" class="study-drawer">
        <div class="study-header">Analysis</div>
        <div id="bullet-mount"></div>
        <div class="study-header" style="margin-top:30px">The Principle</div>
        <div id="judgement-text" class="principle-text"></div>
    </div>
</div>

<script>
// --- SANITIZED DEPLOYMENT LINK ---
const DEPLOY_URL = "https://script.google.com/macros/s/AKfycby1KCqAjaEW61_jHV8D9vl8odhJi0yzcXdcpcBWl7PpRwgafuT4eplpzxxBBSrRwXAm/exec";

const DATABASE = [
    { "q": "Signs of ΔH and ΔS for spontaneity at all temps?", "topic": "Thermodynamics", "difficulty": "B", "bullets": ["ΔH must be negative (Exothermic)", "ΔS must be positive (Increased entropy)", "ΔG must be negative for all T"], "j": "Nature favors states of lower energy and higher chaos." },
    { "q": "When is a reaction with +ΔH and +ΔS spontaneous?", "topic": "Thermodynamics", "difficulty": "C", "bullets": ["Spontaneous only at High Temperatures", "TΔS term must exceed the positive ΔH"], "j": "Heat provides the energy required to overcome chemical stability." }
];

let POOL = [...DATABASE], SCORE = 0, isTransitioning = false, questionStartTime = 0, latencyMS = 0, isLocked = false;

const format = t => t.toString().replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>').replace(/Δ/g, '&Delta;');

function init(){ 
    console.log("ALCHEMIST: Engine Online");
    setTimeout(() => { 
        const loader = document.getElementById('loader');
        if(loader) loader.remove(); 
    }, 1500); 
    renderNext(); 
}

function renderNext(){
    const s = document.getElementById('stack');
    const existing = s.querySelector('.card'); if(existing) existing.remove();
    if(!POOL.length){ s.innerHTML = `<div class="card"><div class="card-q">POOL COMPLETE</div></div>`; return; }
    
    const q = POOL[0];
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">${format(q.q)}</div>`;
    s.appendChild(c); 
    
    questionStartTime = Date.now(); latencyMS = 0; isLocked = false;
    document.getElementById('bullet-mount').innerHTML = q.bullets.map(b => `<div class="bullet-item">${format(b)}</div>`).join('');
    document.getElementById('judgement-text').innerText = q.j;
    document.getElementById('study-drawer').classList.remove('active');
    bindPhysics(c, q);
}

function bindPhysics(el, qData){
    let sy=0, active=false, finalDist=0;
    const drawer = document.getElementById('study-drawer');
    const label = document.getElementById('sl-up');
    const queText = el.querySelector('.card-q');

    el.ontouchstart = e => { if(isTransitioning) return; active=true; sy=e.touches[0].clientY; };
    el.ontouchmove = e => {
        if(!active) return;
        const dy = e.touches[0].clientY - sy; finalDist = Math.abs(dy);
        
        if(!isLocked) {
            if(dy < 0) return; // Ignore early upswipes
            queText.style.transform = `translateY(-${Math.min(finalDist / 96, 1) * 280}px)`;
            if(finalDist >= 96) {
                isLocked = true; latencyMS = Date.now() - questionStartTime;
                drawer.classList.add('active'); el.classList.add('study-active');
            }
        } else {
            if(dy < 0) {
                el.style.transform = `translate3d(0, ${dy}px, 0)`;
                label.style.display = 'flex'; label.style.opacity = Math.min(finalDist / 40, 1);
            }
        }
    };

    el.ontouchend = () => {
        if(!active) return; active = false;
        if(!isLocked) {
            queText.style.transition = "transform .3s ease"; queText.style.transform = "translateY(0)";
        } else if(finalDist >= 32 && dy_at_end < 0) {
             // Logic simplified for final submit
        } else { el.style.transform = "translate(0,0)"; }
    };
}

// Adjusted bindPhysics ending for cleaner submit
bindPhysics = function(el, qData) {
    let sy=0, active=false, finalDist=0, curDy=0;
    const drawer = document.getElementById('study-drawer');
    const label = document.getElementById('sl-up');
    const queText = el.querySelector('.card-q');

    el.ontouchstart = e => { if(isTransitioning) return; active=true; sy=e.touches[0].clientY; };
    el.ontouchmove = e => {
        if(!active) return; curDy = e.touches[0].clientY - sy; finalDist = Math.abs(curDy);
        if(!isLocked) {
            if(curDy < 0) return;
            queText.style.transform = `translateY(-${Math.min(finalDist / 96, 1) * 280}px)`;
            if(finalDist >= 96) { isLocked = true; latencyMS = Date.now() - questionStartTime; drawer.classList.add('active'); el.classList.add('study-active'); }
        } else if(curDy < 0) { el.style.transform = `translate3d(0, ${curDy}px, 0)`; label.style.display = 'flex'; label.style.opacity = Math.min(finalDist / 40, 1); }
    };
    el.ontouchend = () => {
        if(!active) return; active = false;
        if(!isLocked) { queText.style.transition = "transform .3s"; queText.style.transform = "translateY(0)"; }
        else if(curDy < -32) {
            isTransitioning = true; submitToMatrix(qData);
            el.style.transition = "transform .4s ease-in"; el.style.transform = "translate3d(0, -800px, 0)";
            setTimeout(() => { isTransitioning = false; POOL.shift(); renderNext(); }, 400);
        } else { el.style.transition = "transform .3s"; el.style.transform = "translate(0,0)"; }
        label.style.display = 'none';
    };
}

async function submitToMatrix(qData) {
    const params = new URLSearchParams();
    params.append("Question", qData.q);
    params.append("Topic", qData.topic);
    params.append("Correct", "TRUE");
    params.append("XP_Earned", 15);
    params.append("ConfidenceStatus", "Low");
    params.append("DecisionPath", "DRAWER");
    params.append("LuminousLatency", latencyMS);
    params.append("DifficultyLevel", qData.difficulty);
    params.append("TotalTimeTaken", Date.now() - questionStartTime);

    console.log("ALCHEMIST: Sending Data...");
    fetch(DEPLOY_URL, { method: 'POST', mode: 'no-cors', body: params.toString() });
}

window.onload = init;
</script>
</body>
</html>
