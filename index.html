<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist Mastery V75.9</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color: #000;
    --card-bg: #111;
    --overlay-bg: #0d0d0d;
    --accent-gold: #ffd600;
    --font-chem: 'Crimson Text', serif;
    --font-ui: 'Inter', sans-serif;
    --font-code: 'JetBrains Mono', monospace;
    --safe-top: env(safe-area-inset-top);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

body {
    margin: 0; height: 100vh; background: var(--bg-color); color: #fff;
    font-family: var(--font-ui); overflow: hidden;
    user-select: none; -webkit-user-select: none; touch-action: none;
}

/* Chemical Notation Helpers */
sub { font-size: 0.7em; vertical-align: sub; line-height: 0; }
sup { font-size: 0.7em; vertical-align: super; line-height: 0; }

/* Dashboard Header */
#header { width: 90%; margin: calc(20px + var(--safe-top)) auto 0; z-index: 100; pointer-events: none; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--font-code); font-size: 0.75rem; color: #777; margin-bottom: 8px; }
.progress-track { width: 100%; height: 3px; background: #222; border-radius: 2px; overflow: hidden; }
#progress-bar { height: 100%; background: var(--accent-gold); width: 0%; transition: width 0.4s cubic-bezier(0.1, 0.5, 0.5, 1); }

/* Card Stack */
#stack {
    position: relative; width: 92%; max-width: 420px;
    height: calc(100vh - 160px - var(--safe-top));
    margin: 25px auto 0; perspective: 1200px;
}

.card {
    position: absolute; width: 100%; height: 100%;
    background: var(--card-bg); border-radius: 44px; border: 1px solid #2a2a2a;
    padding: 40px; display: flex; flex-direction: column; justify-content: center;
    box-shadow: 0 30px 80px rgba(0,0,0,0.8);
    transform-origin: center center; will-change: transform; cursor: grab;
    backface-visibility: hidden; transform: translate3d(0,0,0);
}

.card-q { 
    font-family: var(--font-chem); font-size: 1.9rem; line-height: 1.35; 
    font-style: italic; font-weight: 600; text-align: center; color: #fdfdfd; 
}

/* Quadrant Labels */
.swipe-label {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    background: #000; color: #fff; font-weight: 900; font-size: 2rem;
    text-transform: uppercase; border-radius: 44px; z-index: 999; 
    opacity: 0; pointer-events: none; text-align: center; padding: 25px;
    transform: scale(0.9); will-change: opacity, transform;
}

/* Golden Hint Logic - V75.9 Upgrade */
.sl-down { 
    color: var(--accent-gold) !important; 
    font-size: 1.6rem; 
    text-transform: none; 
    font-family: var(--font-chem); 
    line-height: 1.4;
    border: 2px solid var(--accent-gold);
}

/* Deep Dive Overlay */
.overlay {
    position: absolute; inset: 0; background: var(--overlay-bg);
    z-index: 1100; padding: 50px 35px; opacity: 0; pointer-events: none;
    border-radius: 44px; transition: all 0.3s ease;
    display: flex; flex-direction: column; justify-content: center;
    transform: translateY(20px);
}
.overlay.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
.overlay-label { font-size: 0.8rem; color: var(--accent-gold); font-family: var(--font-code); margin-bottom: 12px; letter-spacing: 2px; }
.overlay-body { font-size: 1.2rem; line-height: 1.6; color: #bbb; margin-bottom: 35px; font-family: var(--font-chem); }

.btn { 
    width: 100%; padding: 20px; border-radius: 50px; border: none; 
    background: #fff; color: #000; font-weight: 900; cursor: pointer; 
    text-transform: uppercase; letter-spacing: 1px;
}

#loader { 
    position: fixed; inset: 0; background: #000; z-index: 9999; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    font-family: var(--font-code); font-size: 0.8rem; color: var(--accent-gold);
}
</style>
</head>

<body>
<div id="loader">INITIALIZING ALCHEMIST V75.9...</div>

<div id="header">
    <div class="header-meta">
        <span id="rank-ui">RANK: NOVICE</span>
        <span id="xp-ui">0 XP</span>
    </div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
/**
 * V75.9 CORE ENGINE
 */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwnbpsFpWRjONnt1G9G74BW2QeTrATkiyMTlW3IdIcBYZq51XlJuf3Y-Sm1Ei94Nckd/exec";

let RAW_DATA = [], POOL = [], MISTAKES = [], SCORE = 0, isTransitioning = false;
let MODE = "DATASET_SELECT", CURRENT_DATASET = "", CURRENT_TOPIC = "", CURRENT_GENRE = "";

/**
 * Auto-formats subscripts and superscripts for chemistry
 */
const formatChem = t => {
    if (!t) return "";
    return t.toString()
        .replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub>$2</sub>')
        .replace(/(\d*)([+\-])/g, '<sup>$1$2</sup>')
        .replace(/\|\|/g, '<br><br>');
};

async function init() {
    const l = document.getElementById('loader');
    try {
        const r = await fetch(ENDPOINT);
        const data = await r.json();
        RAW_DATA = data;
        l.remove();
        renderDatasetSelect();
    } catch (e) {
        l.innerHTML = "CONNECTION FAILED.<br>CHECK DEPLOYMENT ID.";
        console.error(e);
    }
}

/**
 * Navigation Handlers
 */
function renderDatasetSelect() {
    MODE = "DATASET_SELECT";
    const s = document.getElementById('stack'); s.innerHTML = "";
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">SELECT CHAPTER</div>
        <div class="swipe-label sl-up">CORE (SET A)</div><div class="swipe-label sl-left">INDUSTRIAL (SET B)</div>
        <div class="swipe-label sl-right">REVISION (SET C)</div><div class="swipe-label sl-down">EXPERT (SET D)</div>`;
    s.appendChild(c); bindPhysics(c);
}

function renderTopicSelect(dataset) {
    MODE = "TOPIC_SELECT"; CURRENT_DATASET = dataset;
    const s = document.getElementById('stack'); s.innerHTML = "";
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">DOMAIN SELECTION</div>
        <div class="swipe-label sl-up">PHYSICAL</div><div class="swipe-label sl-left">ORGANIC</div>
        <div class="swipe-label sl-right">INORGANIC</div><div class="swipe-label sl-down">ANALYTICAL</div>`;
    s.appendChild(c); bindPhysics(c);
}

function renderGenreSelect(topic) {
    MODE = "GENRE_SELECT"; CURRENT_TOPIC = topic;
    const s = document.getElementById('stack'); s.innerHTML = "";
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">CHOOSE DEPTH</div>
        <div class="swipe-label sl-up">CONCEPT</div><div class="swipe-label sl-down">APPLICATION</div>`;
    s.appendChild(c); bindPhysics(c);
}

function startQuiz(topic, genre) {
    CURRENT_GENRE = genre;
    POOL = RAW_DATA.filter(q => {
        return q.dataset.toUpperCase() === CURRENT_DATASET.toUpperCase() &&
               q.topic.toLowerCase() === topic.toLowerCase() &&
               q.q_type.toUpperCase() === genre.toUpperCase();
    }).sort(() => Math.random() - 0.5);
    
    if (!POOL.length) {
        alert("No questions found for this selection.");
        renderDatasetSelect();
        return;
    }
    renderNext();
}

function renderNext() {
    const s = document.getElementById('stack'); s.innerHTML = "";
    if (!POOL.length) { renderEnd(); return; }
    
    MODE = "QUIZ";
    const q = POOL.shift();
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `
        <div class="card-q">${formatChem(q.question_text)}</div>
        <div class="swipe-label sl-up">${q.swipe_up_label}</div>
        <div class="swipe-label sl-left">${q.swipe_left_label}</div>
        <div class="swipe-label sl-right">${q.swipe_right_label}</div>
        <div class="swipe-label sl-down">${formatChem(q.hint)}</div>
        <div class="overlay">
            <div class="overlay-label">ALCHEMY REPORT</div>
            <div class="overlay-body">${formatChem(q.explanation)}</div>
            <button class="btn" onclick="this.parentElement.classList.remove('active')">DISMISS</button>
        </div>`;
    s.appendChild(c); bindPhysics(c, q);
}

function renderEnd() {
    MODE = "SESSION_END";
    const s = document.getElementById('stack'); s.innerHTML = "";
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">MASTERY COMPLETE<br><small>${SCORE} XP EARNED</small></div>
        <div class="swipe-label sl-up">RESTART</div><div class="swipe-label sl-down">NEW CHAPTER</div>`;
    s.appendChild(c); bindPhysics(c);
}

/**
 * Swipe & Physics Engine
 */
function bindPhysics(el, data) {
    let x = 0, y = 0, sx = 0, sy = 0, active = false;
    const labels = {
        up: el.querySelector('.sl-up'),
        dn: el.querySelector('.sl-down'),
        lt: el.querySelector('.sl-left'),
        rt: el.querySelector('.sl-right')
    };

    const start = e => {
        if (isTransitioning || (el.querySelector('.overlay') && el.querySelector('.overlay').classList.contains('active'))) return;
        active = true; const p = e.touches ? e.touches[0] : e;
        sx = p.clientX; sy = p.clientY; el.style.transition = "none";
    };

    const move = e => {
        if (!active) return;
        const p = e.touches ? e.touches[0] : e;
        let dx = p.clientX - sx; let dy = p.clientY - sy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        let angle = Math.atan2(-dy, dx) * (180 / Math.PI);
        if (angle < 0) angle += 360;
        
        x = dx; y = dy;

        requestAnimationFrame(() => {
            el.style.transform = `translate3d(${x}px,${y}px,0) rotate(${x/20}deg)`;
            Object.values(labels).forEach(l => { if(l) l.style.opacity = 0; });
            
            if (dist > 10) {
                let activeLabel;
                if (angle >= 45 && angle < 135) activeLabel = labels.up;
                else if (angle >= 135 && angle < 225) activeLabel = labels.lt;
                else if (angle >= 225 && angle < 315) activeLabel = labels.dn;
                else activeLabel = labels.rt;
                
                if (activeLabel) activeLabel.style.opacity = Math.min(dist / 50, 1);
            }
        });
    };

    const end = () => {
        if (!active) return; active = false;
        const dist = Math.sqrt(x*x + y*y);
        let angle = Math.atan2(-y, x) * (180 / Math.PI);
        if (angle < 0) angle += 360;

        if (dist >= 80) {
            let dir = (angle >= 45 && angle < 135) ? "UP" : 
                      (angle >= 135 && angle < 225) ? "LEFT" : 
                      (angle >= 225 && angle < 315) ? "DOWN" : "RIGHT";

            if (MODE === "QUIZ" && dir === "DOWN") {
                el.querySelector('.overlay').classList.add('active');
                el.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                el.style.transform = "translate3d(0,0,0) rotate(0deg)";
            } else {
                handleAction(el, data, x, y, dir);
            }
        } else {
            el.style.transition = "transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            el.style.transform = "translate3d(0,0,0) rotate(0deg)";
        }
    };

    el.onmousedown = start; window.onmousemove = move; window.onmouseup = end;
    el.ontouchstart = start; el.ontouchmove = move; el.ontouchend = end;
}

function handleAction(el, data, x, y, dir) {
    isTransitioning = true;
    
    if (MODE === "DATASET_SELECT") {
        const map = { UP: "SET_A", LEFT: "SET_B", RIGHT: "SET_C", DOWN: "SET_D" };
        renderTopicSelect(map[dir]);
    } else if (MODE === "TOPIC_SELECT") {
        const map = { UP: "Physical", LEFT: "Organic", RIGHT: "Inorganic", DOWN: "Analytical" };
        renderGenreSelect(map[dir]);
    } else if (MODE === "GENRE_SELECT") {
        startQuiz(CURRENT_TOPIC, (dir === "UP" ? "CONCEPT" : "APPLICATION"));
    } else if (MODE === "QUIZ") {
        const weight = parseInt(data.weight) || 1;
        if (dir === data.correct.toUpperCase()) {
            SCORE += (10 * weight);
        } else {
            SCORE = Math.max(0, SCORE - 5);
            MISTAKES.push(data);
        }
        renderNext();
    } else if (MODE === "SESSION_END") {
        if (dir === "UP") startQuiz(CURRENT_TOPIC, CURRENT_GENRE);
        else renderDatasetSelect();
    }

    el.style.transition = "transform 0.5s ease-in";
    el.style.transform = `translate3d(${x * 5}px, ${y * 5}px, 0) rotate(${x/10}deg)`;
    updateUI();
    setTimeout(() => { el.remove(); isTransitioning = false; }, 400);
}

function updateUI() {
    const xpUi = document.getElementById('xp-ui');
    const rankUi = document.getElementById('rank-ui');
    const prog = document.getElementById('progress-bar');
    
    xpUi.innerText = `${SCORE} XP`;
    prog.style.width = `${(SCORE % 100)}%`;
    
    if (SCORE > 1000) rankUi.innerText = "RANK: GRAND ALCHEMIST";
    else if (SCORE > 500) rankUi.innerText = "RANK: SCHOLAR";
    else rankUi.innerText = "RANK: NOVICE";
}

window.onload = init;
</script>
</body>
</html>
