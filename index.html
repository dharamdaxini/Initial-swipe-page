<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chemistry Master V66.1 (Stable)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Roboto+Slab:wght@700&family=Crimson+Text:ital,wght@0,600;1,600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1a1a1a;
            --info-bg: #0d0d0d; 
            --text-main: #ffffff;
            --accent-blue: #2962ff;
            --accent-gold: #ffd600;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --font-chem: 'Crimson Text', serif; 
            --font-num: 'Roboto Slab', serif; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-ui); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        sub { vertical-align: sub; font-size: 0.65em; font-family: var(--font-num); line-height: 0; }
        sup { vertical-align: super; font-size: 0.65em; font-family: var(--font-num); line-height: 0; }
        .chem-bond { font-family: var(--font-ui); font-weight: 400; padding: 0 2px; color: #aaa; }

        #header { position: absolute; top: 20px; width: 90%; display: flex; flex-direction: column; z-index: 100; pointer-events: none; }
        .header-top { display: flex; justify-content: space-between; font-family: var(--font-code); font-size: 0.75rem; color: #888; margin-bottom: 8px; }
        #rank-label { color: var(--accent-gold); font-weight: 800; letter-spacing: 1px; }
        #xp-text { color: #fff; font-weight: 700; }

        .progress-container { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: var(--accent-gold); transition: width 0.4s ease; }

        #stack { position: relative; width: 100%; max-width: 360px; height: 60vh; margin-top: 60px; perspective: 1000px; }

        .card { position: absolute; width: 100%; height: 100%; background: var(--card-bg); border-radius: 32px; border: 1px solid #333; padding: 30px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 20px 50px rgba(0,0,0,0.8); will-change: transform; touch-action: none; cursor: grab; }
        .card-q { font-family: var(--font-chem); font-size: 1.8rem; font-weight: 600; line-height: 1.4; color: #efefef; font-style: italic; pointer-events: none; }

        .hint-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 32px; opacity: 0; pointer-events: none; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 2rem; text-align: center; background: rgba(0,0,0,0.92); z-index: 10; color: #fff; font-family: var(--font-ui); text-transform: uppercase; padding: 20px; }

        .info-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--info-bg); padding: 40px 25px; display: flex; flex-direction: column; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 20; }
        .info-overlay.active { opacity: 1; pointer-events: auto; }
        .info-text { font-family: var(--font-chem); font-size: 1.25rem; line-height: 1.5; color: #ddd; overflow-y: auto; max-height: 70%; }

        .btn-next { background: #fff; color: #000; border: none; padding: 18px; border-radius: 50px; font-weight: 800; font-family: var(--font-ui); width: 100%; margin-top: 20px; cursor: pointer; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    
    <div id="header">
        <div class="header-top">
            <span id="rank-label">RANK: NOVICE</span>
            <span id="xp-text">LV. 1 | 0 XP</span>
        </div>
        <div class="progress-container"><div id="progress-bar"></div></div>
    </div>

    <div id="stack"></div>

    <script>
        const DATA_ENDPOINT = "https://script.google.com/macros/s/AKfycbwrdBKhMeHPpkbZOd_zwFNY5A7FxWji2t11eNnMqXpcAptMAyPewImMG-7O6Ja-ad6Q/exec"; 
        let SCORE = 0, QUESTION_POOL = [], MISTAKE_POOL = [], APP_MODE = 'QUIZ';

        function updateLevelUI() {
            const level = Math.floor(SCORE / 100) + 1;
            const xpInLevel = SCORE % 100;
            const progress = Math.max(0, Math.min(100, xpInLevel));
            
            let rank = "NOVICE";
            if (level >= 10) rank = "MASTER";
            else if (level >= 6) rank = "SPECIALIST";
            else if (level >= 3) rank = "ALCHEMIST";

            document.getElementById('xp-text').innerText = `LV. ${level} | ${SCORE} XP`;
            document.getElementById('rank-label').innerText = `RANK: ${rank}`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function formatChem(text) {
            if (!text) return "";
            text = text.replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub>$2</sub>');
            text = text.replace(/(\d+)([+\-])/g, '<sup>$1$2</sup>');
            text = text.replace(/([A-Za-z\)\]])([+\-])(?=\s|$|[.,;\]\|])/g, '$1<sup>$2</sup>');
            text = text.replace(/(\s)-(\s|(?=[A-Z]))/g, '<span class="chem-bond"> – </span>');
            text = text.replace(/([A-Za-z0-9\)\]<sub>])-(?=[A-Za-z\(])/g, '$1<span class="chem-bond">–</span>');
            text = text.replace(/=/g, '<span class="chem-bond">═</span>');
            text = text.replace(/#/g, '<span class="chem-bond">≡</span>');
            return text;
        }

        async function loadQuestions() {
            try {
                const res = await fetch(DATA_ENDPOINT);
                const all = await res.json();
                QUESTION_POOL = all.filter(q => q.deck === "Chemistry_Master_1").sort(() => Math.random() - 0.5);
                document.getElementById('loader').style.display = 'none';
                updateLevelUI();
                spawnCard();
            } catch (e) { console.error("Link Failed", e); }
        }

        function spawnCard(forcedData = null) {
            const data = forcedData || nextQuestion();
            if(!data) return;
            const el = document.createElement('div');
            el.className = 'card';
            
            let infoLabel = (APP_MODE === 'QUIZ') ? "HINT" : "DEEP DIVE";
            let infoContent = data.explanation;
            if (data.explanation.includes('||')) {
                const parts = data.explanation.split('||');
                infoContent = (APP_MODE === 'QUIZ') ? parts[0].replace(/✅|❌/g, '') : '<ul>' + parts.map(p => `<li>${formatChem(p.trim())}</li>`).join('') + '</ul>';
            }

            el.innerHTML = `
                <div class="card-q">${formatChem(data.text)}</div>
                <div class="hint-overlay hint-up">${formatChem(data.up)}</div>
                <div class="hint-overlay hint-left">${formatChem(data.left)}</div>
                <div class="hint-overlay hint-right">${formatChem(data.right)}</div>
                <div class="hint-overlay hint-down">${formatChem(data.down)}</div>
                <div class="info-overlay">
                    <div style="font-family:var(--font-code); color:var(--accent-blue); margin-bottom:10px">${infoLabel}</div>
                    <div class="info-text">${formatChem(infoContent)}</div>
                    <button class="btn-next" onclick="closeInfo()">GOT IT</button>
                </div>
            `;
            document.getElementById('stack').appendChild(el);
            new Draggable(el, data);
        }

        function nextQuestion() {
            if (QUESTION_POOL.length === 0) return null;
            const q = QUESTION_POOL.shift();
            
            // STABLE LABEL MAPPING
            const labels = (APP_MODE === 'REVIEW') ? 
                { up: "MORE INFO", right: "GOT IT", down: "NEXT", left: "CONFUSED" } :
                { 
                    up: q.swipe_up_label || q.up || "YES", 
                    right: q.swipe_right_label || q.right || "MAYBE", 
                    down: q.swipe_down_label || q.down || "SKIP", 
                    left: q.swipe_left_label || q.left || "NO" 
                };

            return {
                id: q.question_id, 
                text: q.question_text || q.text, 
                explanation: q.explanation || "No explanation provided.",
                ...labels,
                correct: q.correct, 
                w: q.weight
            };
        }

        window.closeInfo = () => {
            const card = document.querySelector('.card');
            card.style.transition = '0.3s ease-in';
            card.style.transform = 'translateY(1000px)';
            setTimeout(() => { card.remove(); spawnCard(); }, 200);
        };

        class Draggable {
            constructor(el, data) {
                this.el = el; this.data = data;
                this.isDragging = false;
                this.el.addEventListener('mousedown', this.start.bind(this));
                window.addEventListener('mousemove', this.move.bind(this));
                window.addEventListener('mouseup', this.end.bind(this));
                this.el.addEventListener('touchstart', this.start.bind(this));
                this.el.addEventListener('touchmove', this.move.bind(this));
                this.el.addEventListener('touchend', this.end.bind(this));
            }

            start(e) {
                if(this.el.querySelector('.info-overlay.active')) return;
                this.isDragging = true;
                const pos = e.touches ? e.touches[0] : e;
                this.startX = pos.clientX; this.startY = pos.clientY;
                this.el.style.transition = 'none';
            }

            move(e) {
                if (!this.isDragging) return;
                const pos = e.touches ? e.touches[0] : e;
                const dx = pos.clientX - this.startX, dy = pos.clientY - this.startY;
                const moveX = Math.abs(dx) > Math.abs(dy) ? Math.max(-120, Math.min(120, dx)) : 0;
                const moveY = Math.abs(dy) > Math.abs(dx) ? Math.max(-120, Math.min(120, dy)) : 0;
                this.el.style.transform = `translate(${moveX}px, ${moveY}px)`;
                this.el.querySelector('.hint-up').style.opacity = moveY < -40 ? 1 : 0;
                this.el.querySelector('.hint-down').style.opacity = moveY > 40 ? 1 : 0;
                this.el.querySelector('.hint-left').style.opacity = moveX < -40 ? 1 : 0;
                this.el.querySelector('.hint-right').style.opacity = moveX > 40 ? 1 : 0;
            }

            end(e) {
                if (!this.isDragging) return;
                this.isDragging = false;
                const endPos = e.changedTouches ? e.changedTouches[0] : (e.clientX ? e : {clientX: this.startX, clientY: this.startY});
                const dx = (endPos.clientX || this.startX) - this.startX;
                const dy = (endPos.clientY || this.startY) - this.startY;

                if (dy > 80) { 
                    this.el.style.transform = 'none'; 
                    this.el.querySelector('.info-overlay').classList.add('active'); 
                }
                else if (Math.abs(dx) > 80 || dy < -80) {
                    const dir = Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? 'RIGHT' : 'LEFT') : 'UP';
                    if (APP_MODE === 'QUIZ') {
                        if (dir === this.data.correct) SCORE += parseInt(this.data.w) || 10;
                        else if (dir !== 'DOWN' && dir !== 'SKIP') SCORE = Math.max(0, SCORE - 5);
                        updateLevelUI();
                    }
                    this.el.style.transition = '0.3s';
                    this.el.style.transform = `translate(${dx * 5}px, ${dy * 5}px)`;
                    setTimeout(() => { this.el.remove(); spawnCard(); }, 200);
                } else {
                    this.el.style.transition = '0.2s';
                    this.el.style.transform = 'none';
                    this.el.querySelectorAll('.hint-overlay').forEach(h => h.style.opacity = 0);
                }
            }
        }
        window.onload = loadQuestions;
    </script>
</body>
</html>
