<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V85.1 Final</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
/* V85.1 CSS - FINAL ENGINE LINK */
:root { 
    --bg-color: #000000; --card-bg: #121212; 
    --accent-gold: #ffcc00; --hint-blue: #4dabf7; --err-red: #ff4d4d;
    --font-ui: 'Outfit', sans-serif; 
    --font-chem: 'Libre Baskerville', serif; 
    --font-code: 'JetBrains Mono', monospace; 
}

/* GLOBAL LAG KILLER */
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { 
    margin: 0; height: 100vh; background: var(--bg-color); color: #fff; 
    font-family: var(--font-ui); overflow: hidden; 
    touch-action: none; /* STOPS BROWSER GESTURES */
    user-select: none; -webkit-user-select: none;
}

#header { width: 90%; margin: calc(20px + env(safe-area-inset-top)) auto 0; pointer-events: none; z-index: 10; position: relative; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--font-code); font-size: 0.75rem; color: #666; margin-bottom: 8px; letter-spacing: 0.5px; }
.progress-track { width: 100%; height: 4px; background: #222; border-radius: 4px; }
#progress-bar { height: 100%; background: var(--accent-gold); width: 0%; transition: width 0.4s ease; box-shadow: 0 0 12px rgba(255, 204, 0, 0.4); }

#stack { position: relative; width: 90%; max-width: 400px; height: calc(100vh - 160px - env(safe-area-inset-top)); margin: 20px auto 0; perspective: 1200px; }

.card { 
    position: absolute; width: 100%; height: 100%; 
    background: var(--card-bg); border-radius: 24px; border: 1px solid #333; 
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    transform-origin: center center; box-shadow: 0 25px 50px rgba(0,0,0,0.95); will-change: transform; 
    padding: 25px; 
    touch-action: none; /* CRITICAL FOR LAG */
}

/* SMART TEXT SIZING */
.card-q { 
    font-family: var(--font-chem); 
    font-size: clamp(1.2rem, 4.5vw, 1.6rem); 
    line-height: 1.5; 
    font-weight: 700; 
    text-align: center; 
    color: #e0e0e0;
    width: 100%;
    word-wrap: break-word; 
}

/* CLEAN SWIPE LABELS */
.swipe-label { 
    position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; 
    background: rgba(0,0,0,0.96); font-family: var(--font-ui); font-weight: 900; font-size: 2rem; 
    text-transform: uppercase; border-radius: 24px; opacity: 0; pointer-events: none; z-index:100; letter-spacing: 2px; text-align:center; padding: 20px;
}
.sl-down-hint { 
    color: var(--hint-blue) !important; font-size: 1.4rem !important; text-transform: none !important; 
    font-family: var(--font-chem) !important; background: rgba(10, 10, 10, 0.98) !important; line-height: 1.6 !important;
}
.hint-icon { font-size: 3rem; margin-bottom: 15px; display: block; }

/* MENU LAYOUT (PREVENTS CUTOFF) */
.menu-container { position: absolute; inset: 0; padding: 20px; pointer-events: none; }
.menu-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; }
.menu-opt { position: absolute; font-family: var(--font-ui); font-weight: 800; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; color: #666; transition: color 0.2s; }

.opt-top { top: 25px; left: 0; right: 0; text-align: center; color: var(--accent-gold); }
.opt-bottom { bottom: 25px; left: 0; right: 0; text-align: center; color: var(--hint-blue); }
.opt-left { top: 50%; left: 25px; transform: translateY(-50%); text-align: left; }
.opt-right { top: 50%; right: 25px; transform: translateY(-50%); text-align: right; }

/* ANALYSIS MODAL */
#analysis-modal { position: absolute; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; padding-top: env(safe-area-inset-top); }
#analysis-modal.active { opacity: 1; pointer-events: auto; }
.analysis-header { padding: 20px; text-align: center; border-bottom: 1px solid #333; font-family: var(--font-ui); color: var(--accent-gold); font-weight: 900; letter-spacing: 2px; }
.analysis-scroll { flex: 1; overflow-y: auto; padding: 20px; }
.mistake-card { background: #111; border: 1px solid #333; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
.mistake-q { font-family: var(--font-chem); font-size: 1.1rem; color: #fff; margin-bottom: 10px; }
.mistake-ans { font-family: var(--font-code); font-size: 0.8rem; color: var(--err-red); margin-bottom: 10px; text-transform: uppercase; }
.mistake-exp { font-family: var(--font-chem); font-size: 0.95rem; color: #aaa; line-height: 1.5; border-top: 1px solid #222; padding-top: 10px; }

/* CONTROLS */
.input-name { width: 100%; padding: 18px; border-radius: 16px; border: 1px solid #444; background: #1a1a1a; color: #fff; font-family: var(--font-ui); font-size: 1.1rem; margin-bottom: 15px; text-align: center; outline: none; }
.input-name:focus { border-color: var(--accent-gold); }
.btn { width: 100%; padding: 20px; border-radius: 100px; border: none; background: #fff; color: #000; font-weight: 800; cursor: pointer; text-transform: uppercase; font-family: var(--font-ui); letter-spacing: 1px; margin-top: 10px; font-size: 0.9rem; }
.btn-save { background: var(--accent-gold); color: #000; box-shadow: 0 5px 20px rgba(255, 204, 0, 0.2); }
.btn-review { background: #333; color: #fff; border: 1px solid #555; }
.btn-close { background: transparent; color: #fff; border: 1px solid #333; margin: 20px; width: calc(100% - 40px); }

#loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; font-family: var(--font-ui); font-weight: 900; font-size: 1.5rem; letter-spacing: 4px; color: var(--accent-gold); flex-direction: column; }
#data-source { margin-top: 10px; font-size: 0.7rem; font-family: var(--font-code); color: #444; }
</style>
</head>

<body>
<div id="loader">ALCHEMIST<br><div id="data-source">CONNECTING...</div></div>

<div id="analysis-modal">
    <div class="analysis-header">SESSION ANALYSIS</div>
    <div class="analysis-scroll" id="analysis-content"></div>
    <button class="btn btn-close" onclick="document.getElementById('analysis-modal').classList.remove('active')">CLOSE</button>
</div>

<div id="header">
    <div class="header-meta"><span id="rank-ui">RANK: NOVICE</span><span id="xp-ui">0 XP</span></div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
// =========================================================
// ‚úÖ NEW ENGINE URL (UPDATED V85.1)
// =========================================================
const ENDPOINT = "https://script.google.com/macros/s/AKfycby_TgVH_qSlR6bKnnUTueTB6D_Upjf5Wm3bxF11DBkU2_F4Q8ALbZkhAIqiwiY-J7Sj0w/exec";

// FALLBACK DATA
const BACKUP_DATA = [{ "dataset": "SET_A", "topic": "Physical", "q_type": "CONCEPT", "question_text": "What does a negative ŒîG value signify?", "hint": "Thermodynamic direction.", "explanation": "‚úÖ Spontaneous reaction.", "swipe_up_label": "Spontaneous", "swipe_right_label": "Equilibrium", "swipe_down_label": "HINT", "swipe_left_label": "Non-spontaneous", "correct": "UP", "weight": 1 }];

let RAW_DATA = [...BACKUP_DATA], POOL=[], MISTAKES=[], SCORE=0, isTransitioning=false;
let MODE="DATASET_SELECT", CURRENT_DATASET="", CURRENT_TOPIC="", CURRENT_GENRE="";
const CLAMP_DIST = 32; const OPACITY_DIST = 24; 
const formatChem = t => { if(!t) return ""; return t.toString().replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>').replace(/(\d*)([+\-])/g, '<sup>$1$2</sup>').replace(/\|\|/g, '<br><br>'); };

async function init(){
    const l = document.getElementById('loader');
    const status = document.getElementById('data-source');
    try {
        const r = await fetch(ENDPOINT);
        const json = await r.json();
        if(Array.isArray(json) && json.length > 0) {
            RAW_DATA = json; 
            status.innerText = `ENGINE CONNECTED: ${json.length} CARDS`; status.style.color = "#00ff00";
        } else {
            status.innerText = "ENGINE EMPTY"; status.style.color = "red";
        }
    } catch(e) { status.innerText = "OFFLINE MODE"; status.style.color = "orange"; }

    setTimeout(() => { l.remove(); renderDatasetSelect(); }, 1500);
}

// --- ROBUST FILTERING ---
function attemptAutoStart(topic, genre){
    const cleanDataset = (CURRENT_DATASET||"").trim().toLowerCase();
    const cleanTopic = (topic||"").trim().toLowerCase();
    
    // 1. Try Exact Match
    POOL = RAW_DATA.filter(q => {
        const d = (q.dataset||"").trim().toLowerCase();
        const t = (q.topic||"").trim().toLowerCase();
        return d === cleanDataset && t === cleanTopic;
    }).sort(() => Math.random() - .5);

    // 2. Fallback: Dataset Only
    if(POOL.length === 0) {
        console.log("Fallback: Loading entire dataset");
        POOL = RAW_DATA.filter(q => (q.dataset||"").trim().toLowerCase() === cleanDataset).sort(() => Math.random() - .5);
    }

    // 3. Final Fallback: All Questions
    if(POOL.length === 0) {
        console.log("Emergency fallback");
        POOL = [...RAW_DATA].sort(() => Math.random() - .5);
    }

    if(POOL.length > 0) { 
        CURRENT_TOPIC = topic; CURRENT_GENRE = genre; renderNext(); return true; 
    } else {
        renderDatasetSelect(); 
        return false;
    }
}

// --- VISUAL MENU SYSTEM ---

function renderDatasetSelect(){
    MODE="DATASET_SELECT"; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`
        <div class="menu-container">
            <div class="opt-top menu-opt">‚¨ÜÔ∏è CORE</div>
            <div class="opt-left menu-opt">‚¨ÖÔ∏è APPS</div>
            <div class="menu-center"><div class="card-q" style="margin:0">SELECT<br>CURRICULUM</div></div>
            <div class="opt-right menu-opt">REVISE ‚û°Ô∏è</div>
            <div class="opt-bottom menu-opt">‚¨áÔ∏è EXPERT</div>
        </div>
        <div class="swipe-label sl-up">CORE CHEMISTRY</div><div class="swipe-label sl-left">INDUSTRIAL</div>
        <div class="swipe-label sl-right">REVISION</div><div class="swipe-label sl-down">EXPERT</div>
    `;
    s.appendChild(c); bindPhysics(c);
}

function renderTopicSelect(dataset){
    MODE="TOPIC_SELECT"; CURRENT_DATASET=dataset; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`
        <div class="menu-container">
            <div class="opt-top menu-opt">‚¨ÜÔ∏è PHYS</div>
            <div class="opt-left menu-opt">‚¨ÖÔ∏è ORG</div>
            <div class="menu-center"><div class="card-q" style="margin:0">CHOOSE<br>DOMAIN</div></div>
            <div class="opt-right menu-opt">INORG ‚û°Ô∏è</div>
            <div class="opt-bottom menu-opt">‚¨áÔ∏è ANALYT</div>
        </div>
        <div class="swipe-label sl-up">PHYSICAL</div><div class="swipe-label sl-left">ORGANIC</div>
        <div class="swipe-label sl-right">INORGANIC</div><div class="swipe-label sl-down">ANALYTICAL</div>
    `;
    s.appendChild(c); bindPhysics(c);
}

function renderGenreSelect(topic){
    MODE="GENRE_SELECT"; CURRENT_TOPIC=topic; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`
        <div class="menu-container">
            <div class="opt-top menu-opt">‚¨ÜÔ∏è CONCEPTS</div>
            <div class="menu-center"><div class="card-q" style="margin:0">SELECT<br>DEPTH</div></div>
            <div class="opt-bottom menu-opt">‚¨áÔ∏è APPLIED</div>
        </div>
        <div class="swipe-label sl-up">CONCEPTS</div>
        <div class="swipe-label sl-down">APPLIED</div>
    `;
    s.appendChild(c); bindPhysics(c);
}

function startQuiz(topic, genre){
    attemptAutoStart(topic, genre);
}

function renderNext(){
    const s=document.getElementById('stack'); s.innerHTML="";
    if(!POOL.length){ renderEnd(); return; }
    MODE="QUIZ"; const q = POOL.shift();
    const c=document.createElement('div'); c.className="card";
    
    // HINT FIX: Emoji is now separate DIV for centering
    c.innerHTML=`
        <div class="card-q">${formatChem(q.question_text)}</div>
        <div class="swipe-label sl-up">${q.swipe_up_label}</div>
        <div class="swipe-label sl-left">${q.swipe_left_label}</div>
        <div class="swipe-label sl-right">${q.swipe_right_label}</div>
        <div class="swipe-label sl-down sl-down-hint">
            <div class="hint-icon">üí°</div>
            ${formatChem(q.hint)}
        </div>
    `;
    s.appendChild(c); bindPhysics(c, q);
}

function renderEnd(){
    MODE="SESSION_END"; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`
        <div class="card-q" style="font-size:1.5rem">SESSION COMPLETE<br><span style="color:var(--accent-gold); font-size:3rem">${SCORE} XP</span></div>
        <div style="width:100%; margin-top:20px; z-index:100; position:relative;">
            <button class="btn btn-review" onclick="renderAnalysis()">REVIEW MISTAKES</button>
            <input type="text" id="student-name" class="input-name" placeholder="ENTER YOUR NAME" style="margin-top:15px;">
            <button class="btn btn-save" onclick="submitData()">UPLOAD RESULTS</button>
            <div id="status-msg"></div>
            <button class="btn" style="background:transparent; border:1px solid #333; color:#666; margin-top:15px; padding:15px; font-size:0.8rem;" onclick="location.reload()">RESTART APP</button>
        </div>`;
    s.appendChild(c);
}

function renderAnalysis() {
  const container = document.getElementById('analysis-content');
  container.innerHTML = "";
  if(MISTAKES.length === 0) {
     container.innerHTML = "<div style='padding:20px; text-align:center; color:#666;'>PERFECT SCORE!</div>";
  } else {
     MISTAKES.forEach((q) => {
        let expText = q.explanation ? formatChem(q.explanation) : "No explanation provided.";
        let html = `
        <div class="mistake-card">
           <div class="mistake-q">Q: ${formatChem(q.question_text)}</div>
           <div class="mistake-ans">Correct Answer: ${q.correct}</div>
           <div class="mistake-exp">üìù ${expText}</div>
        </div>`;
        container.innerHTML += html;
     });
  }
  document.getElementById('analysis-modal').classList.add('active');
}

async function submitData(){
    const name = document.getElementById('student-name').value;
    const btn = document.querySelector('.btn-save');
    const msg = document.getElementById('status-msg');
    
    if(!name) { msg.innerText = "Please enter a name first."; msg.style.color="red"; return; }
    
    btn.innerText = "UPLOADING...";
    btn.disabled = true;

    const payload = {
        name: name,
        score: SCORE,
        topic: CURRENT_TOPIC,
        mode: CURRENT_GENRE,
        total: SCORE + MISTAKES.length,
        mistakes: MISTAKES.map(m => m.question_text).join(" | ")
    };

    try {
        await fetch(ENDPOINT, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        msg.innerText = "SUCCESS! DATA SAVED.";
        msg.style.color = "#00ff00";
        btn.innerText = "SAVED";
    } catch(e) {
        msg.innerText = "UPLOAD FAILED. CHECK INTERNET.";
        msg.style.color = "red";
        btn.disabled = false;
        btn.innerText = "RETRY";
    }
}

function bindPhysics(el, data){
    let x=0, y=0, sx=0, sy=0, active=false, triggerDir=null;
    const labels={up:el.querySelector('.sl-up'), dn:el.querySelector('.sl-down'), lt:el.querySelector('.sl-left'), rt:el.querySelector('.sl-right')};
    
    const start=e=>{ if(isTransitioning) return; active=true; const p=e.touches?e.touches[0]:e; sx=p.clientX; sy=p.clientY; el.style.transition="none"; };
    
    const move=e=>{
        if(!active)return; 
        const p=e.touches?e.touches[0]:e;
        const rawDx = p.clientX - sx; const rawDy = p.clientY - sy; const rawDist = Math.sqrt(rawDx*rawDx + rawDy*rawDy);
        const opacity = Math.min(rawDist / OPACITY_DIST, 1);
        let clampedDx = rawDx, clampedDy = rawDy;
        if(rawDist > CLAMP_DIST){ const ratio = CLAMP_DIST / rawDist; clampedDx = rawDx * ratio; clampedDy = rawDy * ratio; }
        let ang = Math.atan2(-clampedDy, clampedDx)*(180/Math.PI); if(ang<0) ang+=360;
        let activeLabel = null; Object.values(labels).forEach(l=>{if(l)l.style.opacity=0;});
        if(rawDist > 5){
            if(ang>=45&&ang<135) activeLabel=labels.up; else if(ang>=135&&ang<225) activeLabel=labels.lt;
            else if(ang>=225&&ang<315) activeLabel=labels.dn; else activeLabel=labels.rt;
        }
        if(activeLabel){ activeLabel.style.opacity = opacity; activeLabel.style.transform = `scale(${0.85 + (opacity * 0.15)})`; }
        x = clampedDx; y = clampedDy; requestAnimationFrame(()=>{ el.style.transform=`translate3d(${x}px,${y}px,0) rotate(${x/25}deg)`; });
        if(rawDist >= CLAMP_DIST) triggerDir = (ang>=45&&ang<135)?"UP":(ang>=135&&ang<225)?"LEFT":(ang>=225&&ang<315)?"DOWN":"RIGHT"; else triggerDir = null;
    };
    
    const end=()=>{
        if(!active)return; active=false;
        if(triggerDir){
            if(MODE==="QUIZ" && triggerDir==="DOWN"){ 
                el.style.transition="transform .3s"; 
                el.style.transform="translate3d(0,0,0) rotate(0deg)"; 
            }
            else {
                handleAction(el, data, x, y, triggerDir);
            }
        } else { el.style.transition="transform .2s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; el.style.transform="translate3d(0,0,0) rotate(0deg)"; }
        Object.values(labels).forEach(l=>{if(l)l.style.opacity=0;});
    };
    
    el.onmousedown=start; window.onmousemove=move; window.onmouseup=end; el.ontouchstart=start; 
    el.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, { passive: false });
    el.ontouchend=end;
}

function handleAction(el, data, x, y, dir){
    isTransitioning=true;
    if(MODE==="QUIZ"){ 
        const w=parseInt(data.weight)||1; 
        if(dir===data.correct.toUpperCase()){ 
            SCORE+=(10*w); 
        } 
        else { 
            SCORE=Math.max(0, SCORE-5); MISTAKES.push(data); 
        }
        renderNext();
    }
    else if(MODE==="DATASET_SELECT"){ const map={UP:"SET_A", LEFT:"SET_B", RIGHT:"SET_C", DOWN:"SET_D"}; renderTopicSelect(map[dir]); }
    else if(MODE==="TOPIC_SELECT"){ const map={UP:"Physical", LEFT:"Organic", RIGHT:"Inorganic", DOWN:"Analytical"}; renderGenreSelect(map[dir]); }
    else if(MODE==="GENRE_SELECT"){ 
        if(dir==="UP") startQuiz(CURRENT_TOPIC, "CONCEPT"); 
        else if(dir==="DOWN") startQuiz(CURRENT_TOPIC, "APPLICATION"); 
        else { isTransitioning=false; return; }
    }
    else if(MODE==="SESSION_END"){ 
        if(dir==="UP") location.reload();
    }
    el.style.transition="transform .4s ease-in"; 
    el.style.transform=`translate3d(${x*6}px,${y*6}px,0) rotate(${x/5}deg)`;
    updateUI(); 
    setTimeout(()=>{el.remove(); isTransitioning=false;}, 350);
}
function updateUI(){ document.getElementById('xp-ui').innerText=`${SCORE} XP`; document.getElementById('progress-bar').style.width=`${(SCORE%100)}%`; }
window.onload=init;
</script>
</body>
</html>
