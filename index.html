<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strategic Convergence 2026</title>
    <style>
        :root {
            --color-bg: #f4f4f5;
            --color-card: #ffffff;
            --color-text: #18181b;
            --color-subtext: #71717a;
            --color-up: #22c55e;
            --color-down: #ef4444;
            --color-right: #eab308;
            --color-left: #64748b;
            --shadow-card: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--color-bg);
            color: var(--color-text);
            height: 100svh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            position: fixed;
        }

        /* --- APP CONTAINER --- */
        #app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* --- CARD STACK --- */
        #card-stack {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4;
            max-height: 60svh;
            margin-bottom: 2rem;
        }

        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-card);
            border-radius: 24px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            padding: 2rem;
            text-align: center;
            will-change: transform;
            transform: translateZ(0); 
            backface-visibility: hidden;
            justify-content: space-between; /* Push content apart */
        }

        /* --- CARD HEADER --- */
        .card-header {
            margin-bottom: 1.5rem;
        }

        .card-topic {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-subtext);
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
        }

        .card-type {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--color-text);
            margin: 0;
        }

        /* --- CARD BODY --- */
        .card-body {
            flex: 1; /* Take available space */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card p {
            font-size: 1.35rem;
            line-height: 1.5;
            font-weight: 500;
            color: var(--color-text);
            pointer-events: none;
            margin: 0;
        }

        /* --- CARD FOOTER (Legend) --- */
        .card-footer {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            grid-template-rows: auto auto;
            gap: 0.75rem;
            margin-top: 1.5rem;
            pointer-events: none;
        }

        .legend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-subtext);
            transition: color 0.2s, transform 0.2s;
        }

        /* Grid Positioning */
        .legend-item.up { grid-column: 2; grid-row: 1; }
        .legend-item.left { grid-column: 1; grid-row: 2; }
        .legend-item.down { grid-column: 2; grid-row: 2; }
        .legend-item.right { grid-column: 3; grid-row: 2; }
        
        .legend-item.active { transform: scale(1.15); }
        .legend-item.up.active { color: var(--color-up); }
        .legend-item.down.active { color: var(--color-down); }
        .legend-item.right.active { color: var(--color-right); }
        .legend-item.left.active { color: var(--color-left); }

        .legend-item .icon { font-size: 1.4rem; margin-bottom: 2px; display: block; line-height: 1; }

        /* Meta info hidden by default, useful for debugging */
        .card .meta { display: none; }

        /* --- RESULTS VIEW --- */
        #summary-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100svh;
            background: var(--color-bg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            touch-action: pan-y;
            overflow-y: auto;
        }

        #summary-view.visible { opacity: 1; pointer-events: auto; }

        .summary-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-box { text-align: center; }
        .stat-num { font-size: 1.5rem; font-weight: 800; display: block; }
        .stat-label { font-size: 0.7rem; color: var(--color-subtext); text-transform: uppercase; }

        #summary-list { margin-bottom: 2rem; }

        .summary-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            border-left: 5px solid transparent;
        }

        .confirmation-zone {
            height: 100px;
            margin-bottom: 2rem;
            position: relative;
        }

        #confirmation-card {
            width: 100%;
            height: 100%;
            background: #1e293b;
            color: white;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
        }

        .confirm-legend {
            display: flex;
            justify-content: space-between;
            width: 80%;
            margin-top: 0.5rem;
            font-size: 0.7rem;
            opacity: 0.6;
            text-transform: uppercase;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <main id="app-container">
        <div id="card-stack" aria-live="polite"></div>
    </main>

    <section id="summary-view" class="hidden">
        <h2 style="font-size:1.2rem; margin-bottom:1rem; text-transform:uppercase; color:var(--color-subtext);">Results</h2>
        
        <div class="summary-stats">
            <div class="stat-box">
                <span class="stat-num" id="stat-total-score">0</span>
                <span class="stat-label">Total Score</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="stat-accuracy">0%</span>
                <span class="stat-label">Accuracy</span>
            </div>
        </div>

        <div id="summary-list"></div>
        
        <div class="confirmation-zone">
            <div id="confirmation-card">
                <p style="font-weight:600; font-size:1.1rem;">SWIPE TO SUBMIT</p>
                <div class="confirm-legend">
                    <span>← Cancel</span>
                    <span>Confirm →</span>
                </div>
            </div>
        </div>
    </section>

    <script>
        // --- GOOGLE SHEET DEPLOYMENT ID ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz_ziu5Dezrz35J2FksQtNEYuZ5Kk6TrQvg3pM5O5eBYUDzWCCtqlGWwZj8D-TBQLFw/exec";

        // --- QUESTION DATA ---
        const QUESTIONS = [
            {
                question_id: "q1",
                topic: "Strategic",
                q_type: "FACT RECALL",
                active: true,
                question_text: "The Dholera semiconductor facility is fully operational as of Jan 2026.",
                swipe_up_label: "True",
                swipe_right_label: "Unsure",
                swipe_down_label: "False",
                swipe_left_label: "Skip",
                correct_swipe: "up",
                score_up: 10, score_right: 0, score_down: -5, score_left: 0, weight: 1
            },
            {
                question_id: "q2",
                topic: "Logistics",
                q_type: "CONTEXT",
                active: true,
                question_text: "ULIP integration has fully decoupled supply chain efficiency from crude oil volatility.",
                swipe_up_label: "Agree",
                swipe_right_label: "Partial",
                swipe_down_label: "Disagree",
                swipe_left_label: "Skip",
                correct_swipe: "right",
                score_up: -5, score_right: 10, score_down: -5, score_left: 0, weight: 2
            },
            {
                question_id: "q3",
                topic: "Finance",
                q_type: "TRAP",
                active: true,
                question_text: "The Indian Rupee was inducted into the IMF SDR basket in late 2025.",
                swipe_up_label: "True",
                swipe_right_label: "Plausible",
                swipe_down_label: "False",
                swipe_left_label: "Skip",
                correct_swipe: "down",
                score_up: -10, score_right: -5, score_down: 10, score_left: 0, weight: 1
            }
        ];

        const STATE = { IDLE: 'IDLE', DRAGGING: 'DRAGGING', ANIMATING: 'ANIMATING', SUMMARY: 'SUMMARY' };
        
        const APP = {
            currentState: STATE.IDLE,
            deck: [],
            currentIndex: 0,
            answers: {}, 
            activeCard: null,
            startX: 0, startY: 0, 
            threshold: 80,
            timestampStart: new Date().toISOString()
        };

        const stackEl = document.getElementById('card-stack');
        const summaryView = document.getElementById('summary-view');
        const confirmCard = document.getElementById('confirmation-card');

        function init() {
            APP.deck = QUESTIONS.filter(q => q.active === true || q.active === "TRUE");
            renderStack();
        }

        function renderStack() {
            stackEl.innerHTML = '';
            [...APP.deck].reverse().forEach((q, index) => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.style.zIndex = APP.deck.length - index;
                card.dataset.index = index;
                
                // NEW CARD STRUCTURE
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-topic">${q.topic}</span>
                        <h3 class="card-type">${q.q_type}</h3>
                    </div>
                    <div class="card-body">
                        <p>${q.question_text}</p>
                    </div>
                    <div class="card-footer legend">
                        <div class="legend-item up"><span class="icon">↑</span><span class="label">${q.swipe_up_label || 'Up'}</span></div>
                        <div class="legend-item left"><span class="icon">←</span><span class="label">${q.swipe_left_label || 'Left'}</span></div>
                        <div class="legend-item down"><span class="icon">↓</span><span class="label">${q.swipe_down_label || 'Down'}</span></div>
                        <div class="legend-item right"><span class="icon">→</span><span class="label">${q.swipe_right_label || 'Right'}</span></div>
                    </div>
                `;
                stackEl.appendChild(card);
            });
            updateTopCard();
        }

        function updateTopCard() {
            const topCard = stackEl.lastElementChild;
            if (topCard && APP.currentIndex < APP.deck.length) {
                APP.activeCard = topCard;
                bindTouchEvents(topCard);
            } else {
                finishDeck();
            }
        }

        // --- RAW TOUCH EVENT LOGIC ---

        function bindTouchEvents(card) {
            card.addEventListener('touchstart', (e) => {
                if (APP.currentState !== STATE.IDLE) return;
                const touch = e.touches[0];
                APP.startX = touch.clientX;
                APP.startY = touch.clientY;
                APP.currentState = STATE.DRAGGING;
                card.style.transition = 'none';
            }, { passive: false });

            window.addEventListener('touchmove', handleTouchMove, { passive: false });
            window.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchMove(e) {
            if (APP.currentState !== STATE.DRAGGING) return;
            if (e.cancelable) e.preventDefault(); 

            const touch = e.touches[0];
            const deltaX = touch.clientX - APP.startX;
            const deltaY = touch.clientY - APP.startY;
            const rotate = deltaX * 0.05;
            
            APP.activeCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotate}deg)`;
            updateVisualFeedback(deltaX, deltaY);
        }

        function handleTouchEnd(e) {
            if (APP.currentState !== STATE.DRAGGING) return;
            window.removeEventListener('touchmove', handleTouchMove);
            window.removeEventListener('touchend', handleTouchEnd);
            
            const touch = e.changedTouches[0];
            const deltaX = touch.clientX - APP.startX;
            const deltaY = touch.clientY - APP.startY;
            const absX = Math.abs(deltaX);
            const absY = Math.abs(deltaY);

            // Reset legend highlights on the active card
            APP.activeCard.querySelectorAll('.legend-item').forEach(el => el.classList.remove('active'));
            APP.currentState = STATE.ANIMATING;

            let decision = null;
            if (absY > absX && absY > APP.threshold) decision = deltaY < 0 ? 'up' : 'down';
            else if (absX > absY && absX > APP.threshold) decision = deltaX > 0 ? 'right' : 'left';

            decision ? commitSwipe(decision) : resetCard();
        }

        function updateVisualFeedback(dx, dy) {
            const absX = Math.abs(dx), absY = Math.abs(dy);
            let selector = '';
            let color = '';

            if (absY > absX) {
                if (dy < 0) { selector = '.up'; color = 'var(--color-up)'; } 
                else { selector = '.down'; color = 'var(--color-down)'; }
            } else {
                if (dx > 0) { selector = '.right'; color = 'var(--color-right)'; } 
                else { selector = '.left'; color = 'var(--color-left)'; }
            }

            // Highlight Legend within the active card ONLY
            const legendItems = APP.activeCard.querySelectorAll('.legend-item');
            legendItems.forEach(el => el.classList.remove('active'));
            
            const activeLegend = APP.activeCard.querySelector(`.legend-item${selector}`);
            if (activeLegend && (absX > 30 || absY > 30)) activeLegend.classList.add('active');

            const opacity = Math.min((Math.max(absX, absY) / APP.threshold), 1);
            APP.activeCard.style.boxShadow = opacity > 0.1 ? `0 0 30px ${color}` : 'var(--shadow-card)';
        }

        function resetCard() {
            APP.activeCard.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.2s';
            APP.activeCard.style.transform = 'translate(0, 0) rotate(0)';
            APP.activeCard.style.boxShadow = 'var(--shadow-card)';
            setTimeout(() => APP.currentState = STATE.IDLE, 300);
        }

        function commitSwipe(direction) {
            const qData = APP.deck[APP.currentIndex];
            let score = 0;
            if (direction === 'up') score = qData.score_up;
            if (direction === 'down') score = qData.score_down;
            if (direction === 'right') score = qData.score_right;
            if (direction === 'left') score = qData.score_left;

            APP.answers[qData.question_id] = {
                direction: direction,
                raw_score: score,
                weighted_score: score * qData.weight
            };

            let transX = 0, transY = 0;
            if (direction === 'up') transY = -1200;
            if (direction === 'down') transY = 1200;
            if (direction === 'left') transX = -1000;
            if (direction === 'right') transX = 1000;
            
            APP.activeCard.style.transition = 'transform 0.4s ease-in';
            APP.activeCard.style.transform = `translate(${transX}px, ${transY}px) rotate(${transX * 0.05}deg)`;
            
            setTimeout(() => {
                APP.activeCard.remove();
                APP.currentIndex++;
                APP.currentState = STATE.IDLE;
                updateTopCard();
            }, 350);
        }

        function finishDeck() {
            APP.currentState = STATE.SUMMARY;
            document.getElementById('app-container').style.display = 'none';

            let totalScore = 0;
            let correctCount = 0;
            let totalQuestions = APP.deck.length;

            const listHtml = APP.deck.map(q => {
                const ans = APP.answers[q.question_id];
                totalScore += ans.weighted_score;
                if (ans.direction === q.correct_swipe) correctCount++;
                let c = 'var(--color-left)';
                if (ans.direction === 'up') c = 'var(--color-up)';
                if (ans.direction === 'down') c = 'var(--color-down)';
                if (ans.direction === 'right') c = 'var(--color-right)';

                return `<div class="summary-item" style="border-left-color:${c}"><strong>${q.topic}</strong><br>${q.question_text}<br><div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.8rem;"><span style="color:${c};font-weight:700;">${ans.direction.toUpperCase()}</span><span>Score: ${ans.weighted_score}</span></div></div>`;
            }).join('');

            document.getElementById('stat-total-score').textContent = totalScore;
            document.getElementById('stat-accuracy').textContent = Math.round((correctCount / totalQuestions) * 100) + "%";
            document.getElementById('summary-list').innerHTML = listHtml;
            
            summaryView.classList.remove('hidden');
            setTimeout(() => summaryView.classList.add('visible'), 50);
            initConfirmationSwipe();
        }

        function initConfirmationSwipe() {
            let startX = 0;
            confirmCard.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                confirmCard.style.transition = 'none';
            }, { passive: false });

            confirmCard.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const dx = e.touches[0].clientX - startX;
                confirmCard.style.transform = `translateX(${dx}px)`;
                if (dx > 50) confirmCard.style.background = '#22c55e';
                else if (dx < -50) confirmCard.style.background = '#ef4444';
                else confirmCard.style.background = '#1e293b';
            }, { passive: false });

            confirmCard.addEventListener('touchend', (e) => {
                const dx = e.changedTouches[0].clientX - startX;
                if (dx > 100) submitData();
                else if (dx < -100) location.reload();
                else {
                    confirmCard.style.transition = 'transform 0.3s ease, background 0.3s';
                    confirmCard.style.transform = 'translateX(0)';
                    confirmCard.style.background = '#1e293b';
                }
            });
        }

        // --- SUBMISSION LOGIC ---

        function submitData() {
            confirmCard.innerHTML = "<h3>SYNCING...</h3>";
            confirmCard.style.background = "#64748b";
            confirmCard.style.cursor = "wait";

            const payload = {
                session_data: APP.answers,
                total_score: parseInt(document.getElementById('stat-total-score').textContent),
                device: /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                timestamp: new Date().toISOString()
            };

            fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            })
            .then(() => {
                confirmCard.innerHTML = "<h3>SUBMITTED</h3>";
                confirmCard.style.background = "#22c55e";
                confirmCard.style.transform = "translateX(0)";
                const clone = confirmCard.cloneNode(true);
                confirmCard.parentNode.replaceChild(clone, confirmCard);
            })
            .catch(error => {
                console.error("Submission Error:", error);
                confirmCard.innerHTML = "<h3>ERROR</h3>";
                confirmCard.style.background = "#ef4444";
            });
        }

        init();
    </script>
</body>
</html>
