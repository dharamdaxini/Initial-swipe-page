<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V81.24 - Linear Insight</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
<style>
/* --- LOCKED TO V81.4 UI ENGINE --- */
:root { --bg: #000; --card: #111; --gold: #ffd600; --blue: #3498db; --serif: 'Libre Baskerville', serif; --ui: 'Outfit', sans-serif; --code: 'JetBrains Mono', monospace; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; height: 100vh; background: var(--bg); color: #fff; font-family: var(--ui); overflow: hidden; touch-action: none; }

#header { width: 90%; margin: calc(20px + env(safe-area-inset-top)) auto 0; z-index: 100; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--code); font-size: 0.75rem; color: #555; margin-bottom: 8px; }
.progress-track { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; }
#progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.4s ease; }

#stack { position: relative; width: 92%; max-width: 400px; height: calc(100vh - 180px - env(safe-area-inset-top)); margin: 25px auto 0; perspective: 1200px; }
.card { position: absolute; width: 100%; height: 100%; background: var(--card); border-radius: 40px; border: 1px solid #282828; padding: 30px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 20px 60px rgba(0,0,0,0.9); transform-origin: center center; will-change: transform; z-index: 1; }
.card-q { font-family: var(--serif); font-size: clamp(1.2rem, 4.5vw, 1.7rem); line-height: 1.4; font-weight: 700; text-align: center; color: #f0f0f0; pointer-events: none; }

/* RESTRAINED XY PLANE LABELS */
.swipe-label { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); color: #fff; font-weight: 900; font-size: 1.8rem; text-transform: uppercase; border-radius: 40px; z-index: 2000; text-align: center; padding: 20px; will-change: transform, opacity; pointer-events: none; }

/* PROGRESSIVE STUDY LAYOUT */
.sl-dn { flex-direction: column !important; justify-content: flex-start !important; padding-top: 60px; }
.sl-down-emoji { font-size: 5rem; display: block; transition: filter 0.2s; will-change: filter; margin-bottom: 30px; }

/* CONTENT WRAPPER */
.study-content-wrap { width: 100%; padding: 0 10px; opacity: 0; transform: translateY(20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.study-content-wrap.active { opacity: 1; transform: translateY(0); }

.context-block { margin-bottom: 25px; }
.study-header { font-size: 0.7rem; color: var(--gold); font-family: var(--code); margin-bottom: 8px; letter-spacing: 2px; font-weight: 900; }
.study-body { font-size: 1.1rem; line-height: 1.6; color: #ccc; font-family: var(--serif); text-align: center; }

/* OPTION COMPARISON (STAGE 2) */
.comparison-block { margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; display: none; }
.comparison-block.active { display: block; animation: slideUp 0.4s ease forwards; }

@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

#loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; letter-spacing: 4px; color: var(--gold); }
sub { font-size: 0.7em; vertical-align: sub; line-height: 0; }
sup { font-size: 0.7em; vertical-align: super; line-height: 0; }
</style>
</head>
<body>

<div id="loader">ALCHEMIST V81.24</div>
<div id="header">
    <div class="header-meta"><span>RANK: NOVICE</span><span id="xp-ui">0 XP</span></div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
    <div id="sl-up" class="swipe-label">UP</div>
    <div id="sl-lt" class="swipe-label">LEFT</div>
    <div id="sl-rt" class="swipe-label">RIGHT</div>
    <div id="sl-dn" class="swipe-label">
        <span class="sl-down-emoji">ðŸ’¡</span>
        <div id="study-mount" class="study-content-wrap">
            <div class="context-block">
                <div class="study-header">CONTEXT</div>
                <div id="context-text" class="study-body"></div>
            </div>
            <div id="comparison-mount" class="comparison-block">
                <div class="study-header">OPTION COMPARISON</div>
                <div id="comparison-text" class="study-body"></div>
            </div>
        </div>
    </div>
</div>

<script>
const DATABASE = [
  { "q": "What does a negative Î”G value signify?", "h": "Analyze energy release vs requirement.", "u": "Spontaneous", "r": "Equilibrium", "l": "Non-Spont", "c": "UP", "context": "Think of a ball on a slope. It naturally rolls down to lower potential energy without a push.", "insights": "âŒ Positive Î”G = Requires Energy || âœ… Negative Î”G = Releases Energy (Spontaneous)." },
  { "q": "Why does a catalyst speed up a reaction?", "h": "Think about the energy 'hill'.", "u": "Changes K", "r": "Lowers Ea", "l": "Increases Î”H", "c": "RIGHT", "context": "Imagine a mountain tunnel. The start and end are the same height, but the tunnel is much faster to cross.", "insights": "âŒ Î”H/K Unchanged || âœ… Lower Activation Energy (Ea) path provided." }
];

let POOL = [], SCORE = 0, isTransitioning = false, studyStage = 0;
const CLAMP_UI = 32;
const TRIGGER_DEEP = 96; // 3 cm
const OPACITY_START = 24;

const format = t => {
    if(!t) return "";
    return t.toString().replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>').replace(/(\d*)([+\-])/g, '<sup>$1$2</sup>').replace(/\|\|/g, '<br><br>').replace(/Î”/g, '&Delta;');
};

function init(){
    POOL = [...DATABASE];
    setTimeout(() => { document.getElementById('loader').remove(); renderNext(); }, 1000);
}

function renderNext(){
    const s = document.getElementById('stack');
    const existingCard = s.querySelector('.card');
    if(existingCard) existingCard.remove();
    
    if(!POOL.length){ s.innerHTML = `<div class="card"><div class="card-q">MISSION COMPLETE<br>${SCORE} XP</div><button class="btn" onclick="location.reload()">REPLAY</button></div>`; return; }
    
    const q = POOL.shift();
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">${format(q.q)}</div>`;
    s.appendChild(c); 
    
    document.getElementById('sl-up').innerText = q.u;
    document.getElementById('sl-lt').innerText = q.l;
    document.getElementById('sl-rt').innerText = q.r;
    document.getElementById('context-text').innerHTML = format(q.context);
    document.getElementById('comparison-text').innerHTML = format(q.insights);

    bindMainPhysics(c, q);
}

function bindMainPhysics(el, qData){
    let sx=0, sy=0, active=false, dir=null, finalDist=0;
    const labels = { up: document.getElementById('sl-up'), dn: document.getElementById('sl-dn'), lt: document.getElementById('sl-lt'), rt: document.getElementById('sl-rt') };
    const bulb = labels.dn.querySelector('.sl-down-emoji');
    const wrap = document.getElementById('study-mount');
    const compare = document.getElementById('comparison-mount');

    const start = e => { if(isTransitioning) return; active=true; const p=e.touches?e.touches[0]:e; sx=p.clientX; sy=p.clientY; el.style.transition="none"; };
    
    const move = e => {
        if(!active) return; const p=e.touches?e.touches[0]:e;
        const dx = p.clientX - sx; const dy = p.clientY - sy;
        finalDist = Math.sqrt(dx*dx + dy*dy);
        const op = Math.min(finalDist / OPACITY_START, 1);
        let ang = Math.atan2(-dy, dx) * (180 / Math.PI); if(ang<0) ang+=360;
        
        let lDx = dx, lDy = dy;
        if(finalDist > CLAMP_UI) { const ratio = CLAMP_UI / finalDist; lDx = dx * ratio; lDy = dy * ratio; }

        Object.values(labels).forEach(l => { l.style.display = 'none'; l.style.opacity = 0; });

        if(finalDist > 5){
            let target = null;
            if(ang>=45&&ang<135) { target = labels.up; dir="UP"; }
            else if(ang>=135&&ang<225) { target = labels.lt; dir="LEFT"; }
            else if(ang>=225&&ang<315) { 
                target = labels.dn; dir="DOWN"; 
                const glow = Math.min((finalDist / TRIGGER_DEEP) * 40, 40);
                bulb.style.filter = `drop-shadow(0 0 ${glow}px var(--gold)) brightness(${1 + glow/15})`;
                
                // STAGE 1 REVEAL
                if(finalDist >= TRIGGER_DEEP && studyStage === 0) { wrap.classList.add('active'); }
                // STAGE 2 PREP
                if(finalDist >= TRIGGER_DEEP && studyStage === 1) { compare.classList.add('active'); }
            }
            else { target = labels.rt; dir="RIGHT"; }
            
            if(target) { 
                target.style.display = 'flex'; target.style.opacity = op; 
                target.style.transform = `translate3d(${lDx}px, ${lDy}px, 0)`; 
            }
        }
        el.style.transform = `translate3d(${dx}px, ${dy}px, 0) rotate(${dx/25}deg)`;
    };

    const end = () => {
        if(!active) return; active = false;
        
        if(dir === "DOWN"){
            if(finalDist >= TRIGGER_DEEP) { // Stage Advancement
                if(window.navigator.vibrate) window.navigator.vibrate(20);
                if(studyStage === 0) studyStage = 1;
                else if(studyStage === 1) studyStage = 0; // Toggle or hold
                el.style.transition = "transform .3s"; el.style.transform = "translate(0,0)";
            } else {
                // If let go early, hide hints but keep card
                wrap.classList.remove('active'); compare.classList.remove('active'); studyStage = 0;
                el.style.transition = "transform .2s"; el.style.transform = "translate(0,0)";
            }
        } else if(dir && finalDist >= CLAMP_UI){
            isTransitioning = true;
            el.style.transition = "transform .4s ease-in"; el.style.transform = `translate3d(${dir==="LEFT"?-400:400}px, ${dir==="UP"?-400:400}px, 0)`;
            if(dir === qData.c.toUpperCase()) SCORE += 10;
            setTimeout(() => { isTransitioning = false; studyStage = 0; wrap.classList.remove('active'); compare.classList.remove('active'); renderNext(); updateUI(); }, 300);
        } else {
            el.style.transition = "transform .2s"; el.style.transform = "translate3d(0,0,0) rotate(0deg)"; 
        }
        Object.values(labels).forEach(l => { l.style.display = 'none'; });
        bulb.style.filter = 'none';
    };
    el.onmousedown=start; window.onmousemove=move; window.onmouseup=end; el.ontouchstart=start; el.ontouchmove=move; el.ontouchend=end;
}
function updateUI(){ document.getElementById('xp-ui').innerText = `${SCORE} XP`; document.getElementById('progress-bar').style.width = `${(SCORE % 100)}%`; }
window.onload = init;
</script>
</body>
</html>
