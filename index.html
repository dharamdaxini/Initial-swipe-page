<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V133.27-R | Operator Interface</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;--card:#111;--border:#222;--gold:#ffd600;--blue:#3498db;
  --font-chem:'Crimson Text',serif;--font-ui:'Inter',sans-serif;--font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;height:100vh;background:var(--bg);color:#fff;
  font-family:var(--font-ui);overflow:hidden;
  display:flex;flex-direction:column;
  touch-action:manipulation;
}
#loader{
  position:fixed;inset:0;background:#000;z-index:5000;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--font-code);color:var(--gold);letter-spacing:5px
}
#header{width:90%;margin:25px auto 0;flex-shrink:0}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);font-size:.7rem;
  color:#555;letter-spacing:2px
}
.progress-track{width:100%;height:2px;background:#1a1a1a;margin-top:10px}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:width .4s ease}
#stack{
  position:relative;width:92%;max-width:400px;height:70vh;
  margin:auto;perspective:1200px;
  display:flex;align-items:center;justify-content:center
}
.card{
  position:absolute;width:100%;height:95%;
  background:var(--card);border-radius:40px;
  border:1px solid var(--border);
  padding:40px;display:flex;
  flex-direction:column;justify-content:center;
  box-shadow:0 30px 90px rgba(0,0,0,.9)
}
.card-q{
  font-family:var(--font-chem);
  font-size:1.7rem;line-height:1.4;
  font-style:italic;font-weight:600;
  text-align:center
}
</style>
</head>

<body>

<div id="loader">SYSTEM SYNC...</div>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">ID: BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
/* ================= FINAL OPERATOR ENGINE ================= */

const SYS={
  DB_KEY:'ALCHEMIST_MASTER_DB',
  XP_KEY:'ALCH_V133_XP',
  BUILD:'5'
};

/* ---------- IndexedDB ---------- */
const IDB_NAME='ALCHEMIST_IDB';
const IDB_STORE='KV';

function openDB(){
  return new Promise(res=>{
    const r=indexedDB.open(IDB_NAME,1);
    r.onupgradeneeded=e=>e.target.result.createObjectStore(IDB_STORE);
    r.onsuccess=()=>res(r.result);
  });
}
async function idbGet(k){
  const db=await openDB();
  return new Promise(res=>{
    const r=db.transaction(IDB_STORE).objectStore(IDB_STORE).get(k);
    r.onsuccess=()=>res(r.result||null);
  });
}
async function idbSet(k,v){
  const db=await openDB();
  db.transaction(IDB_STORE,'readwrite').objectStore(IDB_STORE).put(v,k);
}

/* ---------- Data Loader ---------- */
class AlchemistDB{
  static async fetchAll(){
    let data=await idbGet(SYS.DB_KEY);
    if(!data){
      const r=await fetch(`db/master.json?v=${SYS.BUILD}`,{cache:'no-store'});
      data=await r.json();
      if(!Array.isArray(data)||!data.length) return [];
      await idbSet(SYS.DB_KEY,data);
    }
    return data;
  }
}

/* ---------- UI ---------- */
const UI={
  loader:document.getElementById('loader'),
  stack:document.getElementById('stack'),
  xp:document.getElementById('xp-ui'),
  bar:document.getElementById('progress-bar'),
  id:document.getElementById('id-ui')
};

let STATE={
  pool:[],
  index:0,
  score:parseInt(localStorage.getItem(SYS.XP_KEY)||'0')
};

function updateHUD(){
  UI.xp.innerText=`${STATE.score} XP`;
  UI.bar.style.width=`${STATE.score%100}%`;
}

/* ---------- Card Engine ---------- */
function renderCard(){
  UI.stack.innerHTML='';

  if(STATE.index>=STATE.pool.length){
    STATE.index=0;
  }

  const q=STATE.pool[STATE.index];
  UI.id.innerText=q.id;

  const el=document.createElement('div');
  el.className='card';
  el.innerHTML=`<div class="card-q">${q.q}</div>`;
  UI.stack.appendChild(el);

  new PhysicsController(el,()=>{
    STATE.index++;
    STATE.score++;
    localStorage.setItem(SYS.XP_KEY,STATE.score);
    updateHUD();
    renderCard();
  });
}

/* ---------- Swipe Physics ---------- */
class PhysicsController{
  constructor(el,onCommit){
    this.el=el;
    this.cb=onCommit;
    this.active=false;
    this.start={x:0,y:0};
    this.bind();
  }
  bind(){
    const s=e=>this.startDrag(e.touches?e.touches[0]:e);
    const m=e=>this.moveDrag(e.touches?e.touches[0]:e);
    const e=()=>this.endDrag();
    this.el.addEventListener('mousedown',s);
    window.addEventListener('mousemove',m);
    window.addEventListener('mouseup',e);
    this.el.addEventListener('touchstart',s,{passive:false});
    this.el.addEventListener('touchmove',ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
    this.el.addEventListener('touchend',e);
  }
  startDrag(p){
    this.active=true;
    this.start={x:p.clientX,y:p.clientY};
    this.el.style.transition='none';
  }
  moveDrag(p){
    if(!this.active)return;
    const dx=p.clientX-this.start.x;
    const dy=p.clientY-this.start.y;
    this.el.style.transform=`translate3d(${dx}px,${dy}px,0) rotate(${dx/20}deg)`;
  }
  endDrag(){
    if(!this.active)return;
    this.active=false;
    this.el.style.transition='transform .25s ease, opacity .2s';
    this.el.style.transform='translate3d(320px,0,0)';
    this.el.style.opacity='0';
    setTimeout(()=>this.cb(),200);
  }
}

/* ---------- Boot ---------- */
async function Boot(){
  const all=await AlchemistDB.fetchAll();
  if(!all.length){
    UI.loader.innerText='NO DATABASE DETECTED';
    return;
  }
  UI.loader.style.display='none';
  STATE.pool=all;
  updateHUD();
  renderCard();
}

window.onload=Boot;
</script>

</body>
</html>
