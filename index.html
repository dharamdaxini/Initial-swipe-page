<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Chemistry Master V75.0</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color:#000;
    --card-bg:#111;
    --overlay-bg:#0d0d0d;
    --accent-gold:#ffd600;
    --font-chem:'Crimson Text', serif;
    --font-ui:'Inter', sans-serif;
    --font-code:'JetBrains Mono', monospace;
}

* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
body {
    margin:0; height:100vh; background:#000; color:#fff;
    font-family:var(--font-ui); overflow:hidden;
    user-select:none; -webkit-user-select:none; touch-action:none;
}

sub { font-size: 0.65em; vertical-align: sub; line-height: 0; font-family: var(--font-chem); }
sup { font-size: 0.65em; vertical-align: super; line-height: 0; font-family: var(--font-chem); }

#header { width:90%; margin:calc(15px + env(safe-area-inset-top)) auto 0; z-index:100; pointer-events:none; }
.header-meta { display:flex; justify-content:space-between; font-family:var(--font-code); font-size:.7rem; color:#666; margin-bottom:10px; }
.progress-track { width:100%; height:3px; background:#222; border-radius:2px; }
#progress-bar { height:100%; background:var(--accent-gold); width:0%; transition:width .4s ease; }

#stack {
    position:relative; width:92%; max-width:400px;
    height:calc(100vh - 145px - env(safe-area-inset-top));
    margin:30px auto 0; perspective:1200px;
}

.card {
    position:absolute; width:100%; height:100%;
    background:var(--card-bg); border-radius:40px; border:1px solid #282828;
    padding:40px; display:flex; flex-direction:column; justify-content:center;
    box-shadow:0 20px 60px rgba(0,0,0,.9);
    transform-origin: center center; 
    will-change:transform; cursor:grab;
    backface-visibility: hidden;
    transform: translate3d(0,0,0);
}

.card-q { font-family:var(--font-chem); font-size:2rem; line-height:1.35; font-style:italic; font-weight:600; text-align:center; color:#f0f0f0; }

.swipe-label {
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:#000; color:#fff; font-weight:900; font-size:2.1rem;
    text-transform:uppercase; border-radius:40px;
    z-index:999; opacity:0; pointer-events:none;
    text-align:center; padding:20px;
    transform: scale(0.85) translateZ(0);
    will-change: opacity, transform;
}

.sl-down { font-size: 1.3rem; font-style: normal; text-transform: none; color: var(--accent-gold); font-family: var(--font-chem); line-height: 1.4; }

.overlay {
    position:absolute; inset:0; background:var(--overlay-bg);
    z-index:1100; padding:45px 35px; opacity:0; pointer-events:none;
    border-radius:40px; transition:opacity .25s ease-out;
    display:flex; flex-direction:column; justify-content:center;
    overflow-y:auto;
}
.overlay.active { opacity:1; pointer-events:auto; }
.overlay-label { font-size:.8rem; color:var(--accent-gold); font-family:var(--font-code); margin-bottom:15px; text-transform:uppercase; }
.overlay-body { font-size:1.15rem; line-height:1.7; color:#ccc; margin-bottom:30px; font-family: var(--font-chem); }

.btn { width:100%; padding:18px; border-radius:60px; border:none; background:#fff; font-weight:900; cursor:pointer; text-transform:uppercase; font-family: var(--font-ui); }
#loader { position:fixed; inset:0; background:#000; z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:var(--font-code); font-size:.8rem; text-align:center; }
</style>
</head>

<body>
<div id="loader">LOCKED PRODUCTION V75.0â€¦</div>

<div id="header">
    <div class="header-meta">
        <span id="rank-ui">LEVEL: NOVICE</span>
        <span id="xp-ui">0 XP</span>
    </div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
const ENDPOINT="https://script.google.com/macros/s/AKfycbPvkuXpkFPZfwoj4H9Kevn2VXDcjjpOPxHtDqGDFxdclDdlwH0_0sHV-g4K1AGgfUJ/exec";

let RAW_DATA=[], POOL=[], MISTAKES=[], SCORE=0, isTransitioning=false;
let MODE="DATASET_SELECT", CURRENT_DATASET="", CURRENT_TOPIC="", CURRENT_GENRE="";

const formatChem = t => {
    if(!t) return "";
    return t.toString()
            .replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>')
            .replace(/(\d*)([+\-])/g, '<sup>$1$2</sup>')
            .replace(/\|\|/g, '<br><br>');
};

async function init(){
    try {
        const r = await fetch(ENDPOINT);
        RAW_DATA = await r.json();
        document.getElementById('loader').remove();
        renderDatasetSelect();
    } catch(e) { document.getElementById('loader').innerHTML = `SYNC FAILED`; }
}

// TIER 1: CHOOSE DATASET
function renderDatasetSelect(){
    MODE="DATASET_SELECT";
    const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">CHOOSE DATASET</div>
        <div class="swipe-label sl-up">DATASET A</div><div class="swipe-label sl-left">DATASET B</div>
        <div class="swipe-label sl-right">DATASET C</div><div class="swipe-label sl-down">DATASET D</div>`;
    s.appendChild(c); bindPhysics(c);
}

// TIER 2: CHOOSE TOPIC
function renderTopicSelect(dataset){
    MODE="TOPIC_SELECT";
    CURRENT_DATASET = dataset;
    const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">DATASET: ${dataset}<br>CHOOSE TOPIC</div>
        <div class="swipe-label sl-up">PHYSICAL</div><div class="swipe-label sl-left">ORGANIC</div>
        <div class="swipe-label sl-right">INORGANIC</div><div class="swipe-label sl-down">ANALYTICAL</div>`;
    s.appendChild(c); bindPhysics(c);
}

// TIER 3: CHOOSE GENRE
function renderGenreSelect(topic){
    MODE="GENRE_SELECT";
    CURRENT_TOPIC = topic;
    const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">${topic.toUpperCase()}<br>SELECT MODE</div>
        <div class="swipe-label sl-up">CONCEPT (CORE)</div>
        <div class="swipe-label sl-down">APPLICATION (ADV)</div>`;
    s.appendChild(c); bindPhysics(c);
}

function startQuiz(topic, genre){
    CURRENT_GENRE = genre;
    POOL = RAW_DATA.filter(q => 
        q.dataset.trim().toUpperCase() === CURRENT_DATASET.toUpperCase() &&
        q.topic.trim().toLowerCase() === topic.toLowerCase() && 
        q.q_type.trim().toUpperCase() === genre.toUpperCase()
    ).sort(() => Math.random() - .5);
    renderNext();
}

function renderNext(){
    const s=document.getElementById('stack'); s.innerHTML="";
    if(!POOL.length){ renderEnd(); return; }
    MODE="QUIZ"; const q = POOL.shift();

    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">${formatChem(q.question_text)}</div>
        <div class="swipe-label sl-up">${q.swipe_up_label}</div>
        <div class="swipe-label sl-left">${q.swipe_left_label}</div>
        <div class="swipe-label sl-right">${q.swipe_right_label}</div>
        <div class="swipe-label sl-down">${formatChem(q.hint)}</div>
        <div class="overlay">
            <div class="overlay-label">ANALYSIS REPORT</div>
            <div class="overlay-body">${formatChem(q.explanation)}</div>
            <button class="btn" onclick="this.parentElement.classList.remove('active')">DISMISS</button>
        </div>`;
    s.appendChild(c); bindPhysics(c, q);
}

function renderEnd(){
    MODE="SESSION_END";
    const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">SESSION END<br><small>${SCORE} XP</small></div>
        <div class="swipe-label sl-up">RESTART</div>
        <div class="swipe-label sl-left">REVIEW ERRORS (${MISTAKES.length})</div>
        <div class="swipe-label sl-right">TOGGLE MODE</div>
        <div class="swipe-label sl-down">CHANGE DATASET</div>`;
    s.appendChild(c); bindPhysics(c);
}

function bindPhysics(el, data){
    let x=0, y=0, sx=0, sy=0, active=false, isFrozen = false;
    const labels = { up: el.querySelector('.sl-up'), dn: el.querySelector('.sl-down'), lt: el.querySelector('.sl-left'), rt: el.querySelector('.sl-right') };

    const start = e => {
        if(isTransitioning || el.querySelector('.overlay.active')) return;
        active = true; const p = e.touches ? e.touches[0] : e;
        sx = p.clientX; sy = p.clientY; el.style.transition = "none";
    };

    const move = e => {
        if(!active) return;
        const p = e.touches ? e.touches[0] : e;
        let dx = p.clientX - sx; let dy = p.clientY - sy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        let angle = Math.atan2(-dy, dx) * (180 / Math.PI);
        if (angle < 0) angle += 360;

        if (dist >= 40) isFrozen = true;
        else if (dist < 20) isFrozen = false;
        if (isFrozen) {
            const rad = angle * (Math.PI / 180);
            dx = Math.cos(rad) * 40; dy = -Math.sin(rad) * 40;
        }
        x = dx; y = dy;

        requestAnimationFrame(() => {
            el.style.transform = `translate3d(${x}px,${y}px,0) rotate(${x/18}deg)`;
            Object.values(labels).forEach(l => { if(l) { l.style.opacity = 0; l.style.transform = "scale(0.85)"; } });
            
            if (dist > 1) {
                let activeLabel;
                if (angle >= 45 && angle < 135) activeLabel = labels.up;
                else if (angle >= 135 && angle < 225) activeLabel = labels.lt;
                else if (angle >= 225 && angle < 315) activeLabel = labels.dn;
                else activeLabel = labels.rt;

                if(activeLabel) {
                    const alpha = Math.min(dist / 30, 1);
                    activeLabel.style.opacity = alpha;
                    activeLabel.style.transform = `scale(${0.85 + (alpha * 0.25)})`;
                }
            }
        });
    };

    const end = () => {
        if(!active) return; active = false; 
        const dist = Math.sqrt(x*x + y*y);
        let angle = Math.atan2(-y, x) * (180 / Math.PI);
        if (angle < 0) angle += 360;

        if (dist >= 40) {
            let dir = (angle >= 45 && angle < 135) ? "UP" : (angle >= 135 && angle < 225) ? "LEFT" : (angle >= 225 && angle < 315) ? "DOWN" : "RIGHT";
            if (MODE === "QUIZ" && dir === "DOWN") {
                el.querySelector('.overlay').classList.add('active');
                el.style.transition = "transform .3s";
                el.style.transform = "translate3d(0,0,0) rotate(0deg)";
            } else handleAction(el, data, x, y, dir);
        } else {
            el.style.transition = "transform .4s cubic-bezier(.175,.885,.32,1.275)";
            el.style.transform = "translate3d(0,0,0) rotate(0deg)";
        }
        Object.values(labels).forEach(l => { if(l) l.style.opacity = 0; });
    };

    el.onmousedown = start; window.onmousemove = move; window.onmouseup = end;
    el.ontouchstart = start; el.ontouchmove = move; el.ontouchend = end;
}

function handleAction(el, data, x, y, dir){
    isTransitioning = true;
    if(MODE === "DATASET_SELECT"){
        const map = { UP: "SET_A", LEFT: "SET_B", RIGHT: "SET_C", DOWN: "SET_D" };
        renderTopicSelect(map[dir]);
    } else if(MODE === "TOPIC_SELECT"){
        const map = { UP: "Physical", LEFT: "Organic", RIGHT: "Inorganic", DOWN: "Analytical" };
        renderGenreSelect(map[dir]);
    } else if(MODE === "GENRE_SELECT"){
        const genre = (dir === "UP") ? "CONCEPT" : "APPLICATION";
        startQuiz(CURRENT_TOPIC, genre);
    } else if(MODE === "QUIZ"){
        if(dir === (data.correct || "UP").toString().toUpperCase()) SCORE += 10;
        else { SCORE = Math.max(0, SCORE - 5); MISTAKES.push(data); }
        renderNext();
    } else if(MODE === "SESSION_END"){
        if(dir === "UP") { startQuiz(CURRENT_TOPIC, CURRENT_GENRE); }
        else if(dir === "LEFT") { if(MISTAKES.length) { POOL = [...MISTAKES]; MISTAKES = []; renderNext(); } else { isTransitioning = false; return; } }
        else if(dir === "RIGHT") { const newGenre = (CURRENT_GENRE === "CONCEPT") ? "APPLICATION" : "CONCEPT"; startQuiz(CURRENT_TOPIC, newGenre); }
        else if(dir === "DOWN") { renderDatasetSelect(); }
    }
    el.style.transition = "transform .4s ease-in";
    el.style.transform = `translate3d(${x * 6}px,${y * 6}px,0) rotate(${x/5}deg)`;
    updateUI();
    setTimeout(() => { el.remove(); isTransitioning = false; }, 350);
}

function updateUI(){
    document.getElementById('xp-ui').innerText = `${SCORE} XP`;
    document.getElementById('rank-ui').innerText = `LEVEL: ${SCORE > 300 ? "ALCHEMIST" : "NOVICE"}`;
    document.getElementById('progress-bar').style.width = `${SCORE % 100}%`;
}
window.onload = init;
</script>
</body>
</html>
