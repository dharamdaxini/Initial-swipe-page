<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V133.27-R | Operator Interface</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;--card:#111;--border:#222;--gold:#ffd600;--blue:#3498db;
  --font-chem:'Crimson Text',serif;--font-ui:'Inter',sans-serif;--font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;height:100vh;background:var(--bg);color:#fff;
  font-family:var(--font-ui);overflow:hidden;
  display:flex;flex-direction:column;
  touch-action:manipulation; /* swipe enabled */
}
#loader{
  position:fixed;inset:0;background:#000;z-index:5000;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--font-code);color:var(--gold);letter-spacing:5px
}
#header{width:90%;margin:25px auto 0;flex-shrink:0}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);font-size:.7rem;
  color:#555;letter-spacing:2px
}
.progress-track{width:100%;height:2px;background:#1a1a1a;margin-top:10px}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:width .4s ease}
#stack{
  position:relative;width:92%;max-width:400px;height:70vh;
  margin:auto;perspective:1200px;
  display:flex;align-items:center;justify-content:center
}
.card{
  position:absolute;width:100%;height:95%;
  background:var(--card);border-radius:40px;
  border:1px solid var(--border);
  padding:40px;display:flex;
  flex-direction:column;justify-content:center;
  box-shadow:0 30px 90px rgba(0,0,0,.9)
}
.card-q{
  font-family:var(--font-chem);
  font-size:1.7rem;line-height:1.4;
  font-style:italic;font-weight:600;
  text-align:center
}
.swipe-label{
  position:absolute;inset:0;display:flex;
  align-items:center;justify-content:center;
  background:#000;color:#fff;
  font-weight:900;font-size:1.8rem;
  text-transform:uppercase;border-radius:40px;
  opacity:0;pointer-events:none
}
</style>
</head>

<body>

<div id="loader">SYSTEM SYNC...</div>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">ID: BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
/* ================= BACKEND (FINAL) ================= */

const SYS={
  DB_KEY:'ALCHEMIST_MASTER_DB',
  XP_KEY:'ALCH_V133_XP',
  BUILD:'3' // bump this when master.json updates
};

/* ---------- IndexedDB ---------- */
const IDB_NAME='ALCHEMIST_IDB';
const IDB_STORE='KV';

function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(IDB_NAME,1);
    r.onupgradeneeded=e=>e.target.result.createObjectStore(IDB_STORE);
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej();
  });
}
async function idbGet(k){
  const db=await openDB();
  return new Promise(res=>{
    const r=db.transaction(IDB_STORE).objectStore(IDB_STORE).get(k);
    r.onsuccess=()=>res(r.result||null);
  });
}
async function idbSet(k,v){
  const db=await openDB();
  const tx=db.transaction(IDB_STORE,'readwrite');
  tx.objectStore(IDB_STORE).put(v,k);
}

/* ---------- Data Loader ---------- */
class AlchemistDB{
  static async fetchAll(){
    let data=await idbGet(SYS.DB_KEY);
    if(!data){
      try{
        const r=await fetch(`db/master.json?v=${SYS.BUILD}`,{cache:'no-store'});
        data=await r.json();
        if(!Array.isArray(data)||!data.length) throw 'EMPTY';
        await idbSet(SYS.DB_KEY,data);
      }catch{return []}
    }
    return data;
  }
}

/* ---------- Physics (Swipe) ---------- */
class PhysicsController{
  constructor(el){
    this.el=el;this.active=false;this.start={x:0,y:0};this.bind();
  }
  bind(){
    const s=e=>this.onStart(e.touches?e.touches[0]:e);
    const m=e=>this.onMove(e.touches?e.touches[0]:e);
    const e=()=>this.onEnd();
    this.el.addEventListener('mousedown',s);
    window.addEventListener('mousemove',m);
    window.addEventListener('mouseup',e);
    this.el.addEventListener('touchstart',s,{passive:false});
    this.el.addEventListener('touchmove',ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
    this.el.addEventListener('touchend',e);
  }
  onStart(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition='none'}
  onMove(p){
    if(!this.active)return;
    const dx=p.clientX-this.start.x, dy=p.clientY-this.start.y;
    this.el.style.transform=`translate3d(${dx}px,${dy}px,0) rotate(${dx/20}deg)`;
  }
  onEnd(){
    if(!this.active)return;
    this.active=false;
    this.el.style.transition='transform .3s ease';
    this.el.style.transform='translate3d(0,0,0)';
  }
}

/* ---------- UI ---------- */
const UI={
  loader:document.getElementById('loader'),
  stack:document.getElementById('stack'),
  xp:document.getElementById('xp-ui'),
  bar:document.getElementById('progress-bar')
};
let STATE={score:parseInt(localStorage.getItem(SYS.XP_KEY)||'0')};

function UpdateHUD(){
  UI.xp.innerText=`${STATE.score} XP`;
  UI.bar.style.width=`${STATE.score%100}%`;
}

/* ---------- Boot ---------- */
async function Boot(){
  const all=await AlchemistDB.fetchAll();
  if(!all.length){UI.loader.innerText='NO DATABASE DETECTED';return;}
  UI.loader.style.display='none';
  UpdateHUD();

  const el=document.createElement('div');
  el.className='card';
  el.innerHTML=`<div class="card-q">${all[0].q||all[0].set}</div>`;
  UI.stack.appendChild(el);
  new PhysicsController(el);
}

window.onload=Boot;
</script>
</body>
</html>
