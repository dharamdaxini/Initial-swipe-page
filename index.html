<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Chemistry Master V72.6 (Tactile Latch)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color:#000;
    --card-bg:#111;
    --overlay-bg:#0d0d0d;
    --accent-gold:#ffd600;
    --accent-blue:#2962ff;
    --text-main:#fff;
    --font-chem:'Crimson Text',serif;
    --font-ui:'Inter',sans-serif;
    --font-code:'JetBrains Mono',monospace;
}

* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
body {
    margin:0; height:100vh; background:#000; color:#fff;
    font-family:var(--font-ui); overflow:hidden;
    user-select:none; -webkit-user-select:none; touch-action:none;
}

#header { width:90%; margin:calc(15px + env(safe-area-inset-top)) auto 0; z-index:100; pointer-events:none; }
.header-meta { display:flex; justify-content:space-between; font-family:var(--font-code); font-size:.7rem; color:#666; margin-bottom:10px; }
.progress-track { width:100%; height:3px; background:#222; border-radius:2px; }
#progress-bar { height:100%; background:var(--accent-gold); width:0%; transition:width .4s ease; }

#stack {
    position:relative; width:92%; max-width:400px;
    height:calc(100vh - 145px - env(safe-area-inset-top));
    margin:30px auto 0; perspective:1200px;
}

.card {
    position:absolute; width:100%; height:100%;
    background:var(--card-bg); border-radius:40px; border:1px solid #282828;
    padding:40px; display:flex; flex-direction:column; justify-content:center;
    box-shadow:0 20px 60px rgba(0,0,0,.9);
    transform-origin: center 120%; 
    will-change:transform; cursor:grab;
    backface-visibility: hidden;
    transform: translate3d(0,0,0);
}

.card-q { font-family:var(--font-chem); font-size:2rem; line-height:1.35; font-style:italic; font-weight:600; text-align:center; color:#f0f0f0; }

.swipe-label {
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:#000; color:#fff; font-weight:900; font-size:2.1rem;
    text-transform:uppercase; border-radius:40px;
    z-index:999; opacity:0; pointer-events:none;
    transform:scale(0.85);
    will-change:opacity, transform;
}

.overlay {
    position:absolute; inset:0; background:var(--overlay-bg);
    z-index:110; padding:45px 35px; opacity:0; pointer-events:none;
    border-radius:40px; transition:opacity .25s ease-out;
    display:flex; flex-direction:column; justify-content:center;
}
.overlay.active { opacity:1; pointer-events:auto; }

.btn { width:100%; padding:18px; border-radius:60px; border:none; background:#fff; font-weight:900; cursor:pointer; text-transform:uppercase; }
#loader { position:fixed; inset:0; background:#000; z-index:500; display:flex; align-items:center; justify-content:center; font-family:var(--font-code); font-size:.7rem; }
</style>
</head>

<body>
<div id="loader">V72.6 TACTILE_LATCH_ACTIVEâ€¦</div>

<div id="header">
    <div class="header-meta">
        <span id="rank-ui">KNOWLEDGE: NOVICE</span>
        <span id="xp-ui">0 XP</span>
    </div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
const ENDPOINT="https://script.google.com/macros/s/AKfycbzjKbwDxrHKu55pOsjtyR__gJisnxjyTxOIiWeAQOKCT9BY--elHIQUfHO2bNX3Gd-8/exec";
let RAW_DATA=[], POOL=[], MISTAKES=[], SCORE=0, isTransitioning=false;
let MODE="TOPIC_SELECT";

const formatChem = t => t?.replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>').replace(/(\d+)([+\-])/g, '<sup>$1$2</sup>') || "";

async function init(){
    try {
        const r = await fetch(ENDPOINT);
        RAW_DATA = await r.json();
        document.getElementById('loader').remove();
        renderTopicSelect();
    } catch(e) { document.getElementById('loader').innerText="SYNC FAILED"; }
}

function renderTopicSelect(){
    MODE="TOPIC_SELECT";
    const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">SELECT CORE TOPIC</div>
        <div class="swipe-label sl-up">PHYSICAL</div><div class="swipe-label sl-left">ORGANIC</div>
        <div class="swipe-label sl-right">INORGANIC</div><div class="swipe-label sl-down">ANALYTICAL</div>`;
    s.appendChild(c); bindPhysics(c,{type:"nav"});
}

function renderNext(){
    const s=document.getElementById('stack'); s.innerHTML="";
    if(!POOL.length){ renderEnd(); return; }
    MODE="QUIZ"; const q=POOL.shift();
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">${formatChem(q.question_text||q.text)}</div>
        <div class="swipe-label sl-up">${q.swipe_up_label||"YES"}</div><div class="swipe-label sl-left">${q.swipe_left_label||"NO"}</div>
        <div class="swipe-label sl-right">${q.swipe_right_label||"MAYBE"}</div><div class="swipe-label sl-down">ANALYSIS</div>
        <div class="overlay"><div class="overlay-label">ANALYSIS</div><div class="overlay-body">${formatChem(q.explanation)}</div>
        <button class="btn" onclick="this.parentElement.classList.remove('active')">BACK</button></div>`;
    s.appendChild(c); bindPhysics(c,q);
}

function renderEnd(){
    MODE="SESSION_END";
    const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">SESSION COMPLETE<br><small>${SCORE} XP</small></div>
        <div class="swipe-label sl-up">RESTART</div><div class="swipe-label sl-left">REVIEW ERRORS (${MISTAKES.length})</div>
        <div class="swipe-label sl-right">CHANGE TOPIC</div><div class="swipe-label sl-down">EXIT</div>`;
    s.appendChild(c); bindPhysics(c,{type:"nav"});
}

function bindPhysics(el,data){
    let x=0, y=0, sx=0, sy=0, active=false;
    let isFrozen = false;
    const labels = { up: el.querySelector('.sl-up'), dn: el.querySelector('.sl-down'), lt: el.querySelector('.sl-left'), rt: el.querySelector('.sl-right') };

    const start = e => {
        if(isTransitioning || el.querySelector('.overlay.active')) return;
        active = true; const p = e.touches ? e.touches[0] : e;
        sx = p.clientX; sy = p.clientY; el.style.transition = "none";
        isFrozen = false;
    };

    const move = e => {
        if(!active) return; const p = e.touches ? e.touches[0] : e;
        let dx = p.clientX - sx; let dy = p.clientY - sy;
        
        const govLimit = 20; // 0.5cm
        const selectLimit = 40; // 1cm
        const dist = Math.sqrt(dx*dx + dy*dy);
        let angle = Math.atan2(-dy, dx) * (180 / Math.PI);
        if (angle < 0) angle += 360;

        // V72.6 TACTILE LATCH LOGIC
        if (dist >= selectLimit) {
            isFrozen = true;
        } else if (dist < govLimit) {
            isFrozen = false;
        }

        if (isFrozen) {
            // Keep card clamped at the 1cm selection radius
            const rad = angle * (Math.PI / 180);
            dx = Math.cos(rad) * selectLimit;
            dy = -Math.sin(rad) * selectLimit;
        } else if (dist > govLimit) {
            // Damping zone between 0.5cm and 1cm
            const rad = angle * (Math.PI / 180);
            const dampenedDist = govLimit + ((dist - govLimit) * 0.3);
            dx = Math.cos(rad) * dampenedDist;
            dy = -Math.sin(rad) * dampenedDist;
        }

        x = dx; y = dy;
        el.style.transform = `translate3d(${x}px,${y}px,0) rotate(${x/18}deg)`;

        // Label visibility tied to card position for smooth interpolation
        const currentDist = Math.sqrt(x*x + y*y);
        Object.values(labels).forEach(l => { l.style.opacity = 0; });
        if (currentDist >= govLimit) {
            let activeLabel;
            if (angle >= 45 && angle < 135) activeLabel = labels.up;
            else if (angle >= 135 && angle < 225) activeLabel = labels.lt;
            else if (angle >= 225 && angle < 315) activeLabel = labels.dn;
            else activeLabel = labels.rt;

            const alpha = Math.min((currentDist - govLimit) / 15, 1);
            activeLabel.style.opacity = alpha;
            activeLabel.style.transform = `scale(${0.9 + (alpha * 0.2)})`;
        }
    };

    const end = () => {
        if(!active) return; active = false; 
        const selectThresh = 40; 
        const dist = Math.sqrt(x*x + y*y);
        let angle = Math.atan2(-y, x) * (180 / Math.PI);
        if (angle < 0) angle += 360;

        if (dist >= selectThresh) {
            let dir;
            if (angle >= 45 && angle < 135) dir = "UP";
            else if (angle >= 135 && angle < 225) dir = "LEFT";
            else if (angle >= 225 && angle < 315) dir = "DOWN";
            else dir = "RIGHT";

            if (MODE === "QUIZ" && dir === "DOWN") {
                el.querySelector('.overlay').classList.add('active');
                el.style.transition = "transform .3s ease-out";
                el.style.transform = "translate3d(0,0,0) rotate(0deg)";
            } else {
                handleAction(el, data, x, y, dir);
            }
        } else {
            el.style.transition = "transform .4s cubic-bezier(.175,.885,.32,1.275)";
            el.style.transform = "translate3d(0,0,0) rotate(0deg)";
        }
        Object.values(labels).forEach(l => { l.style.opacity = 0; });
        isFrozen = false;
    };

    el.onmousedown = start; window.onmousemove = move; window.onmouseup = end;
    el.ontouchstart = start; el.ontouchmove = move; el.ontouchend = end;
}

function handleAction(el, data, x, y, dir){
    isTransitioning = true;
    if(MODE === "TOPIC_SELECT"){
        const map = { UP: "Physical", LEFT: "Organic", RIGHT: "Inorganic", DOWN: "Analytical" };
        POOL = RAW_DATA.filter(q => q.topic === map[dir]).sort(() => Math.random() - .5);
        SCORE = 0; MISTAKES = [];
    } else if(MODE === "QUIZ" && dir !== "DOWN"){
        if(dir === (data.correct || "UP").toUpperCase()) SCORE += 10;
        else { SCORE = Math.max(0, SCORE - 5); MISTAKES.push(data); }
    } else if(MODE === "SESSION_END"){
        if(dir === "LEFT" && MISTAKES.length){ POOL = [...MISTAKES]; MISTAKES = []; isTransitioning = false; renderNext(); return; }
        SCORE = 0; MISTAKES = []; renderTopicSelect(); isTransitioning = false; return;
    }
    updateUI();
    el.style.transition = "transform .4s ease-in";
    el.style.transform = `translate3d(${x * 6}px,${y * 6}px,0) rotate(${x/5}deg)`;
    setTimeout(() => { el.remove(); isTransitioning = false; renderNext(); }, 350);
}

function updateUI(){
    document.getElementById('xp-ui').innerText = `${SCORE} XP`;
    document.getElementById('rank-ui').innerText = `KNOWLEDGE: ${SCORE > 300 ? "ALCHEMIST" : "NOVICE"}`;
    document.getElementById('progress-bar').style.width = `${SCORE % 100}%`;
}
window.onload = init;
</script>
</body>
</html>
