<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V81.1 Final</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
/* V81.1 CSS - INTEGRATED BUILD */
:root { 
    --bg-color: #050505; --card-bg: #141414; --accent-gold: #ffcc00; --hint-blue: #4dabf7; --err-red: #ff4d4d;
    --font-ui: 'Outfit', sans-serif; --font-chem: 'Libre Baskerville', serif; --font-code: 'JetBrains Mono', monospace; 
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; height: 100vh; background: var(--bg-color); color: #fff; font-family: var(--font-ui); overflow: hidden; touch-action: none; user-select: none; }
sub { font-size: 0.7em; vertical-align: sub; line-height: 0; }
sup { font-size: 0.7em; vertical-align: super; line-height: 0; }

#header { width: 90%; margin: calc(20px + env(safe-area-inset-top)) auto 0; pointer-events: none; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--font-code); font-size: 0.75rem; color: #666; margin-bottom: 8px; letter-spacing: 0.5px; }
.progress-track { width: 100%; height: 4px; background: #222; border-radius: 4px; }
#progress-bar { height: 100%; background: var(--accent-gold); width: 0%; transition: width 0.4s ease; box-shadow: 0 0 12px rgba(255, 204, 0, 0.4); }

#stack { position: relative; width: 92%; max-width: 400px; height: calc(100vh - 160px - env(safe-area-inset-top)); margin: 25px auto 0; perspective: 1200px; }

.card { 
    position: absolute; width: 100%; height: 100%; 
    background: var(--card-bg); border-radius: 32px; border: 1px solid #333; padding: 35px; 
    display: flex; flex-direction: column; justify-content: center; transform-origin: center center; 
    box-shadow: 0 25px 50px rgba(0,0,0,0.95); will-change: transform; 
}
.card-q { font-family: var(--font-chem); font-size: 1.9rem; line-height: 1.5; font-weight: 400; text-align: center; color: #e0e0e0; }

.swipe-label { 
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
    background: rgba(0,0,0,0.92); font-family: var(--font-ui); font-weight: 800; font-size: 2.2rem; 
    text-transform: uppercase; border-radius: 32px; opacity: 0; pointer-events: none; z-index:100; letter-spacing: 2px;
}
.sl-down-hint { 
    color: var(--hint-blue) !important; font-size: 1.5rem !important; text-transform: none !important; 
    font-family: var(--font-chem) !important; background: rgba(10, 10, 10, 0.98) !important; padding: 40px !important; line-height: 1.6 !important;
}

/* ANALYSIS MODAL STYLES */
#analysis-modal {
    position: absolute; inset: 0; background: #000; z-index: 2000; 
    display: flex; flex-direction: column; opacity: 0; pointer-events: none; 
    transition: opacity 0.3s ease; padding-top: env(safe-area-inset-top);
}
#analysis-modal.active { opacity: 1; pointer-events: auto; }

.analysis-header { padding: 20px; text-align: center; border-bottom: 1px solid #333; font-family: var(--font-ui); color: var(--accent-gold); font-weight: 900; letter-spacing: 2px; }
.analysis-scroll { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

.mistake-card {
    background: #111; border: 1px solid #333; border-radius: 16px; padding: 20px; margin-bottom: 20px;
}
.mistake-q { font-family: var(--font-chem); font-size: 1.1rem; color: #fff; margin-bottom: 10px; }
.mistake-ans { font-family: var(--font-code); font-size: 0.8rem; color: var(--err-red); margin-bottom: 10px; text-transform: uppercase; }
.mistake-exp { font-family: var(--font-chem); font-size: 0.95rem; color: #aaa; line-height: 1.5; border-top: 1px solid #222; padding-top: 10px; }

.input-name { width: 100%; padding: 18px; border-radius: 16px; border: 1px solid #444; background: #1a1a1a; color: #fff; font-family: var(--font-ui); font-size: 1.1rem; margin-bottom: 15px; text-align: center; outline: none; }
.input-name:focus { border-color: var(--accent-gold); }
.btn { width: 100%; padding: 20px; border-radius: 100px; border: none; background: #fff; color: #000; font-weight: 800; cursor: pointer; text-transform: uppercase; font-family: var(--font-ui); letter-spacing: 1px; margin-top: 10px; font-size: 0.9rem; }
.btn-save { background: var(--accent-gold); color: #000; box-shadow: 0 5px 20px rgba(255, 204, 0, 0.2); }
.btn-review { background: #333; color: #fff; border: 1px solid #555; }
.btn-close { background: transparent; color: #fff; border: 1px solid #333; margin: 20px; width: calc(100% - 40px); }

#loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; font-family: var(--font-ui); font-weight: 900; font-size: 1.5rem; letter-spacing: 4px; color: var(--accent-gold); flex-direction: column; }
#status-msg { font-size: 0.9rem; margin-top: 15px; color: #888; font-family: var(--font-ui); text-align: center; min-height: 20px;}
</style>
</head>

<body>
<div id="loader">ALCHEMIST<br><small style="font-size:0.4em; opacity:0.5; margin-top:15px; font-weight:400; font-family:var(--font-code);">V81.1 FINAL</small></div>

<div id="analysis-modal">
    <div class="analysis-header">SESSION ANALYSIS</div>
    <div class="analysis-scroll" id="analysis-content">
        </div>
    <button class="btn btn-close" onclick="document.getElementById('analysis-modal').classList.remove('active')">CLOSE ANALYSIS</button>
</div>

<div id="header">
    <div class="header-meta"><span id="rank-ui">RANK: NOVICE</span><span id="xp-ui">0 XP</span></div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
// =========================================================
// YOUR DEPLOYMENT URL IS HARDCODED HERE
// =========================================================
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx0MOn2CEOHtwcraedSgmR_622esgwSAiWks3tNV51yc9XeKGrIip7lIxAu5iT460YT/exec"; 

// FULL 90-QUESTION DATABASE
const BACKUP_DATA = [
  { "dataset": "SET_A", "topic": "Physical", "q_type": "CONCEPT", "question_text": "What does a negative ŒîG value signify?", "hint": "Thermodynamic direction.", "explanation": "‚úÖ Spontaneous reaction.", "swipe_up_label": "Spontaneous", "swipe_right_label": "Equilibrium", "swipe_down_label": "HINT", "swipe_left_label": "Non-spontaneous", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Physical", "q_type": "APPLICATION", "question_text": "If reaction rate doubles when T increases from 298K to 308K, effect on k?", "hint": "Thermal kinetic energy.", "explanation": "‚úÖ k increases exponentially.", "swipe_up_label": "k Increases", "swipe_right_label": "k is Constant", "swipe_down_label": "HINT", "swipe_left_label": "k Decreases", "correct": "UP", "weight": 2 },
  { "dataset": "SET_A", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Half-life vs concentration in 1st order?", "hint": "Concentration independence.", "explanation": "‚úÖ Independent.", "swipe_up_label": "Increases", "swipe_right_label": "Independent", "swipe_down_label": "HINT", "swipe_left_label": "Decreases", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_A", "topic": "Physical", "q_type": "APPLICATION", "question_text": "Zn2+/Zn (-0.76V) vs Cu2+/Cu (+0.34V). Eo cell?", "hint": "Potential difference.", "explanation": "‚úÖ 1.10 V.", "swipe_up_label": "-0.42 V", "swipe_right_label": "1.10 V", "swipe_down_label": "HINT", "swipe_left_label": "0.42 V", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Equilibrium: Forward vs Backward rates?", "hint": "Kinetic balance.", "explanation": "‚úÖ Rates are equal.", "swipe_up_label": "Zero", "swipe_right_label": "Equal", "swipe_down_label": "HINT", "swipe_left_label": "Forward > Back", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_A", "topic": "Physical", "q_type": "APPLICATION", "question_text": "pH of 0.001 M HCl?", "hint": "Logarithmic acidity.", "explanation": "‚úÖ pH 3.", "swipe_up_label": "pH 7", "swipe_right_label": "pH 3", "swipe_down_label": "HINT", "swipe_left_label": "pH 1", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Physical", "q_type": "CONCEPT", "question_text": "How does a catalyst work?", "hint": "Barrier reduction.", "explanation": "‚úÖ Lowers Ea.", "swipe_up_label": "Changes K", "swipe_right_label": "Lowers Ea", "swipe_down_label": "HINT", "swipe_left_label": "Increases Ea", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Physical", "q_type": "APPLICATION", "question_text": "Haber Process: High Pressure?", "hint": "Volume stress.", "explanation": "‚úÖ Shifts Right (Fewer moles).", "swipe_up_label": "Left", "swipe_right_label": "No Effect", "swipe_down_label": "HINT", "swipe_left_label": "Right", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_B", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Rusting requires?", "hint": "Redox environment.", "explanation": "‚úÖ O2 + H2O.", "swipe_up_label": "O2 + H2O", "swipe_right_label": "H2O only", "swipe_down_label": "HINT", "swipe_left_label": "N2", "correct": "UP", "weight": 1 },
  { "dataset": "SET_B", "topic": "Physical", "q_type": "APPLICATION", "question_text": "Brine Electrolysis Anode Product?", "hint": "Electron loss site.", "explanation": "‚úÖ Cl2 Gas.", "swipe_up_label": "H2", "swipe_right_label": "Cl2", "swipe_down_label": "HINT", "swipe_left_label": "Na", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_B", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Helium in diving tanks?", "hint": "Blood saturation.", "explanation": "‚úÖ Low solubility prevents bends.", "swipe_up_label": "Cost", "swipe_right_label": "Solubility", "swipe_down_label": "HINT", "swipe_left_label": "Weight", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Physical", "q_type": "APPLICATION", "question_text": "Half-life 6h. After 24h?", "hint": "Exponential decay.", "explanation": "‚úÖ 6.25%.", "swipe_up_label": "12.5%", "swipe_right_label": "25%", "swipe_down_label": "HINT", "swipe_left_label": "6.25%", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Chiral Carbon?", "hint": "Optical asymmetry.", "explanation": "‚úÖ Bonded to 4 unique groups.", "swipe_up_label": "4 Unique", "swipe_right_label": "Symmetry", "swipe_down_label": "HINT", "swipe_left_label": "Double Bond", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Fastest SN2?", "hint": "Spatial access.", "explanation": "‚úÖ Methyl Halide.", "swipe_up_label": "Tertiary", "swipe_right_label": "Secondary", "swipe_down_label": "HINT", "swipe_left_label": "Methyl", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Organic", "q_type": "CONCEPT", "question_text": "SN1 Intermediate?", "hint": "Cationic stability.", "explanation": "‚úÖ Carbocation.", "swipe_up_label": "Carbanion", "swipe_right_label": "Radical", "swipe_down_label": "HINT", "swipe_left_label": "Carbocation", "correct": "LEFT", "weight": 1 },
  { "dataset": "SET_A", "topic": "Organic", "q_type": "APPLICATION", "question_text": "IUPAC: CH3CH2CH(CH3)2", "hint": "Parent alkane.", "explanation": "‚úÖ 2-Methylbutane.", "swipe_up_label": "Pentane", "swipe_right_label": "Isopentane", "swipe_down_label": "HINT", "swipe_left_label": "2-Methylbutane", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Ethene Hybridization?", "hint": "Planar geometry.", "explanation": "‚úÖ sp2.", "swipe_up_label": "sp", "swipe_right_label": "sp2", "swipe_down_label": "HINT", "swipe_left_label": "sp3", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_A", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Markovnikov HBr + Propene?", "hint": "Cation preference.", "explanation": "‚úÖ H to C1, Br to C2.", "swipe_up_label": "C3", "swipe_right_label": "C1", "swipe_down_label": "HINT", "swipe_left_label": "C2", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_B", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Teflon Monomer?", "hint": "Halogenated monomer.", "explanation": "‚úÖ Tetrafluoroethene.", "swipe_up_label": "Nylon", "swipe_right_label": "Teflon", "swipe_down_label": "HINT", "swipe_left_label": "PVC", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Saponification products?", "hint": "Base hydrolysis.", "explanation": "‚úÖ Soap + Glycerol.", "swipe_up_label": "Soap+Glycerol", "swipe_right_label": "Ester+Water", "swipe_down_label": "HINT", "swipe_left_label": "Acid+Alc", "correct": "UP", "weight": 2 },
  { "dataset": "SET_B", "topic": "Organic", "q_type": "CONCEPT", "question_text": "CFC harm?", "hint": "Stratospheric reaction.", "explanation": "‚úÖ Ozone Depletion.", "swipe_up_label": "Smog", "swipe_right_label": "Ozone", "swipe_down_label": "HINT", "swipe_left_label": "Acid Rain", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Aspirin synthesis group?", "hint": "Acetylation product.", "explanation": "‚úÖ Ester.", "swipe_up_label": "Ether", "swipe_right_label": "Amide", "swipe_down_label": "HINT", "swipe_left_label": "Ester", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_B", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Octane Rating?", "hint": "Ignition timing.", "explanation": "‚úÖ Knock Resistance.", "swipe_up_label": "Energy", "swipe_right_label": "Knock Resist", "swipe_down_label": "HINT", "swipe_left_label": "Speed", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Hydrogenation Catalyst?", "hint": "Surface adsorption.", "explanation": "‚úÖ Nickel.", "swipe_up_label": "Vanadium", "swipe_right_label": "Platinum", "swipe_down_label": "HINT", "swipe_left_label": "Nickel", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "SF6 Geometry?", "hint": "Valence repulsion.", "explanation": "‚úÖ Octahedral.", "swipe_up_label": "Octahedral", "swipe_right_label": "Tetrahedral", "swipe_down_label": "HINT", "swipe_left_label": "Square", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "PCl5 Hybridization?", "hint": "Expanded octet.", "explanation": "‚úÖ sp3d.", "swipe_up_label": "sp3d", "swipe_right_label": "sp3", "swipe_down_label": "HINT", "swipe_left_label": "sp3d2", "correct": "UP", "weight": 2 },
  { "dataset": "SET_A", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Transition Color?", "hint": "Electronic excitation.", "explanation": "‚úÖ d-d transitions.", "swipe_up_label": "d-d", "swipe_right_label": "s-p", "swipe_down_label": "HINT", "swipe_left_label": "Mass", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "Mn oxidation in KMnO4?", "hint": "Charge balance.", "explanation": "‚úÖ +7.", "swipe_up_label": "+7", "swipe_right_label": "+2", "swipe_down_label": "HINT", "swipe_left_label": "+4", "correct": "UP", "weight": 2 },
  { "dataset": "SET_A", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Strong Field Ligand?", "hint": "Orbital gap.", "explanation": "‚úÖ Low Spin.", "swipe_up_label": "Low Spin", "swipe_right_label": "High Spin", "swipe_down_label": "HINT", "swipe_left_label": "Neutral", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "Paramagnetic Ion?", "hint": "Magnetic susceptibility.", "explanation": "‚úÖ Fe3+.", "swipe_up_label": "Sc3+", "swipe_right_label": "Zn2+", "swipe_down_label": "HINT", "swipe_left_label": "Fe3+", "correct": "LEFT", "weight": 2 },
  { "dataset": "SET_B", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Froth Flotation?", "hint": "Surface wettability.", "explanation": "‚úÖ Sulfide Ores.", "swipe_up_label": "Refining", "swipe_right_label": "Concentration", "swipe_down_label": "HINT", "swipe_left_label": "Reduction", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "Blast Furnace Reducer?", "hint": "Oxide stripper.", "explanation": "‚úÖ Carbon Monoxide.", "swipe_up_label": "CO2", "swipe_right_label": "CO", "swipe_down_label": "HINT", "swipe_left_label": "O2", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_B", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "P in NPK?", "hint": "Root development.", "explanation": "‚úÖ Phosphorus.", "swipe_up_label": "Lead", "swipe_right_label": "Phosphorus", "swipe_down_label": "HINT", "swipe_left_label": "Potassium", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "Zeolites function?", "hint": "Cation swapping.", "explanation": "‚úÖ Ion Exchange.", "swipe_up_label": "Ion Exchange", "swipe_right_label": "Filter", "swipe_down_label": "HINT", "swipe_left_label": "Precip", "correct": "UP", "weight": 2 },
  { "dataset": "SET_B", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Stainless Steel Alloy?", "hint": "Passive layer.", "explanation": "‚úÖ Chromium.", "swipe_up_label": "Chromium", "swipe_right_label": "Copper", "swipe_down_label": "HINT", "swipe_left_label": "Carbon", "correct": "UP", "weight": 1 },
  { "dataset": "SET_B", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "AgBr use?", "hint": "Photon response.", "explanation": "‚úÖ Light Sensitivity.", "swipe_up_label": "Develop", "swipe_right_label": "Light Sens", "swipe_down_label": "HINT", "swipe_left_label": "Reflect", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "NMR Standard?", "hint": "Magnetic zero.", "explanation": "‚úÖ TMS.", "swipe_up_label": "TMS", "swipe_right_label": "Benzene", "swipe_down_label": "HINT", "swipe_left_label": "Water", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "IR 1710 cm-1?", "hint": "Bond vibration.", "explanation": "‚úÖ Carbonyl.", "swipe_up_label": "Carbonyl", "swipe_right_label": "Alkane", "swipe_down_label": "HINT", "swipe_left_label": "Alcohol", "correct": "UP", "weight": 2 },
  { "dataset": "SET_A", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Molecular Ion?", "hint": "Parent mass.", "explanation": "‚úÖ Mass of molecule.", "swipe_up_label": "Mol Ion", "swipe_right_label": "Fragment", "swipe_down_label": "HINT", "swipe_left_label": "Base Peak", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "HCl + NaOH pH?", "hint": "Neutralization point.", "explanation": "‚úÖ pH 7.", "swipe_up_label": "9", "swipe_right_label": "7", "swipe_down_label": "HINT", "swipe_left_label": "4", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_A", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Beer-Lambert?", "hint": "Light attenuation.", "explanation": "‚úÖ Absorbance prop. to Conc.", "swipe_up_label": "Vol", "swipe_right_label": "Conc", "swipe_down_label": "HINT", "swipe_left_label": "Temp", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "BOD?", "hint": "Microbial consumption.", "explanation": "‚úÖ Oxygen Demand.", "swipe_up_label": "O2 Demand", "swipe_right_label": "CO2", "swipe_down_label": "HINT", "swipe_left_label": "Mineral", "correct": "UP", "weight": 1 },
  { "dataset": "SET_B", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "Rf value?", "hint": "Retention ratio.", "explanation": "‚úÖ Solute Dist / Solvent Dist.", "swipe_up_label": "Solute/Solv", "swipe_right_label": "Mass", "swipe_down_label": "HINT", "swipe_left_label": "Solv/Solute", "correct": "UP", "weight": 2 },
  { "dataset": "SET_B", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Drink Preservative?", "hint": "Microbial inhibitor.", "explanation": "‚úÖ Sodium Benzoate.", "swipe_up_label": "Glucose", "swipe_right_label": "Benzoate", "swipe_down_label": "HINT", "swipe_left_label": "Salt", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_B", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "Soil pH?", "hint": "Ion solubility.", "explanation": "‚úÖ Nutrient Access.", "swipe_up_label": "Moist", "swipe_right_label": "Nutrient", "swipe_down_label": "HINT", "swipe_left_label": "Dense", "correct": "UP", "weight": 2 },
  { "dataset": "SET_B", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Blank sample?", "hint": "Baseline correction.", "explanation": "‚úÖ Zeroing instrument.", "swipe_up_label": "Zeroing", "swipe_right_label": "Color", "swipe_down_label": "HINT", "swipe_left_label": "Calib", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Mixed", "q_type": "CONCEPT", "question_text": "SN2 Favored by?", "hint": "Concerted mechanism.", "explanation": "‚úÖ Primary + Aprotic.", "swipe_up_label": "Pri+Aprotic", "swipe_right_label": "Protic", "swipe_down_label": "HINT", "swipe_left_label": "Tertiary", "correct": "UP", "weight": 1 },
  { "dataset": "SET_A", "topic": "Mixed", "q_type": "APPLICATION", "question_text": "Non-spontaneous T?", "hint": "Entropy driven.", "explanation": "‚úÖ High T (>500K).", "swipe_up_label": "500K", "swipe_right_label": "100K", "swipe_down_label": "HINT", "swipe_left_label": "250K", "correct": "UP", "weight": 2 },
  { "dataset": "SET_B", "topic": "Mixed", "q_type": "CONCEPT", "question_text": "Pool pH fix?", "hint": "Alkalinity adjustment.", "explanation": "‚úÖ Soda Ash.", "swipe_up_label": "Soda Ash", "swipe_right_label": "Salt", "swipe_down_label": "HINT", "swipe_left_label": "Acid", "correct": "UP", "weight": 1 },
  { "dataset": "SET_B", "topic": "Mixed", "q_type": "APPLICATION", "question_text": "Limestone in furnace?", "hint": "Silica removal.", "explanation": "‚úÖ Flux.", "swipe_up_label": "Flux", "swipe_right_label": "Fuel", "swipe_down_label": "HINT", "swipe_left_label": "Reduce", "correct": "UP", "weight": 2 },
  { "dataset": "SET_D", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Rate vs Temp?", "hint": "Boltzmann distribution.", "explanation": "‚úÖ Increases (Exceed Ea).", "swipe_up_label": "Collide", "swipe_right_label": "Exceed Ea", "swipe_down_label": "HINT", "swipe_left_label": "Ea drop", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Physical", "q_type": "APPLICATION", "question_text": "dG at Equilibrium?", "hint": "Free energy minimum.", "explanation": "‚úÖ dG = 0.", "swipe_up_label": "Neg", "swipe_right_label": "Zero", "swipe_down_label": "HINT", "swipe_left_label": "Pos", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Melting Entropy?", "hint": "Phase freedom.", "explanation": "‚úÖ Increases.", "swipe_up_label": "Drop", "swipe_right_label": "Increase", "swipe_down_label": "HINT", "swipe_left_label": "Same", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Physical", "q_type": "APPLICATION", "question_text": "Catalyst & K?", "hint": "Position invariance.", "explanation": "‚úÖ No effect.", "swipe_up_label": "dH", "swipe_right_label": "Kinetics", "swipe_down_label": "HINT", "swipe_left_label": "Prod", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_D", "topic": "Physical", "q_type": "CONCEPT", "question_text": "Pressure & Moles?", "hint": "Volume reduction.", "explanation": "‚úÖ Shifts to fewer moles.", "swipe_up_label": "Vol", "swipe_right_label": "Stress", "swipe_down_label": "HINT", "swipe_left_label": "Rate", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Tertiary Cation?", "hint": "Charge delocalization.", "explanation": "‚úÖ Most stable.", "swipe_up_label": "Mass", "swipe_right_label": "Stable", "swipe_down_label": "HINT", "swipe_left_label": "Steric", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Tertiary SN2?", "hint": "Backside inaccess.", "explanation": "‚úÖ Impossible (Steric).", "swipe_up_label": "Unstable", "swipe_right_label": "Block", "swipe_down_label": "HINT", "swipe_left_label": "Nuc", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_D", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Aldehyde vs Ketone?", "hint": "Nucleophilic attack.", "explanation": "‚úÖ Aldehyde more reactive.", "swipe_up_label": "C=O", "swipe_right_label": "Less Hind", "swipe_down_label": "HINT", "swipe_left_label": "Res", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Organic", "q_type": "APPLICATION", "question_text": "Conjugation UV?", "hint": "Pi-system overlap.", "explanation": "‚úÖ Red shift (Lower Gap).", "swipe_up_label": "Bond", "swipe_right_label": "Low Gap", "swipe_down_label": "HINT", "swipe_left_label": "Mass", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_D", "topic": "Organic", "q_type": "CONCEPT", "question_text": "Phenol Acidic?", "hint": "Anion stability.", "explanation": "‚úÖ Yes, stabilized ion.", "swipe_up_label": "Mass", "swipe_right_label": "Resonance", "swipe_down_label": "HINT", "swipe_left_label": "H-Bond", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Variable Oxidation?", "hint": "Subshell proximity.", "explanation": "‚úÖ Energy match.", "swipe_up_label": "EN", "swipe_right_label": "Energy", "swipe_down_label": "HINT", "swipe_left_label": "Rad", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "Strong Field?", "hint": "Energy cost.", "explanation": "‚úÖ Large Gap (Low Spin).", "swipe_up_label": "Coord", "swipe_right_label": "Large D", "swipe_down_label": "HINT", "swipe_left_label": "Weak", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_D", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Zn2+ Magnetism?", "hint": "Electron pairing.", "explanation": "‚úÖ Diamagnetic.", "swipe_up_label": "Ox", "swipe_right_label": "Paired", "swipe_down_label": "HINT", "swipe_left_label": "Field", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_D", "topic": "Inorganic", "q_type": "APPLICATION", "question_text": "BF3 Acid?", "hint": "Electron deficiency.", "explanation": "‚úÖ Electron acceptor.", "swipe_up_label": "EN", "swipe_right_label": "Octet", "swipe_down_label": "HINT", "swipe_left_label": "Polar", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_D", "topic": "Inorganic", "q_type": "CONCEPT", "question_text": "Lattice Energy?", "hint": "Ionic attraction.", "explanation": "‚úÖ Higher charge = Higher energy.", "swipe_up_label": "Size", "swipe_right_label": "Charge", "swipe_down_label": "HINT", "swipe_left_label": "Cov", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "NMR Multiplicity?", "hint": "Spin coupling.", "explanation": "‚úÖ Formula.", "swipe_up_label": "n+1", "swipe_right_label": "2nI+1", "swipe_down_label": "HINT", "swipe_left_label": "nI+1", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Aldehyde Proton?", "hint": "Magnetic environment.", "explanation": "‚úÖ 9-10 ppm.", "swipe_up_label": "H-Bond", "swipe_right_label": "Aniso", "swipe_down_label": "HINT", "swipe_left_label": "Shield", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "Conjugation IR?", "hint": "Bond weakening.", "explanation": "‚úÖ Lowers frequency.", "swipe_up_label": "Dipole", "swipe_right_label": "Order", "swipe_down_label": "HINT", "swipe_left_label": "Steric", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Homonuclear IR?", "hint": "Symmetry selection.", "explanation": "‚úÖ No dipole change.", "swipe_up_label": "Bond", "swipe_right_label": "Dipole", "swipe_down_label": "HINT", "swipe_left_label": "Sym", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "MS 3:1 ratio?", "hint": "Natural abundance.", "explanation": "‚úÖ Chlorine.", "swipe_up_label": "Br", "swipe_right_label": "Cl", "swipe_down_label": "HINT", "swipe_left_label": "S", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Base Peak?", "hint": "Fragment stability.", "explanation": "‚úÖ Most abundant.", "swipe_up_label": "Mol", "swipe_right_label": "Stable", "swipe_down_label": "HINT", "swipe_left_label": "m/z", "correct": "RIGHT", "weight": 1 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "Weak Acid pH?", "hint": "Anion hydrolysis.", "explanation": "‚úÖ > 7.", "swipe_up_label": "Ppt", "swipe_right_label": "Hydro", "swipe_down_label": "HINT", "swipe_left_label": "Err", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "CONCEPT", "question_text": "Van Deemter High V?", "hint": "Equilibration time.", "explanation": "‚úÖ C-term.", "swipe_up_label": "A", "swipe_right_label": "C", "swipe_down_label": "HINT", "swipe_left_label": "B", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "Larmor Freq?", "hint": "Precession rate.", "explanation": "‚úÖ Prop to B0.", "swipe_up_label": "e-", "swipe_right_label": "B0", "swipe_down_label": "HINT", "swipe_left_label": "T", "correct": "RIGHT", "weight": 2 },
  { "dataset": "SET_C", "topic": "Analytical", "q_type": "APPLICATION", "question_text": "Faraday Constant?", "hint": "Electrolytic stoichiometry.", "explanation": "‚úÖ Charge per mole e-.", "swipe_up_label": "V", "swipe_right_label": "Moles", "swipe_down_label": "HINT", "swipe_left_label": "pH", "correct": "RIGHT", "weight": 2 }
];

let RAW_DATA = [...BACKUP_DATA], POOL=[], MISTAKES=[], SCORE=0, isTransitioning=false;
let MODE="DATASET_SELECT", CURRENT_DATASET="", CURRENT_TOPIC="", CURRENT_GENRE="";
const CLAMP_DIST = 32; const OPACITY_DIST = 24; 
const formatChem = t => { if(!t) return ""; return t.toString().replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>').replace(/(\d*)([+\-])/g, '<sup>$1$2</sup>').replace(/\|\|/g, '<br><br>'); };

async function init(){
    const l = document.getElementById('loader');
    // Try cloud sync, default to backup
    try {
        const r = await fetch(ENDPOINT);
        const json = await r.json();
        if(Array.isArray(json) && json.length > 0) RAW_DATA = json; 
    } catch(e) { console.log("Offline mode active"); }

    // Start with Menu
    setTimeout(() => { 
        l.remove(); 
        renderDatasetSelect(); 
    }, 1000);
}

function attemptAutoStart(topic, genre){
    const cleanD = (CURRENT_DATASET||"").trim().toUpperCase();
    POOL = RAW_DATA.filter(q => (q.dataset||"").toUpperCase() === cleanD || (q.dataset||"") === "").sort(() => Math.random() - .5);
    if(POOL.length > 0) { CURRENT_TOPIC = topic; CURRENT_GENRE = genre; renderNext(); return true; }
    return false;
}

function renderDatasetSelect(){
    MODE="DATASET_SELECT"; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">SELECT CURRICULUM</div>
        <div class="swipe-label sl-up">CORE CHEMISTRY</div><div class="swipe-label sl-left">INDUSTRIAL APPS</div>
        <div class="swipe-label sl-right">REVISION SET</div><div class="swipe-label sl-down">EXPERT CHALLENGE</div>`;
    s.appendChild(c); bindPhysics(c);
}

function renderTopicSelect(dataset){
    MODE="TOPIC_SELECT"; CURRENT_DATASET=dataset; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">CHOOSE DOMAIN</div>
        <div class="swipe-label sl-up">PHYSICAL</div><div class="swipe-label sl-left">ORGANIC</div>
        <div class="swipe-label sl-right">INORGANIC</div><div class="swipe-label sl-down">ANALYTICAL</div>`;
    s.appendChild(c); bindPhysics(c);
}

function renderGenreSelect(topic){
    MODE="GENRE_SELECT"; CURRENT_TOPIC=topic; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">SELECT DEPTH</div>
        <div class="swipe-label sl-up">CONCEPT MASTERY</div>
        <div class="swipe-label sl-down">APPLIED PROBLEMS</div>`;
    s.appendChild(c); bindPhysics(c);
}

function startQuiz(topic, genre){
    if(!attemptAutoStart(topic, genre)) { alert("No questions found."); renderDatasetSelect(); }
}

function renderNext(){
    const s=document.getElementById('stack'); s.innerHTML="";
    if(!POOL.length){ renderEnd(); return; }
    MODE="QUIZ"; const q = POOL.shift();
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`<div class="card-q">${formatChem(q.question_text)}</div>
        <div class="swipe-label sl-up">${q.swipe_up_label}</div><div class="swipe-label sl-left">${q.swipe_left_label}</div>
        <div class="swipe-label sl-right">${q.swipe_right_label}</div><div class="swipe-label sl-down sl-down-hint">üí° ${formatChem(q.hint)}</div>`;
    s.appendChild(c); bindPhysics(c, q);
}

function renderEnd(){
    MODE="SESSION_END"; const s=document.getElementById('stack'); s.innerHTML="";
    const c=document.createElement('div'); c.className="card";
    c.innerHTML=`
        <div class="card-q" style="font-size:1.5rem">SESSION COMPLETE<br><span style="color:var(--accent-gold); font-size:3rem">${SCORE} XP</span></div>
        <div style="width:100%; margin-top:20px;">
            <button class="btn btn-review" onclick="renderAnalysis()">REVIEW MISTAKES</button>
            <input type="text" id="student-name" class="input-name" placeholder="ENTER YOUR NAME" style="margin-top:15px;">
            <button class="btn btn-save" onclick="submitData()">UPLOAD RESULTS</button>
            <div id="status-msg"></div>
            <button class="btn" style="background:transparent; border:1px solid #333; color:#666; margin-top:15px; padding:15px; font-size:0.8rem;" onclick="location.reload()">RESTART APP</button>
        </div>`;
    s.appendChild(c);
}

function renderAnalysis() {
  const container = document.getElementById('analysis-content');
  container.innerHTML = "";
  if(MISTAKES.length === 0) {
     container.innerHTML = "<div style='padding:20px; text-align:center; color:#666;'>PERFECT SCORE!<br>No analysis needed.</div>";
  } else {
     MISTAKES.forEach((q, i) => {
        let html = `
        <div class="mistake-card">
           <div class="mistake-q">Q: ${formatChem(q.question_text)}</div>
           <div class="mistake-ans">Correct Answer: ${q.correct}</div>
           <div class="mistake-exp">üìù ${formatChem(q.explanation)}</div>
        </div>`;
        container.innerHTML += html;
     });
  }
  document.getElementById('analysis-modal').classList.add('active');
}

async function submitData(){
    const name = document.getElementById('student-name').value;
    const btn = document.querySelector('.btn-save');
    const msg = document.getElementById('status-msg');
    
    if(!name) { msg.innerText = "Please enter a name first."; msg.style.color="red"; return; }
    
    btn.innerText = "UPLOADING...";
    btn.disabled = true;

    const payload = {
        name: name,
        score: SCORE,
        topic: CURRENT_TOPIC,
        mode: CURRENT_GENRE,
        total: SCORE + MISTAKES.length,
        mistakes: MISTAKES.map(m => m.question_text).join(" | ")
    };

    try {
        await fetch(ENDPOINT, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        msg.innerText = "SUCCESS! DATA SAVED.";
        msg.style.color = "#00ff00";
        btn.innerText = "SAVED";
    } catch(e) {
        msg.innerText = "UPLOAD FAILED. CHECK INTERNET.";
        msg.style.color = "red";
        btn.disabled = false;
        btn.innerText = "RETRY";
    }
}

function bindPhysics(el, data){
    let x=0, y=0, sx=0, sy=0, active=false, triggerDir=null;
    const labels={up:el.querySelector('.sl-up'), dn:el.querySelector('.sl-down'), lt:el.querySelector('.sl-left'), rt:el.querySelector('.sl-right')};
    const start=e=>{ if(isTransitioning) return; active=true; const p=e.touches?e.touches[0]:e; sx=p.clientX; sy=p.clientY; el.style.transition="none"; };
    const move=e=>{
        if(!active)return; const p=e.touches?e.touches[0]:e;
        const rawDx = p.clientX - sx; const rawDy = p.clientY - sy; const rawDist = Math.sqrt(rawDx*rawDx + rawDy*rawDy);
        const opacity = Math.min(rawDist / OPACITY_DIST, 1);
        let clampedDx = rawDx, clampedDy = rawDy;
        if(rawDist > CLAMP_DIST){ const ratio = CLAMP_DIST / rawDist; clampedDx = rawDx * ratio; clampedDy = rawDy * ratio; }
        let ang = Math.atan2(-clampedDy, clampedDx)*(180/Math.PI); if(ang<0) ang+=360;
        let activeLabel = null; Object.values(labels).forEach(l=>{if(l)l.style.opacity=0;});
        if(rawDist > 5){
            if(ang>=45&&ang<135) activeLabel=labels.up; else if(ang>=135&&ang<225) activeLabel=labels.lt;
            else if(ang>=225&&ang<315) activeLabel=labels.dn; else activeLabel=labels.rt;
        }
        if(activeLabel){ activeLabel.style.opacity = opacity; activeLabel.style.transform = `scale(${0.85 + (opacity * 0.15)})`; }
        x = clampedDx; y = clampedDy; requestAnimationFrame(()=>{ el.style.transform=`translate3d(${x}px,${y}px,0) rotate(${x/25}deg)`; });
        if(rawDist >= CLAMP_DIST) triggerDir = (ang>=45&&ang<135)?"UP":(ang>=135&&ang<225)?"LEFT":(ang>=225&&ang<315)?"DOWN":"RIGHT"; else triggerDir = null;
    };
    const end=()=>{
        if(!active)return; active=false;
        if(triggerDir){
            if(MODE==="QUIZ" && triggerDir==="DOWN"){ 
                el.style.transition="transform .3s"; 
                el.style.transform="translate3d(0,0,0) rotate(0deg)"; 
            }
            else {
                handleAction(el, data, x, y, triggerDir);
            }
        } else { el.style.transition="transform .2s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; el.style.transform="translate3d(0,0,0) rotate(0deg)"; }
        Object.values(labels).forEach(l=>{if(l)l.style.opacity=0;});
    };
    el.onmousedown=start; window.onmousemove=move; window.onmouseup=end; el.ontouchstart=start; el.ontouchmove=move; el.ontouchend=end;
}

function handleAction(el, data, x, y, dir){
    isTransitioning=true;
    if(MODE==="QUIZ"){ 
        const w=parseInt(data.weight)||1; 
        if(dir===data.correct.toUpperCase()){ 
            SCORE+=(10*w); 
        } 
        else { 
            SCORE=Math.max(0, SCORE-5); MISTAKES.push(data); 
        }
        // Always move to next card instantly (No popup)
        renderNext();
    }
    else if(MODE==="DATASET_SELECT"){ const map={UP:"SET_A", LEFT:"SET_B", RIGHT:"SET_C", DOWN:"SET_D"}; renderTopicSelect(map[dir]); }
    else if(MODE==="TOPIC_SELECT"){ const map={UP:"Physical", LEFT:"Organic", RIGHT:"Inorganic", DOWN:"Analytical"}; renderGenreSelect(map[dir]); }
    else if(MODE==="GENRE_SELECT"){ 
        if(dir==="UP") startQuiz(CURRENT_TOPIC, "CONCEPT"); 
        else if(dir==="DOWN") startQuiz(CURRENT_TOPIC, "APPLICATION"); 
        else { isTransitioning=false; return; }
    }
    else if(MODE==="SESSION_END"){ 
        if(dir==="UP") location.reload();
    }
    el.style.transition="transform .4s ease-in"; 
    el.style.transform=`translate3d(${x*6}px,${y*6}px,0) rotate(${x/5}deg)`;
    updateUI(); 
    setTimeout(()=>{el.remove(); isTransitioning=false;}, 350);
}
function updateUI(){ document.getElementById('xp-ui').innerText=`${SCORE} XP`; document.getElementById('progress-bar').style.width=`${(SCORE%100)}%`; }
window.onload=init;
</script>
</body>
</html>
