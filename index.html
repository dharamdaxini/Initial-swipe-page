<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist V81.30 - Vertical Rift</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
<style>
/* --- LOCKED TO V81.4 UI ENGINE --- */
:root { --bg: #000; --card: #111; --gold: #ffd600; --blue: #3498db; --serif: 'Libre Baskerville', serif; --ui: 'Outfit', sans-serif; --code: 'JetBrains Mono', monospace; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; height: 100vh; background: var(--bg); color: #fff; font-family: var(--ui); overflow: hidden; touch-action: none; }

#header { width: 90%; margin: calc(20px + env(safe-area-inset-top)) auto 0; z-index: 100; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--code); font-size: 0.75rem; color: #555; margin-bottom: 8px; }
.progress-track { width: 100%; height: 4px; background: #222; border-radius: 2px; overflow: hidden; }
#progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.4s ease; }

#stack { position: relative; width: 92%; max-width: 400px; height: calc(100vh - 180px - env(safe-area-inset-top)); margin: 25px auto 0; perspective: 1200px; }
.card { position: absolute; width: 100%; height: 100%; background: var(--card); border-radius: 40px; border: 1px solid #282828; padding: 30px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 20px 60px rgba(0,0,0,0.9); transform-origin: center center; will-change: transform; z-index: 1; }

/* THE QUESTION TEXT - WILL MOVE +Y */
.card-q { font-family: var(--serif); font-size: clamp(1.2rem, 4.5vw, 1.7rem); line-height: 1.4; font-weight: 700; text-align: center; color: #f0f0f0; pointer-events: none; transition: transform 0.2s ease-out; will-change: transform; }

/* FLOATING INTERACTION LAYER */
.swipe-label { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: transparent; color: #fff; font-weight: 900; font-size: 1.8rem; text-transform: uppercase; border-radius: 40px; z-index: 2000; text-align: center; padding: 20px; will-change: transform, opacity; pointer-events: none; }

/* DOWN-SWIPE COMPONENTS */
.sl-dn { flex-direction: column !important; justify-content: center !important; }
.sl-down-emoji { font-size: 4.5rem; display: none; transition: filter 0.1s, transform 0.2s ease-out; will-change: filter, transform; margin-top: 20px; }

/* CONTEXT REVEAL */
.context-wrap { width: 100%; padding: 0 15px; opacity: 0; transform: translateY(0); transition: opacity 0.4s ease; position: absolute; top: 50%; left: 0; transform: translateY(-50%); }
.context-wrap.active { opacity: 1; }

.study-header { font-size: 0.75rem; color: var(--gold); font-family: var(--code); margin-bottom: 12px; letter-spacing: 2px; font-weight: 900; text-align: center; }
.bullet-list { list-style: none; padding: 0; margin: 0; text-align: left; }
.bullet-item { font-size: 1.15rem; line-height: 1.6; color: #eee; font-family: var(--serif); margin-bottom: 12px; position: relative; padding-left: 25px; }
.bullet-item::before { content: "â€¢"; position: absolute; left: 0; color: var(--gold); font-size: 1.4rem; }

#loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; letter-spacing: 4px; color: var(--gold); }
sub { font-size: 0.7em; vertical-align: sub; line-height: 0; }
sup { font-size: 0.7em; vertical-align: super; line-height: 0; }
</style>
</head>
<body>

<div id="loader">ALCHEMIST V81.30</div>
<div id="header">
    <div class="header-meta"><span>RANK: NOVICE</span><span id="xp-ui">0 XP</span></div>
    <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
    <div id="sl-up" class="swipe-label" style="background: rgba(0,0,0,0.95);">UP</div>
    <div id="sl-lt" class="swipe-label" style="background: rgba(0,0,0,0.95);">LEFT</div>
    <div id="sl-rt" class="swipe-label" style="background: rgba(0,0,0,0.95);">RIGHT</div>
    <div id="sl-dn" class="swipe-label">
        <div id="context-mount" class="context-wrap">
            <div class="study-header">CONTEXT</div>
            <ul id="bullet-mount" class="bullet-list"></ul>
        </div>
        <span id="bulb-element" class="sl-down-emoji">ðŸ’¡</span>
    </div>
</div>

<script>
const DATABASE = [
  { "q": "What does a negative Î”G value signify?", "u": "Spontaneous", "r": "Equilibrium", "l": "Non-Spont", "c": "UP", "bullets": ["Naturally rolls down a slope", "Releases potential energy", "Needs no external push"] }
];

let POOL = [], SCORE = 0, isTransitioning = false;
const CLAMP_UI = 32;
const TRIGGER_BULB = 16;   // 0.5 cm
const TRIGGER_RIFT = 32;   // 1.0 cm
const TRIGGER_CONTEXT = 96; // 3.0 cm

const format = t => {
    if(!t) return "";
    return t.toString().replace(/([A-Z][a-z]?)(\d+)/g,'$1<sub>$2</sub>').replace(/(\d*)([+\-])/g, '<sup>$1$2</sup>').replace(/Î”/g, '&Delta;');
};

function init(){ POOL = [...DATABASE]; setTimeout(() => { document.getElementById('loader').remove(); renderNext(); }, 1000); }

function renderNext(){
    const s = document.getElementById('stack');
    const existingCard = s.querySelector('.card'); if(existingCard) existingCard.remove();
    if(!POOL.length){ s.innerHTML = `<div class="card"><div class="card-q">MISSION COMPLETE<br>${SCORE} XP</div><button class="btn" onclick="location.reload()">REPLAY</button></div>`; return; }
    
    const q = POOL.shift();
    const c = document.createElement('div'); c.className = "card";
    c.innerHTML = `<div class="card-q">${format(q.q)}</div>`;
    s.appendChild(c); 
    
    document.getElementById('sl-up').innerText = q.u;
    document.getElementById('sl-lt').innerText = q.l;
    document.getElementById('sl-rt').innerText = q.r;
    document.getElementById('bullet-mount').innerHTML = q.bullets.map(b => `<li class="bullet-item">${format(b)}</li>`).join('');

    bindMainPhysics(c, q);
}

function bindMainPhysics(el, qData){
    let sx=0, sy=0, active=false, dir=null, finalDist=0;
    const labels = { up: document.getElementById('sl-up'), dn: document.getElementById('sl-dn'), lt: document.getElementById('sl-lt'), rt: document.getElementById('sl-rt') };
    const bulb = document.getElementById('bulb-element');
    const wrap = document.getElementById('context-mount');
    const queText = el.querySelector('.card-q');

    const start = e => { if(isTransitioning) return; active=true; const p=e.touches?e.touches[0]:e; sx=p.clientX; sy=p.clientY; el.style.transition="none"; };
    
    const move = e => {
        if(!active) return; const p=e.touches?e.touches[0]:e;
        const dx = p.clientX - sx; const dy = p.clientY - sy;
        finalDist = Math.sqrt(dx*dx + dy*dy);
        let ang = Math.atan2(-dy, dx) * (180 / Math.PI); if(ang<0) ang+=360;
        
        Object.values(labels).forEach(l => { l.style.display = 'none'; l.style.opacity = 0; });

        if(finalDist > 5){
            if(ang>=45&&ang<135) dir="UP"; else if(ang>=135&&ang<225) dir="LEFT"; else if(ang>=225&&ang<315) dir="DOWN"; else dir="RIGHT";
        }

        // --- STATIC ORIGIN LOCK ---
        let cardX = (dir === "DOWN") ? 0 : dx;
        let cardY = (dir === "DOWN") ? 0 : dy;
        el.style.transform = `translate3d(${cardX}px, ${cardY}px, 0) rotate(${dir === "DOWN" ? 0 : dx/25}deg)`;

        // --- VERTICAL RIFT LOGIC ---
        if(dir === "DOWN"){
            labels.dn.style.display = 'flex';
            labels.dn.style.opacity = Math.min(finalDist / 24, 1);

            // Phase 1: Bulb Pops Up at 0.5 cm
            if(finalDist >= TRIGGER_BULB) {
                bulb.style.display = 'block';
            } else {
                bulb.style.display = 'none';
            }

            // Phase 2: Rift Opens at 1.0 cm
            if(finalDist >= TRIGGER_RIFT) {
                // Calculate displacement for text (+Y) and bulb (-Y)
                const riftProg = Math.min((finalDist - TRIGGER_RIFT) / 100, 1);
                queText.style.transform = `translateY(-${riftProg * 140}px)`; // Move Up
                bulb.style.transform = `translateY(${riftProg * 140}px)`;    // Move Down
            } else {
                queText.style.transform = `translateY(0)`;
                bulb.style.transform = `translateY(0)`;
            }

            // Phase 3: Context Appearance
            if(finalDist >= TRIGGER_CONTEXT) {
                wrap.classList.add('active');
                bulb.style.filter = `drop-shadow(0 0 30px var(--gold)) brightness(2)`;
            } else {
                wrap.classList.remove('active');
                bulb.style.filter = 'none';
            }
        } else if(dir) {
            queText.style.transform = `translateY(0)`;
            const target = labels[dir.toLowerCase()];
            if(target) { target.style.display = 'flex'; target.style.opacity = Math.min(finalDist / 24, 1); target.style.transform = `translate3d(${dx}px, ${dy}px, 0)`; }
        }
    };

    const end = () => {
        if(!active) return; active = false;
        if(dir === "DOWN"){
            el.style.transition = "transform .3s"; el.style.transform = "translate(0,0)";
            if(finalDist < TRIGGER_CONTEXT) {
                wrap.classList.remove('active');
                queText.style.transform = `translateY(0)`;
                bulb.style.transform = `translateY(0)`;
            }
        } else if(dir && finalDist >= CLAMP_UI){
            isTransitioning = true;
            el.style.transition = "transform .4s ease-in"; el.style.transform = `translate3d(${dir==="LEFT"?-400:400}px, ${dir==="UP"?-400:400}px, 0)`;
            setTimeout(() => { isTransitioning = false; wrap.classList.remove('active'); renderNext(); updateUI(); }, 300);
        } else { el.style.transition = "transform .2s"; el.style.transform = "translate(0,0) rotate(0deg)"; queText.style.transform = `translateY(0)`; }
        if(finalDist < TRIGGER_CONTEXT) labels.dn.style.display = 'none';
        bulb.style.filter = 'none';
    };
    el.onmousedown=start; window.onmousemove=move; window.onmouseup=end; el.ontouchstart=start; el.ontouchmove=move; el.ontouchend=end;
}
function updateUI(){ document.getElementById('xp-ui').innerText = `${SCORE} XP`; document.getElementById('progress-bar').style.width = `${(SCORE % 100)}%`; }
window.onload = init;
</script>
</body>
</html>
