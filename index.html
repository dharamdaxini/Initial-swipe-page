<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V38.5 Cognitive Engine | Organic Synthesis</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --bg: #000000;
            --card: #ffffff;
            --accent: #2563eb;
            --text-dark: #1a1a1a;
            --gray: #666666;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg); font-family: -apple-system, system-ui, sans-serif;
            overflow: hidden; touch-action: none;
        }

        #app { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

        .view { display: none; position: absolute; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .view.active { display: flex; opacity: 1; }

        /* V38.0 GPU-Accelerated Card */
        .card {
            width: 85%; max-width: 420px; height: 65vh;
            background: var(--card); border-radius: 40px;
            padding: 2.5rem 2rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
            will-change: transform; transform: translate3d(0,0,0);
            transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            user-select: none; position: relative; z-index: 10;
        }

        .card.dragging { transition: none !important; }

        .question-text { font-size: 1.4rem; font-weight: 800; color: var(--text-dark); line-height: 1.25; margin-bottom: 1rem; }

        .options-map { margin-top: 1rem; }
        .option-item { 
            font-size: 1.1rem; margin-bottom: 1rem; color: #333; font-weight: 500;
            display: flex; align-items: center;
        }
        
        /* Progress Indicator */
        #progress-bar { position: absolute; top: 0; left: 0; height: 6px; background: var(--accent); transition: width 0.3s; }

        .hint { position: absolute; bottom: 20px; color: var(--gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; text-align: center; width: 100%; }

        button {
            padding: 1.2rem 3rem; border-radius: 100px; border: none;
            background: var(--accent); color: white; font-weight: 800; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 10px 20px rgba(37,99,235,0.3);
        }

        #view-summary { color: white; text-align: center; padding: 2rem; }
    </style>
</head>
<body>

<div id="app">
    <div id="progress-bar" style="width: 0%"></div>

    <div id="view-start" class="view active">
        <h1 style="color: white; font-size: 2.5rem; margin-bottom: 0.5rem;">V38.5 Master</h1>
        <p style="color: var(--gray); margin-bottom: 2.5rem;">Advanced Organic Synthesis</p>
        <button onclick="APP.start()">INITIALIZE SESSION</button>
    </div>

    <div id="view-game" class="view">
        <div id="main-card" class="card">
            <div id="q-text" class="question-text">Loading...</div>
            <div class="options-map">
                <div id="opt-up" class="option-item"></div>
                <div id="opt-left" class="option-item"></div>
                <div id="opt-right" class="option-item"></div>
            </div>
        </div>
        <div class="hint">↑ 1 | ← 2 | → 3 | ↓ LOGIC MAP</div>
    </div>

    <div id="view-summary" class="view">
        <h2 style="font-size: 2rem;">Mastery Logged</h2>
        <div id="score-report" style="font-size: 1.2rem; color: var(--gray); margin: 1.5rem 0 3rem;"></div>
        <button onclick="location.reload()">NEW ATTEMPT</button>
    </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyC_2v2jzvZQQH088USUZRcWy6uSWX9-FAd5Vuh-lkLdHrYeCKThVoy2sd43AACjMeHQw/exec'; // Replace after deployment

const DECKS = [
    { id: "C01", question: "Synthesis of $t$-butyl methyl ether.", up: "$(CH_3)_3C-Br + CH_3ONa$", left: "$(CH_3)_3CONa + CH_3I$ / $H_2O$", right: "$(CH_3)_3CONa + CH_3I$ / $CH_3CN$", map: "Eliminate Up: 3° halides do E2. Left: Protic solvents slow Sn2." },
    { id: "C02", question: "Friedel-Crafts on Nitrobenzene.", up: "Toluene (High Yield)", left: "$o/p$-mixture", right: "No Reaction", map: "Nitrobenzene is deactivated; F-C requires electron-rich rings." },
    { id: "C03", question: "Terminal Epoxide from Alkyne.", up: "$mCPBA$ on alkyne", left: "$Hg(OAc)_2/H_2O$", right: "1. $H_2/Lindlar$; 2. $mCPBA$", map: "Lindlar reduces alkyne to alkene first." },
    { id: "C04", question: "$S_N2$ of $(S)$-2-bromobutane with $NaN_3$.", up: "$(S)$-azide", left: "$(R)$-azide / $CH_3OH$", right: "$(R)$-azide / $DMSO$", map: "Sn2 requires inversion + Aprotic solvent." },
    { id: "C05", question: "Baeyer-Villiger of Cyclohexanone.", up: "$H_2O_2/NaOH$", left: "Cyclohexanol", right: "Caprolactone / $mCPBA$", map: "mCPBA is the standard BV oxidant." },
    { id: "C06", question: "Birch Reduction of Benzoic Acid.", up: "1,4-product", left: "2,5-product", right: "2,5-dihydro (EWG at $sp^3$)", map: "EWG carbon is reduced in Birch." },
    { id: "C07", question: "Hofmann Rearrangement of Benzamide.", up: "Benzylamine", left: "Aniline / $FeBr_3$", right: "Aniline / $Br_2/NaOH$", map: "Br2/NaOH/H2O are the Hofmann reagents." },
    { id: "C08", question: "Stille Coupling: $R-SnBu_3 + R'-X$.", up: "$Pd$ in $H_2O$", left: "$NiCl_2$ in $THF$", right: "$Pd(PPh_3)_4$ / $DMF$", map: "Stille requires Pd catalyst and anhydrous DMF." },
    { id: "C09", question: "Sharpless Asymmetric Epoxidation.", up: "Ti/DET/$H_2O_2$", left: "$mCPBA$", right: "Ti/DET/$tBuOOH$", map: "tBuOOH is the required oxidant for SAE." },
    { id: "C10", question: "Clemmensen: $p$-acetamidobenzaldehyde.", up: "$Zn(Hg)/HCl$", left: "$NH_2NH_2/KOH$", right: "$HS(CH_2)_2SH$ / Raney Ni", map: "Acid/Base mismatch: HCl/KOH destroy the amide." },
    { id: "C11", question: "Toluene to Benzoic Acid.", up: "Cold $KMnO_4$", left: "$CrO_3/Py$", right: "Hot $KMnO_4/NaOH$", map: "Aggressive hot oxidation required for C-H cleavage." },
    { id: "C12", question: "Wittig: Cyclohexanone + Ylide.", up: "Alkene / $CH_3OH$", left: "Alcohol / Grignard", right: "Alkene / $THF$", map: "THF is the standard aprotic Wittig solvent." },
    { id: "C13", question: "Diels-Alder: Anhydride + Butadiene.", up: "Endo (Slow)", left: "Exo", right: "Endo (Kinetic)", map: "Secondary orbital overlap favors Endo." },
    { id: "C14", question: "Swern Oxidation of $1^\\circ$ Alcohol.", up: "$PCC$", left: "DMSO at $25^\\circ C$", right: "DMSO at $-78^\\circ C$", map: "Swern reagents decompose above -60°C." },
    { id: "C15", question: "Heck: Ph-I + Methyl Acrylate.", up: "Pd / $H_2O$", left: "Pd / No base", right: "Pd / $PPh_3$ / $NEt_3$", map: "Base is critical for Pd(0) regeneration." }
];

const APP = {
    deck: [],
    idx: 0,
    answers: [],
    startX: 0,
    startY: 0,
    isDragging: false,
    startTime: 0,

    shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    },

    start() {
        this.deck = this.shuffle([...DECKS]);
        this.idx = 0;
        this.answers = [];
        this.showView('view-game');
        this.render();
    },

    render() {
        if (this.idx >= this.deck.length) {
            this.complete();
            return;
        }

        const q = this.deck[this.idx];
        const card = document.getElementById('main-card');
        
        card.style.transform = `translate3d(0,0,0)`;
        document.getElementById('q-text').innerHTML = q.question;
        document.getElementById('opt-up').innerHTML = `↑ ${q.up}`;
        document.getElementById('opt-left').innerHTML = `← ${q.left}`;
        document.getElementById('opt-right').innerHTML = `→ ${q.right}`;
        document.getElementById('progress-bar').style.width = `${(this.idx / this.deck.length) * 100}%`;

        renderMathInElement(document.body, { delimiters: [{left: "$", right: "$", display: false}] });
        this.startTime = Date.now();
    },

    handleMove(x, y) {
        if (!this.isDragging) return;
        const diffX = x - this.startX;
        const diffY = y - this.startY;
        document.getElementById('main-card').style.transform = `translate3d(${diffX}px, ${diffY}px, 0)`;
    },

    handleEnd(x, y) {
        this.isDragging = false;
        const card = document.getElementById('main-card');
        card.classList.remove('dragging');
        
        const diffX = x - this.startX;
        const diffY = y - this.startY;
        const threshold = 80;

        if (Math.abs(diffY) > Math.abs(diffX)) {
            if (diffY < -threshold) this.resolve('UP');
            else if (diffY > threshold) this.resolve('DOWN');
            else this.reset();
        } else {
            if (diffX < -threshold) this.resolve('LEFT');
            else if (diffX > threshold) this.resolve('RIGHT');
            else this.reset();
        }
    },

    resolve(dir) {
        if (dir === 'DOWN') {
            alert(`PIVOT LOGIC: ${this.deck[this.idx].map}`);
            this.reset();
        } else {
            this.answers.push({ id: this.deck[this.idx].id, choice: dir, latency: Date.now() - this.startTime });
            this.idx++;
            this.render();
        }
    },

    reset() { document.getElementById('main-card').style.transform = `translate3d(0,0,0)`; },

    showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    async complete() {
        this.showView('view-summary');
        document.getElementById('score-report').innerText = `Session ID: ${Math.random().toString(36).substr(2, 9)} | Samples: ${this.answers.length}`;
        document.getElementById('progress-bar').style.width = `100%`;
        
        if (SCRIPT_URL !== 'https://script.google.com/macros/s/AKfycbyC_2v2jzvZQQH088USUZRcWy6uSWX9-FAd5Vuh-lkLdHrYeCKThVoy2sd43AACjMeHQw/exec') {
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(this.answers) });
        }
    }
};

// Simplified Listeners
const cardElem = document.getElementById('main-card');
cardElem.addEventListener('touchstart', e => { 
    APP.startX = e.touches[0].clientX; APP.startY = e.touches[0].clientY; 
    APP.isDragging = true; cardElem.classList.add('dragging'); 
}, {passive: true});

document.addEventListener('touchmove', e => { if(APP.isDragging) APP.handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive: true});
document.addEventListener('touchend', e => { if(APP.isDragging) APP.handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY); });

</script>
</body>
</html>
