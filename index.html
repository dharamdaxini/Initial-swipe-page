<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Master V65 (Scientific Bonds)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Roboto+Slab:wght@700&family=Crimson+Text:ital,wght@0,600;1,600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1a1a1a;
            --context-bg: #1a2333; 
            --review-bg: #1a0f0f;
            --info-bg: #0d0d0d; 
            --text-main: #ffffff;
            --accent-blue: #2962ff;
            --accent-red: #ff1744;
            --accent-green: #00e676;
            --accent-gold: #ffd600;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --font-chem: 'Crimson Text', serif; 
            --font-num: 'Roboto Slab', serif; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-ui);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- SCIENTIFIC TYPOGRAPHY --- */
        sub { vertical-align: sub; font-size: 0.65em; font-family: var(--font-num); line-height: 0; }
        sup { vertical-align: super; font-size: 0.65em; font-family: var(--font-num); line-height: 0; }
        
        /* Styled Bonds */
        .chem-bond { font-family: var(--font-ui); font-weight: 400; padding: 0 2px; color: #aaa; }

        #header {
            position: absolute; top: 20px; width: 90%;
            display: flex; justify-content: space-between; z-index: 100;
            font-family: var(--font-code); font-size: 0.8rem; color: #888;
        }

        #score-label { color: var(--accent-gold); font-weight: 800; }

        #stack {
            position: relative; width: 100%; max-width: 360px; height: 65vh;
            margin-top: 40px; perspective: 1000px;
        }

        .card {
            position: absolute; width: 100%; height: 100%;
            background: var(--card-bg);
            border-radius: 32px; border: 1px solid #333;
            padding: 30px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            will-change: transform; touch-action: none;
        }

        .card-q { 
            font-family: var(--font-chem); 
            font-size: 1.9rem; 
            font-weight: 600; 
            line-height: 1.4; 
            color: #efefef;
            font-style: italic;
        }

        .info-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--info-bg); padding: 40px 25px;
            display: flex; flex-direction: column; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.2s; z-index: 20;
        }
        .info-overlay.active { opacity: 1; pointer-events: auto; }
        
        .info-text { 
            font-family: var(--font-chem); font-size: 1.25rem; line-height: 1.5; color: #ddd;
            overflow-y: auto; max-height: 70%;
        }

        .btn-next {
            background: #fff; color: #000; border: none; padding: 18px;
            border-radius: 50px; font-weight: 800; font-family: var(--font-ui);
            width: 100%; margin-top: 20px;
        }

        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="header">
        <span>ORG_MASTERY_V65</span>
        <span id="score-label">XP: 0 ⚡</span>
    </div>

    <div id="stack"></div>

    <script>
        const DATA_ENDPOINT = "https://script.google.com/macros/s/AKfycbwrdBKhMeHPpkbZOd_zwFNY5A7FxWji2t11eNnMqXpcAptMAyPewImMG-7O6Ja-ad6Q/exec"; 
        let SCORE = 0;
        let QUESTION_POOL = [];
        let MISTAKE_POOL = [];
        let APP_MODE = 'QUIZ';

        // --- UPGRADED ORGANIC TEXT ENGINE ---
        function formatChem(text) {
            if (!text) return "";
            
            // 1. Handle Subscripts first (Element followed by Number)
            text = text.replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub>$2</sub>');

            // 2. Handle Organic Bonds (Hyphens, Equals, Hashtags for Triple)
            // We use a specific span class for styling
            text = text.replace(/(\s)-(\s|(?=[A-Z]))/g, '<span class="chem-bond"> – </span>'); // Free standing single bond
            text = text.replace(/([A-Za-z0-9\)\]<sub>])-(?=[A-Za-z\(])/g, '$1<span class="chem-bond">–</span>'); // Chain bond
            text = text.replace(/=/g, '<span class="chem-bond">═</span>'); // Double
            text = text.replace(/#/g, '<span class="chem-bond">≡</span>'); // Triple

            // 3. Handle Terminal Radical Bonds (e.g., CH3-)
            // Prevents it from being turned into a superscript minus
            text = text.replace(/([A-Za-z0-9\)\]<sub>])-(?=\s|$|[.,;\]\|])/g, '$1<span class="chem-bond">–</span>');

            // 4. Handle Ions/Charges (Only if not a bond)
            // Matches number + sign (2+) or single terminal sign (+)
            text = text.replace(/(\d+)([+\-])/g, '<sup>$1$2</sup>'); 
            text = text.replace(/([A-Za-z\)\]])([+\-])(?=\s|$|[.,;\]\|])/g, (match, p1, p2) => {
                // If it was already processed as a bond, ignore
                if (match.includes('chem-bond')) return match;
                return p1 + '<sup>' + p2 + '</sup>';
            });

            return text;
        }

        async function loadQuestions() {
            try {
                const res = await fetch(DATA_ENDPOINT);
                const all = await res.json();
                QUESTION_POOL = all.filter(q => q.deck === "Chemistry_Master_1").sort(() => Math.random() - 0.5);
                document.getElementById('loader').style.display = 'none';
                spawnCard();
            } catch (e) { console.error(e); }
        }

        function spawnCard(forcedData = null) {
            const data = forcedData || nextQuestion();
            if(!data) return;
            const el = document.createElement('div');
            el.className = 'card';
            
            let infoLabel = (APP_MODE === 'QUIZ') ? "HINT" : "DEEP DIVE";
            let infoContent = data.explanation;

            if (data.explanation.includes('||')) {
                const parts = data.explanation.split('||');
                infoContent = (APP_MODE === 'QUIZ') ? parts[0].replace(/✅|❌/g, '') : '<ul>' + parts.map(p => `<li>${formatChem(p.trim())}</li>`).join('') + '</ul>';
            }

            el.innerHTML = `
                <div class="card-q">${formatChem(data.text)}</div>
                <div class="info-overlay">
                    <div style="font-family:var(--font-code); color:var(--accent-blue); margin-bottom:10px">${infoLabel}</div>
                    <div class="info-text">${formatChem(infoContent)}</div>
                    <button class="btn-next" onclick="closeInfo()">GOT IT</button>
                </div>
            `;
            document.getElementById('stack').appendChild(el);
            new Draggable(el, data);
        }

        function nextQuestion() {
            if (QUESTION_POOL.length === 0) return null;
            const q = QUESTION_POOL.shift();
            return {
                id: q.question_id, text: q.question_text, explanation: q.explanation,
                correct: q.correct
            };
        }

        window.closeInfo = () => {
            const card = document.querySelector('.card');
            card.style.transition = '0.3s ease-in';
            card.style.transform = 'translateY(1000px)';
            setTimeout(() => { card.remove(); spawnCard(); }, 200);
        };

        class Draggable {
            constructor(el, data) {
                this.el = el; this.data = data;
                this.el.addEventListener('touchstart', (e) => {
                    this.startY = e.touches[0].clientY;
                    this.startX = e.touches[0].clientX;
                });
                this.el.addEventListener('touchmove', (e) => {
                    const dy = e.touches[0].clientY - this.startY;
                    const dx = e.touches[0].clientX - this.startX;
                    const moveX = Math.abs(dx) > Math.abs(dy) ? Math.max(-120, Math.min(120, dx)) : 0;
                    const moveY = Math.abs(dy) > Math.abs(dx) ? Math.max(-120, Math.min(120, dy)) : 0;
                    this.el.style.transform = `translate(${moveX}px, ${moveY}px)`;
                });
                this.el.addEventListener('touchend', (e) => {
                    const dy = e.changedTouches[0].clientY - this.startY;
                    if (dy > 80) { this.el.style.transform = 'none'; this.el.querySelector('.info-overlay').classList.add('active'); }
                    else {
                        const dx = e.changedTouches[0].clientX - this.startX;
                        if (Math.abs(dx) > 80) {
                            this.el.style.transition = '0.3s';
                            this.el.style.transform = `translateX(${dx * 5}px)`;
                            setTimeout(() => { this.el.remove(); spawnCard(); }, 200);
                        } else { this.el.style.transform = 'none'; }
                    }
                });
            }
        }

        window.onload = loadQuestions;
    </script>
</body>
</html>
