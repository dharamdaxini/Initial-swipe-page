<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Strategic Convergence 2026</title>

    <style>
        /* 1. ASSETS */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;600;800;900&display=swap');

        /* 2. TOKENS */
        :root {
            --bg-void: #020617;
            --bg-glass: rgba(30, 41, 59, 0.8);
            --bg-card: #ffffff;
            
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-card: #0f172a;
            --text-accent: #38bdf8;

            /* Signals */
            --signal-up: #22c55e;
            --signal-down: #ef4444;
            --signal-left: #64748b;
            --signal-right: #eab308;

            /* Chart Colors */
            --chart-1: #3b82f6; --chart-2: #8b5cf6; --chart-3: #ec4899;

            --card-w: 90vw;
            --card-max-w: 380px;
        }

        /* 3. RESET */
        *, *::before, *::after {
            box-sizing: border-box; margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: none; user-select: none;
        }

        body {
            background-color: var(--bg-void);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            height: 100svh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* 4. APP SHELL */
        #app-shell {
            position: relative;
            width: 100%; height: 100%;
            max-width: 450px;
            background: var(--bg-void);
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        #ui-overlay {
            position: absolute; inset: 0;
            background: transparent; opacity: 0;
            transition: opacity 0.1s; pointer-events: none; z-index: 1;
        }

        /* 5. HEADER */
        .header {
            height: 15%;
            display: flex; flex-direction: column;
            justify-content: flex-end; align-items: center;
            padding-bottom: 1rem;
            z-index: 50;
        }

        .progress-track {
            width: 40%; height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px; margin-bottom: 1rem; overflow: hidden;
        }
        .progress-fill { height: 100%; background: var(--text-accent); width: 0%; transition: width 0.3s; }

        .meta-tag {
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
            color: var(--text-secondary); margin-bottom: 0.25rem;
            background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px;
        }
        .meta-title { font-size: 1.1rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-primary); }

        /* 6. GAME CARD STACK */
        .stage {
            position: relative;
            flex: 1; width: 100%;
            perspective: 1000px;
            z-index: 10;
        }

        .card {
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            width: var(--card-w); max-width: var(--card-max-w);
            aspect-ratio: 3/4;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 2rem; text-align: center;
            will-change: transform;
            transform-style: flat;
        }

        .card p {
            font-size: 1.3rem; font-weight: 700;
            color: var(--text-card); line-height: 1.35;
            pointer-events: none; margin-bottom: 1rem;
        }

        .card-sub {
            font-size: 0.9rem; color: #64748b; font-weight: 500;
            line-height: 1.5; padding-top: 1rem;
            border-top: 1px solid #e2e8f0; width: 80%;
            pointer-events: none;
        }

        .card-id {
            position: absolute; bottom: 1.5rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
            color: #cbd5e1; pointer-events: none;
        }

        /* 7. FOOTER */
        .footer {
            height: 20%;
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            grid-template-rows: 1fr 1fr;
            align-content: center; justify-items: center;
            z-index: 50;
        }

        .ctrl {
            display: flex; flex-direction: column; align-items: center;
            color: rgba(255,255,255,0.25); transition: 0.1s;
        }
        .ctrl.active { color: #fff; transform: scale(1.2); text-shadow: 0 0 10px currentColor; }
        
        .ctrl.up { grid-column: 2; grid-row: 1; }
        .ctrl.down { grid-column: 2; grid-row: 2; margin-top: 0.5rem; }
        .ctrl.left { grid-column: 1; grid-row: 2; }
        .ctrl.right { grid-column: 3; grid-row: 2; }

        .icon { font-size: 1.8rem; line-height: 1; margin-bottom: 2px; }
        .label { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; }

        /* 8. VIEWS & BUTTONS */
        .view {
            position: absolute; inset: 0;
            background: var(--bg-void); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .view.active { opacity: 1; pointer-events: auto; }

        .btn-main {
            background: var(--text-accent); color: #0f172a; border: none;
            padding: 1rem 3rem; font-size: 1rem; font-weight: 800;
            border-radius: 100px; cursor: pointer;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            margin-top: 1rem;
        }

        /* NEW: Topic Selection Buttons */
        .topic-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
            width: 90%; max-width: 360px; margin-top: 1rem;
        }

        .btn-topic {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 1rem; border-radius: 16px;
            text-align: left; cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-topic:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .btn-topic strong { display: block; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .btn-topic span { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }

        /* 9. CHART STYLES */
        .chart-container {
            position: relative;
            width: 140px; height: 140px;
            border-radius: 50%;
            background: conic-gradient(var(--text-secondary) 0% 100%);
            margin-bottom: 1.5rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .chart-hole {
            position: absolute; inset: 15px; /* Donut thickness */
            background: var(--bg-void);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }

        /* 10. REVIEW MODE STYLES */
        #view-review .review-card {
            background: #fff;
            color: #000;
            width: 90%; height: 70%;
            border-radius: 24px; padding: 2rem;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .rev-q-box {
            flex: 1; display: flex; align-items: center; justify-content: center;
            text-align: center; border-bottom: 2px dashed #e2e8f0; margin-bottom: 1rem;
        }
        
        .rev-q-text { font-size: 1.2rem; font-weight: 700; color: #1e293b; }
        .rev-a-box { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .rev-badge { align-self: flex-start; background: #dcfce7; color: #166534; font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 4px; margin-bottom: 0.5rem; }
        .rev-sol { font-size: 1rem; color: #334155; line-height: 1.5; }
        .rev-nav { display: flex; justify-content: space-between; align-items: center; width: 90%; margin-top: 1.5rem; }
        .rev-count { color: var(--text-secondary); font-family: 'JetBrains Mono'; font-size: 0.8rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="app-shell">
        <div id="ui-overlay"></div>

        <section id="view-start" class="view active">
            <div style="color:var(--text-accent); border:1px solid var(--text-accent); padding:4px 8px; border-radius:4px; font-family:'JetBrains Mono'; font-size:0.7rem; margin-bottom:1rem;">CHEMISTRY MODULE V6.0</div>
            <h1 style="font-size:3rem; font-weight:900; line-height:0.9; text-align:center; margin-bottom:1rem;">CORE<br>CONCEPTS</h1>
            <p style="color:var(--text-secondary); margin-bottom:3rem; text-align:center;">Atoms • Bonds • Solutions</p>
            <button class="btn-main" onclick="APP.start('CORE')">BEGIN ANALYSIS</button>
        </section>

        <section id="view-game" class="view" style="background:transparent;">
            <header class="header">
                <div class="progress-track"><div class="progress-fill" id="ui-progress"></div></div>
                <span class="meta-tag" id="ui-topic">TOPIC</span>
                <span class="meta-title" id="ui-type">CONCEPT</span>
            </header>
            <div class="stage" id="card-stack"></div>
            <footer class="footer">
                <div class="ctrl up"><span class="icon">↑</span><span class="label" id="lbl-up">True</span></div>
                <div class="ctrl left"><span class="icon">←</span><span class="label" id="lbl-left">Skip</span></div>
                <div class="ctrl down"><span class="icon">↓</span><span class="label" id="lbl-down">False</span></div>
                <div class="ctrl right"><span class="icon">→</span><span class="label" id="lbl-right">Unsure</span></div>
            </footer>
        </section>

        <section id="view-summary" class="view">
            <h2 style="font-size:1.2rem; margin-bottom:1rem; color:var(--text-secondary);">PERFORMANCE PROFILE</h2>
            
            <div class="chart-container" id="chart-pie">
                <div class="chart-hole">
                    <span style="font-size:2rem; font-weight:800;" id="chart-score">0</span>
                    <span style="font-size:0.6rem; color:#94a3b8;">POINTS</span>
                </div>
            </div>
            
            <p style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:1.5rem;">SELECT MASTERY MODULE</p>
            
            <div class="topic-grid">
                <button class="btn-topic" onclick="APP.start('ATOMS_HARD')">
                    <strong>ATOMIC THEORY</strong>
                    <span>Hard • 5 Qs</span>
                </button>
                <button class="btn-topic" onclick="APP.start('BONDS_HARD')">
                    <strong>BONDING</strong>
                    <span>Hard • 5 Qs</span>
                </button>
                <button class="btn-topic" onclick="APP.start('SOLUTIONS_HARD')">
                    <strong>SOLUTIONS</strong>
                    <span>Hard • 5 Qs</span>
                </button>
                <button class="btn-topic" onclick="location.reload()">
                    <strong>RESTART</strong>
                    <span>Core Level</span>
                </button>
            </div>
            
            <div id="review-cta" class="hidden" style="margin-top:1.5rem;">
                <button class="btn-main" style="background:var(--signal-down); color:#fff; padding:0.8rem 2rem; font-size:0.9rem;" onclick="APP.startReview()">REVIEW MISTAKES</button>
            </div>
        </section>

        <section id="view-review" class="view">
            <div id="review-card-container" class="review-card">
                <div class="rev-q-box"><p class="rev-q-text" id="rev-q"></p></div>
                <div class="rev-a-box">
                    <div class="rev-badge">SOLUTION</div>
                    <p class="rev-sol" id="rev-sol"></p>
                </div>
            </div>
            <div class="rev-nav">
                <span class="rev-count" id="rev-count">1 / 5</span>
                <button class="btn-main" style="margin:0; padding:0.8rem 2rem;" onclick="APP.nextReview()">NEXT</button>
            </div>
        </section>
    </div>

    <script>
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbz_ziu5Dezrz35J2FksQtNEYuZ5Kk6TrQvg3pM5O5eBYUDzWCCtqlGWwZj8D-TBQLFw/exec",
            THRESHOLD: 75,
            COLORS: { UP:'#22c55e', DOWN:'#ef4444', RIGHT:'#eab308', LEFT:'#64748b' },
            CHART_COLORS: {'ATOM':'#3b82f6', 'BOND':'#8b5cf6', 'SOLN':'#ec4899', 'REAC':'#f59e0b', 'TABL':'#10b981'}
        };

        // --- QUESTION BANKS ---
        const DECKS = {
            CORE: [
                { id: "c1", topic: "Structure", type: "ATOM", text: "Protons and Neutrons reside in the nucleus.", sub: "Electrons orbit the outside.", explanation: "Correct. The nucleus contains heavy particles.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:1 },
                { id: "c2", topic: "Charge", type: "ATOM", text: "An electron carries a positive electrical charge.", sub: "Think about protons vs electrons.", explanation: "False. Electrons are Negative.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:1 },
                { id: "c4", topic: "Identity", type: "ATOM", text: "Atomic number equals the number of protons.", sub: "Identity of the element.", explanation: "Correct. Proton count is the DNA of an atom.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:1 },
                { id: "c7", topic: "Mechanics", type: "BOND", text: "Ionic bonds involve sharing electrons.", sub: "Share vs Steal.", explanation: "False. Ionic bonds transfer electrons.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:1 },
                { id: "c8", topic: "Molecules", type: "BOND", text: "Water (H2O) contains covalent bonds.", sub: "Non-metal + Non-metal.", explanation: "Correct. Oxygen shares electrons with Hydrogen.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:1 },
                { id: "c15", topic: "Mixtures", type: "SOLN", text: "In salt water, salt is the solvent.", sub: "Solute vs Solvent.", explanation: "False. Water is the solvent. Salt is the solute.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:1 }
            ],
            ATOMS_HARD: [
                { id: "ah1", topic: "Quantum", type: "ATOM", text: "The 4s orbital fills before the 3d orbital.", sub: "Aufbau Principle.", explanation: "True. 4s has lower energy than 3d.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 },
                { id: "ah2", topic: "Isotopes", type: "ATOM", text: "Isotopes of an element have different numbers of protons.", sub: "Think mass vs identity.", explanation: "False. Isotopes differ in Neutrons, not Protons.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 },
                { id: "ah3", topic: "Config", type: "ATOM", text: "A d-subshell can hold a maximum of 14 electrons.", sub: "s=2, p=6, d=?, f=14.", explanation: "False. d-orbitals hold 10 electrons. f-orbitals hold 14.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 },
                { id: "ah4", topic: "Trends", type: "ATOM", text: "Atomic radius decreases across a period (left to right).", sub: "Nuclear pull increases.", explanation: "True. Stronger nucleus pulls electrons closer.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 },
                { id: "ah5", topic: "Ions", type: "ATOM", text: "Cations are always larger than their parent atoms.", sub: "Losing electrons.", explanation: "False. Cations lose electrons and shrink.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 }
            ],
            BONDS_HARD: [
                { id: "bh1", topic: "VSEPR", type: "BOND", text: "A molecule with sp3 hybridization is always tetrahedral.", sub: "Think about lone pairs (e.g., Water).", explanation: "False. Lone pairs can make it bent (Water) or pyramidal (Ammonia).", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 },
                { id: "bh2", topic: "Polarity", type: "BOND", text: "BF3 is a non-polar molecule despite polar bonds.", sub: "Symmetry cancels dipoles.", explanation: "True. Trigonal planar symmetry cancels the polarity.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 },
                { id: "bh3", topic: "Forces", type: "BOND", text: "Hydrogen bonds are stronger than Covalent bonds.", sub: "Inter vs Intra molecular.", explanation: "False. Covalent bonds (inside molecule) are much stronger than H-bonds (between molecules).", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 },
                { id: "bh4", topic: "Lattice", type: "BOND", text: "MgO has a higher lattice energy than NaCl.", sub: "Charge density (+2 vs +1).", explanation: "True. Mg2+ and O2- have higher charges than Na+ and Cl-.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 },
                { id: "bh5", topic: "Sigma", type: "BOND", text: "A double bond consists of one sigma and one pi bond.", sub: "Overlap types.", explanation: "True. The first is sigma, the second is pi.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 }
            ],
            SOLUTIONS_HARD: [
                { id: "sh1", topic: "Colligative", type: "SOLN", text: "Adding salt to water decreases its boiling point.", sub: "Vapor pressure changes.", explanation: "False. Salt elevates boiling point and depresses freezing point.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 },
                { id: "sh2", topic: "Units", type: "SOLN", text: "Molarity changes with temperature, but Molality does not.", sub: "Volume vs Mass.", explanation: "True. Volume expands with heat (Molarity), mass does not (Molality).", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 },
                { id: "sh3", topic: "Buffers", type: "SOLN", text: "A buffer solution resists changes in pH.", sub: "Weak acid + conjugate base.", explanation: "True. That is the definition of a buffer.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 },
                { id: "sh4", topic: "Solubility", type: "SOLN", text: "Gas solubility in liquid increases as temperature rises.", sub: "Think about warm soda.", explanation: "False. Gases escape warm liquids. Solubility decreases.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"down", w:2 },
                { id: "sh5", topic: "Factor", type: "SOLN", text: "The Van't Hoff factor (i) for CaCl2 is ideally 3.", sub: "How many ions form?", explanation: "True. Ca + Cl + Cl = 3 particles.", up:"True", down:"False", right:"Unsure", left:"Skip", correct:"up", w:2 }
            ]
        };

        const APP = {
            deck: [], idx: 0, answers: {}, activeEl: null,
            reviewDeck: [], reviewIdx: 0,

            start(deckKey) {
                // Load specific deck
                this.deck = [...DECKS[deckKey]]; 
                // Reset state
                this.idx = 0;
                this.answers = {};
                this.reviewDeck = [];
                
                // Transition
                document.getElementById('view-start').classList.remove('active');
                document.getElementById('view-summary').classList.remove('active');
                document.getElementById('view-game').classList.add('active');
                
                // Hide Review button
                document.getElementById('review-cta').classList.add('hidden');
                
                this.render();
            },

            render() {
                const stack = document.getElementById('card-stack');
                stack.innerHTML = '';
                if(this.idx >= this.deck.length) return this.finish();

                const buffer = this.deck.slice(this.idx, this.idx+2).reverse();
                buffer.forEach((q, i) => {
                    const realIdx = this.idx + (buffer.length - 1 - i);
                    const el = document.createElement('div');
                    el.className = 'card';
                    el.innerHTML = `<p>${q.text}</p><div class="card-sub">${q.sub}</div><div class="card-id">${q.id}</div>`;
                    
                    if(realIdx === this.idx) {
                        el.style.zIndex = 100;
                        this.activeEl = el;
                        PHYSICS.bind(el);
                    } else {
                        el.style.zIndex = 90;
                        el.style.transform = 'translate(-50%, -50%) scale(0.95) translateY(20px)';
                        el.style.opacity = 0.5;
                    }
                    stack.appendChild(el);
                });
                this.updateUI();
            },

            updateUI() {
                const q = this.deck[this.idx];
                document.getElementById('ui-topic').textContent = q.topic;
                document.getElementById('ui-type').textContent = q.type;
                document.getElementById('ui-progress').style.width = ((this.idx/this.deck.length)*100)+'%';
                document.getElementById('lbl-up').textContent = q.up;
                document.getElementById('lbl-down').textContent = q.down;
                document.getElementById('lbl-left').textContent = q.left;
                document.getElementById('lbl-right').textContent = q.right;
            },

            finish() {
                document.getElementById('view-game').classList.remove('active');
                document.getElementById('view-summary').classList.add('active');
                const score = Object.values(this.answers).reduce((a,b)=>a+b.score,0);
                const mistakes = Object.values(this.answers).filter(a => !a.correct && a.dir !== 'left');
                
                document.getElementById('chart-score').textContent = score;

                // Render Chart
                this.renderChart();

                if (mistakes.length > 0) {
                    document.getElementById('review-cta').classList.remove('hidden');
                    this.reviewDeck = mistakes.map(a => a.q);
                }
                
                fetch(CONFIG.API_URL, {
                    method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify({ answers: this.answers, score, timestamp: new Date().toISOString() })
                });
            },

            renderChart() {
                const counts = {};
                let totalCorrect = 0;
                Object.values(this.answers).forEach(a => {
                    if(a.correct) {
                        const t = a.q.type;
                        counts[t] = (counts[t] || 0) + 1;
                        totalCorrect++;
                    }
                });

                const chartEl = document.getElementById('chart-pie');
                if (totalCorrect === 0) {
                    chartEl.style.background = '#334155';
                    return;
                }

                let gradient = [];
                let currentDeg = 0;
                Object.keys(counts).forEach((topic) => {
                    const color = CONFIG.CHART_COLORS[topic] || '#cbd5e1';
                    const deg = (counts[topic] / totalCorrect) * 360;
                    gradient.push(`${color} ${currentDeg}deg ${currentDeg + deg}deg`);
                    currentDeg += deg;
                });

                chartEl.style.background = `conic-gradient(${gradient.join(', ')})`;
            },

            startReview() {
                this.reviewIdx = 0;
                document.getElementById('view-summary').classList.remove('active');
                document.getElementById('view-review').classList.add('active');
                this.renderReview();
            },

            renderReview() {
                if (this.reviewIdx >= this.reviewDeck.length) {
                    document.getElementById('view-review').classList.remove('active');
                    document.getElementById('view-summary').classList.add('active');
                    return;
                }
                const q = this.reviewDeck[this.reviewIdx];
                document.getElementById('rev-q').textContent = q.text;
                document.getElementById('rev-sol').textContent = q.explanation;
                document.getElementById('rev-count').textContent = `${this.reviewIdx + 1} / ${this.reviewDeck.length}`;
            },

            nextReview() {
                this.reviewIdx++;
                this.renderReview();
            }
        };

        const PHYSICS = {
            el: null, startX: 0, startY: 0, dragging: false, overlay: document.getElementById('ui-overlay'),

            bind(el) {
                this.el = el;
                el.addEventListener('touchstart', this.start.bind(this), {passive:false});
                el.addEventListener('mousedown', this.start.bind(this));
            },

            start(e) {
                this.dragging = true;
                const p = e.touches ? e.touches[0] : e;
                this.startX = p.clientX; this.startY = p.clientY;
                this.el.style.transition = 'none';
                
                window.addEventListener('touchmove', this.move.bind(this), {passive:false});
                window.addEventListener('mousemove', this.move.bind(this));
                window.addEventListener('touchend', this.end.bind(this));
                window.addEventListener('mouseup', this.end.bind(this));
            },

            move(e) {
                if(!this.dragging) return;
                if(e.cancelable) e.preventDefault();
                
                const p = e.touches ? e.touches[0] : e;
                const dx = p.clientX - this.startX;
                const dy = p.clientY - this.startY;

                this.el.style.transform = `translate(-50%, -50%) translate(${dx}px, ${dy}px) rotate(${dx*0.05}deg)`;
                this.feedback(dx, dy);
            },

            end(e) {
                if(!this.dragging) return;
                this.dragging = false;
                window.removeEventListener('touchmove', this.move.bind(this));
                window.removeEventListener('mousemove', this.move.bind(this));
                window.removeEventListener('touchend', this.end.bind(this));
                window.removeEventListener('mouseup', this.end.bind(this));

                const p = e.changedTouches ? e.changedTouches[0] : e;
                const dx = p.clientX - this.startX;
                const dy = p.clientY - this.startY;

                if(Math.abs(dy) > CONFIG.THRESHOLD && Math.abs(dy) > Math.abs(dx)) this.commit(dy<0?'up':'down');
                else if(Math.abs(dx) > CONFIG.THRESHOLD) this.commit(dx>0?'right':'left');
                else this.reset();
            },

            feedback(dx, dy) {
                const ax=Math.abs(dx), ay=Math.abs(dy);
                let color='', cls='';
                
                if(ay>ax) { color = dy<0 ? CONFIG.COLORS.UP : CONFIG.COLORS.DOWN; cls = dy<0 ? 'up' : 'down'; }
                else { color = dx>0 ? CONFIG.COLORS.RIGHT : CONFIG.COLORS.LEFT; cls = dx>0 ? 'right' : 'left'; }
                
                const intensity = Math.min(Math.max(ax, ay) / CONFIG.THRESHOLD, 1);
                this.overlay.style.backgroundColor = color;
                this.overlay.style.opacity = intensity * 0.5;

                document.querySelectorAll('.ctrl').forEach(c => {
                    c.classList.remove('active');
                    c.style.color = '';
                });
                
                if(intensity > 0.2) {
                    const btn = document.querySelector(`.ctrl.${cls}`);
                    btn.classList.add('active');
                    btn.style.color = color;
                }
            },

            reset() {
                this.el.style.transition = 'transform 0.3s cubic-bezier(0.2,0.8,0.2,1)';
                this.el.style.transform = 'translate(-50%, -50%)'; 
                this.overlay.style.opacity = 0;
                document.querySelectorAll('.ctrl').forEach(c => { c.classList.remove('active'); c.style.color = ''; });
            },

            commit(dir) {
                const q = APP.deck[APP.idx];
                const score = dir===q.correct ? 10*q.w : (dir==='left'?0:-5);
                APP.answers[q.id] = { dir, score, correct: dir===q.correct, q: q };

                let tx=0, ty=0; const d=800;
                if(dir==='up') ty=-d; if(dir==='down') ty=d; if(dir==='left') tx=-d; if(dir==='right') tx=d;

                this.el.style.transition = 'transform 0.4s ease-in';
                this.el.style.transform = `translate(-50%, -50%) translate(${tx}px, ${ty}px) rotate(${tx*0.1}deg)`;
                
                this.overlay.style.opacity = 0;
                document.querySelectorAll('.ctrl').forEach(c => { c.classList.remove('active'); c.style.color = ''; });

                setTimeout(() => {
                    this.el.remove();
                    APP.idx++;
                    APP.render();
                }, 300);
            }
        };

        document.body.addEventListener('touchmove', e => e.preventDefault(), {passive:false});
    </script>
</body>
</html>
