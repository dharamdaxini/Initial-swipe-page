<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Offline Chemistry Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
/* ===== BASE UI (UNCHANGED CORE LOOK) ===== */
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
#app{
  width:90%;
  max-width:420px;
  background:#111;
  border-radius:16px;
  padding:20px;
  max-height:90vh;
  overflow-y:auto;
}
h2{
  font-size:clamp(1rem,4.5vw,1.3rem);
  line-height:1.4;
}
.option,.topic{
  padding:12px;
  margin-bottom:10px;
  background:#1c1c1c;
  border-radius:10px;
  cursor:pointer;
}
.option.correct{background:#1e7e34;}
.option.wrong{background:#7e1e1e;}
.topic{text-align:center;font-weight:bold;}
#hint,#explanation{
  font-size:clamp(.8rem,3.6vw,.95rem);
  color:#aaa;
  margin-top:10px;
}
button{
  margin-top:16px;
  padding:12px;
  width:100%;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>
<div id="app">
  <h2 id="title">Select Set</h2>
  <div id="content"></div>
</div>

<script>

  /* /* ===============================
   OFFLINE TOPIC QUIZ ENGINE
   =============================== */

/* ---------- CONFIG ---------- */
const LOG_ENDPOINT =
"https://script.google.com/macros/s/AKfycbxMOVzmONXP6nAHNoN92nmO2MnMPek7omYcw0JCeizbsIOQZUik0VmUK0nT/exec";

/* ---------- STATE ---------- */
let STATE = "SET";              // SET → TOPIC → DEPTH → QUIZ → END
let CURRENT_SET = null;
let CURRENT_TOPIC = null;
let CURRENT_DEPTH = null;

let POOL = [];
let INDEX = 0;
let LOCKED = false;

let SESSION_ID =
"SESS_" + Math.random().toString(36).slice(2,7).toUpperCase();

/* ---------- DOM ---------- */
const titleEl = document.getElementById("title");
const contentEl = document.getElementById("content");

/* ---------- INIT ---------- */
window.onload = () => {
  renderSet();
};

/* ===============================
   LAYER 1 — SET
   =============================== */
function renderSet(){
  STATE = "SET";
  CURRENT_SET = null;
  visibleReset();

  titleEl.innerText = "Select Set";
  contentEl.innerHTML = "";

  unique(DATA.map(q => q.set)).forEach(set => {
    addTile(set, () => {
      CURRENT_SET = set;
      renderTopic();
    });
  });
}

/* ===============================
   LAYER 2 — TOPIC
   =============================== */
function renderTopic(){
  STATE = "TOPIC";
  CURRENT_TOPIC = null;
  visibleReset();

  titleEl.innerText = "Select Topic";
  contentEl.innerHTML = "";

  unique(
    DATA.filter(q => q.set === CURRENT_SET)
        .map(q => q.category)
  ).forEach(topic => {
    addTile(topic, () => {
      CURRENT_TOPIC = topic;
      renderDepth();
    });
  });
}

/* ===============================
   LAYER 3 — DEPTH
   =============================== */
function renderDepth(){
  STATE = "DEPTH";
  CURRENT_DEPTH = null;
  visibleReset();

  titleEl.innerText = "Select Depth";
  contentEl.innerHTML = "";

  addTile("Concept", () => startQuiz("CONCEPT"));
  addTile("Application", () => startQuiz("APPLICATION"));
}

/* ===============================
   QUIZ START
   =============================== */
function startQuiz(depth){
  STATE = "QUIZ";
  CURRENT_DEPTH = depth;
  INDEX = 0;
  LOCKED = false;

  POOL = shuffle(
    DATA.filter(q =>
      q.set === CURRENT_SET &&
      q.category === CURRENT_TOPIC
    )
  );

  renderQuestion();
}

/* ===============================
   QUESTION RENDER
   =============================== */
function renderQuestion(){
  visibleReset();
  contentEl.innerHTML = "";

  if (INDEX >= POOL.length) {
    renderEnd();
    return;
  }

  const q = POOL[INDEX];

  titleEl.innerText = CURRENT_TOPIC;

  const qEl = document.createElement("h2");
  qEl.innerText = q.question;
  contentEl.appendChild(qEl);

  ["option_up","option_right","option_left"].forEach(key => {
    const o = document.createElement("div");
    o.className = "option";
    o.innerText = q[key];
    o.onclick = () => handleAnswer(key, q, o);
    contentEl.appendChild(o);
  });

  const hint = document.createElement("div");
  hint.id = "hint";
  hint.innerText = "Hint: " + q.hint;
  contentEl.appendChild(hint);

  const exp = document.createElement("div");
  exp.id = "explanation";
  contentEl.appendChild(exp);

  const next = document.createElement("button");
  next.innerText = "NEXT";
  next.style.display = "none";
  next.onclick = () => {
    INDEX++;
    renderQuestion();
  };
  contentEl.appendChild(next);
}

/* ===============================
   ANSWER HANDLER
   =============================== */
function handleAnswer(choice, q, el){
  if (LOCKED) return;
  LOCKED = true;

  document.querySelectorAll(".option").forEach(o => {
    o.style.pointerEvents = "none";
    if (o.innerText === q[q.correct_option]) {
      o.classList.add("correct");
    }
  });

  if (choice !== q.correct_option) {
    el.classList.add("wrong");
  }

  document.getElementById("explanation").innerText = q.explanation;
  contentEl.querySelector("button").style.display = "block";

  logInteraction(q.id, choice);
}

/* ===============================
   SESSION END
   =============================== */
function renderEnd(){
  STATE = "END";
  visibleReset();

  titleEl.innerText = "Session Complete";
  contentEl.innerHTML = "";

  addTile("Restart", restart);
}

/* ===============================
   RESTART
   =============================== */
function restart(){
  SESSION_ID =
  "SESS_" + Math.random().toString(36).slice(2,7).toUpperCase();

  INDEX = 0;
  POOL = [];
  LOCKED = false;

  renderSet();
}

/* ===============================
   BACKEND LOGGING
   =============================== */
function logInteraction(id, choice){
  fetch(LOG_ENDPOINT, {
    method: "POST",
    body: JSON.stringify([{
      id: id,
      choice: choice,
      latency: 0,
      session: SESSION_ID
    }])
  }).catch(() => {});
}

/* ===============================
   HELPERS
   =============================== */
function addTile(text, fn){
  const d = document.createElement("div");
  d.className = "topic";
  d.innerText = text;
  d.onclick = fn;
  contentEl.appendChild(d);
}

function shuffle(arr){
  return arr
    .map(v => [Math.random(), v])
    .sort((a,b) => a[0] - b[0])
    .map(v => v[1]);
}

function unique(arr){
  return [...new Set(arr)];
}

function visibleReset(){
  LOCKED = false;
} */


/* ===============================
   CONFIG – BACKEND LOGGING
   =============================== */
const LOG_ENDPOINT =
"https://script.google.com/macros/s/AKfycbxMOVzmONXP6nAHNoN92nmO2MnMPek7omYcw0JCeizbsIOQZUik0VmUK0nT/exec";

/* ===============================
   STATE ENGINE
   =============================== */
let STATE = "SET";
let CURRENT_SET = null;
let CURRENT_TOPIC = null;
let CURRENT_DEPTH = null;

let POOL = [];
let INDEX = 0;
let SESSION_ID = "SESS_" + Math.random().toString(36).slice(2,7).toUpperCase();

const titleEl = document.getElementById("title");
const contentEl = document.getElementById("content");

/* ===============================
   INIT
   =============================== */
renderSet();

/* ===============================
   SET → TOPIC → DEPTH
   =============================== */
function renderSet(){
  STATE="SET";
  titleEl.innerText="Select Set";
  contentEl.innerHTML="";
  ["SET_A"].forEach(s=>{
    makeTopic(s,()=>{CURRENT_SET=s;renderTopic();});
  });
}

function renderTopic(){
  STATE="TOPIC";
  titleEl.innerText="Select Topic";
  contentEl.innerHTML="";
  unique(DATA.filter(q=>q.set===CURRENT_SET).map(q=>q.category))
    .forEach(t=>makeTopic(t,()=>{CURRENT_TOPIC=t;renderDepth();}));
}

function renderDepth(){
  STATE="DEPTH";
  titleEl.innerText="Select Depth";
  contentEl.innerHTML="";
  makeTopic("Concept",()=>startQuiz("CONCEPT"));
  makeTopic("Application",()=>startQuiz("APPLICATION"));
}

function makeTopic(text,fn){
  const d=document.createElement("div");
  d.className="topic";
  d.innerText=text;
  d.onclick=fn;
  contentEl.appendChild(d);
}

/* ===============================
   QUIZ ENGINE
   =============================== */
function startQuiz(depth){
  STATE="QUIZ";
  CURRENT_DEPTH=depth;
  INDEX=0;

  POOL = shuffle(
    DATA.filter(q =>
      q.set===CURRENT_SET &&
      q.category===CURRENT_TOPIC
    )
  );

  renderQuestion();
}

function renderQuestion(){
  contentEl.innerHTML="";
  if(INDEX>=POOL.length){
    titleEl.innerText="Session Complete";
    makeTopic("Restart",restart);
    return;
  }

  const q=POOL[INDEX];
  titleEl.innerText=CURRENT_TOPIC;

  const qEl=document.createElement("h2");
  qEl.innerText=q.question;
  contentEl.appendChild(qEl);

  ["option_up","option_right","option_left"].forEach(k=>{
    const o=document.createElement("div");
    o.className="option";
    o.innerText=q[k];
    o.onclick=()=>answer(k,q,o);
    contentEl.appendChild(o);
  });

  const hint=document.createElement("div");
  hint.id="hint";
  hint.innerText="Hint: "+q.hint;
  contentEl.appendChild(hint);

  const exp=document.createElement("div");
  exp.id="explanation";
  contentEl.appendChild(exp);

  const next=document.createElement("button");
  next.innerText="NEXT";
  next.style.display="none";
  next.onclick=()=>{INDEX++;renderQuestion();};
  contentEl.appendChild(next);
}

function answer(choice,q,el){
  document.querySelectorAll(".option").forEach(o=>{
    o.style.pointerEvents="none";
    if(o.innerText===q[q.correct_option])o.classList.add("correct");
  });
  if(choice!==q.correct_option)el.classList.add("wrong");

  document.getElementById("explanation").innerText=q.explanation;
  contentEl.querySelector("button").style.display="block";

  logInteraction(q.id,choice);
}

/* ===============================
   BACKEND LOGGING
   =============================== */
function logInteraction(id,choice){
  fetch(LOG_ENDPOINT,{
    method:"POST",
    body:JSON.stringify([{
      id,
      choice,
      latency:0,
      session:SESSION_ID
    }])
  }).catch(()=>{});
}

/* ===============================
   UTILITIES
   =============================== */
function shuffle(a){
  return a.map(v=>[Math.random(),v])
          .sort((a,b)=>a[0]-b[0])
          .map(v=>v[1]);
}
function unique(a){return [...new Set(a)];}

function restart(){
  SESSION_ID="SESS_"+Math.random().toString(36).slice(2,7).toUpperCase();
  renderSet();
}
</script>
</body>
</html>
