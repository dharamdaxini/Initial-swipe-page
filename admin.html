<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIA.STACK | MASTER LAB v133.27</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --bg: #050505; --panel: #0a0a0a; --border: #222; 
            --gold: #ffd600; --blue: #2979ff; --red: #ff4757; --green: #00e676;
            --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
            
            /* Protocol v132.55 Constants */
            --border-thick: 3px;
            --border-medium: 2px;
            --border-thin: 1px;
            --color-black: #000000;
            --color-white: #ffffff;
            --color-grey-tint: #f4f4f4;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: #ccc; font-family: var(--font-ui); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- DASHBOARD UI (UNCHANGED) --- */
        #master-scroll { flex: 1; overflow-y: auto; scroll-behavior: smooth; padding-bottom: 80px; }
        header { position: sticky; top: 0; z-index: 100; background: rgba(5,5,5,0.98); border-bottom: 1px solid var(--border); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.1rem; font-weight: 900; color: #fff; letter-spacing: -0.5px; }
        .brand span { color: var(--gold); }
        .status-pill { background: #111; border: 1px solid #333; padding: 6px 12px; border-radius: 4px; font-family: var(--font-code); font-size: 0.6rem; color: var(--green); display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green); }
        .dot.off { background: var(--red); box-shadow: none; }
        .zone { padding: 30px; border-bottom: 1px dashed #222; position: relative; }
        .zone-title { font-size: 0.7rem; font-weight: 900; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .ingest-box { width: 100%; height: 200px; background: #080808; border: 1px solid #333; border-radius: 12px; padding: 20px; font-family: var(--font-code); font-size: 0.7rem; color: var(--blue); resize: none; transition: 0.2s; line-height: 1.5; white-space: pre; overflow: auto; }
        .ingest-box:focus { border-color: var(--gold); background: #0b0b0b; color: #fff; }
        .action-bar { display: flex; gap: 15px; margin-top: 20px; align-items: center; }
        .btn-pill { background: var(--gold); color: #000; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 900; font-size: 0.8rem; cursor: pointer; text-transform: uppercase; transition: 0.2s; box-shadow: 0 5px 20px rgba(255, 214, 0, 0.2); }
        .btn-pill:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-ghost { background: transparent; border: 1px solid #444; color: #888; padding: 10px 20px; border-radius: 50px; font-weight: 700; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-ghost:hover { border-color: #fff; color: #fff; }
        .push-btn { width: 100%; background: var(--green); color: #000; border: none; padding: 20px; border-radius: 12px; font-weight: 900; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 20px; cursor: pointer; box-shadow: 0 10px 30px rgba(0, 230, 118, 0.2); transition: 0.2s; }
        .push-btn:hover { transform: scale(1.02); box-shadow: 0 15px 40px rgba(0, 230, 118, 0.3); }
        .terminal { background: #000; border: 1px solid #222; border-radius: 8px; padding: 15px; font-family: var(--font-code); font-size: 0.7rem; color: #666; height: 120px; overflow-y: auto; margin-top: 15px; }
        .grid-6 { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .tile { background: #0e0e0e; border: 1px solid #222; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .tile:hover { border-color: var(--blue); background: #151515; }
        .tile-icon { font-size: 1.2rem; margin-bottom: 8px; display: block; opacity: 0.8; }
        .tile-label { font-size: 0.65rem; font-weight: 800; color: #aaa; text-transform: uppercase; }
        .tile.gold-border { border-color: var(--gold); background: rgba(255, 214, 0, 0.05); }

        /* --- PDF PROTOCOL STYLES (v132.55) --- */
        /* These do not affect the Dashboard because they are scoped to .page-frame */
        .page-frame {
            display: none; /* Hidden on Dashboard */
            width: 210mm; padding: 20mm; margin: auto; box-sizing: border-box;
            background: white; color: black; font-family: 'Inter', sans-serif;
        }
        .header-thick-border { border-bottom: var(--border-thick) solid var(--color-black); padding-bottom: 5px; margin-bottom: 2px; }
        .header-thin-border-pdf { border-bottom: var(--border-thin) solid var(--color-black); padding: 4px 0; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .research-unit-container { border: var(--border-medium) solid var(--color-black); padding: 15px; page-break-inside: avoid; margin-bottom: 30px; position: relative; }
        .unit-id-bar { background-color: var(--color-grey-tint); border: var(--border-thin) solid var(--color-black); padding: 5px 10px; font-size: 9pt; margin-bottom: 15px; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        .section-block { margin-bottom: 15px; }
        .mono-label { font-family: 'JetBrains Mono', monospace; font-size: 8pt; font-weight: 700; text-transform: uppercase; }
        .mono-small { font-family: 'JetBrains Mono', monospace; font-size: 8pt; }
        .mono-bold { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 10pt; }
        .serif-question-text { font-family: 'Crimson Text', serif; font-size: 16pt; line-height: 1.4; padding: 10px 0; font-weight: 400; }
        .options-grid-container { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: var(--border-thin) solid var(--color-black); border-bottom: var(--border-thin) solid var(--color-black); margin: 15px 0; }
        .grid-col { padding: 10px; border-right: var(--border-thin) solid var(--color-black); display: flex; flex-direction: column; align-items: center; }
        .grid-col:last-child { border-right: none; }
        .inter-value { font-family: 'Inter', sans-serif; font-weight: 400; font-size: 10pt; }
        .logic-separator { text-align: center; margin-bottom: 8px; }
        .serif-logic-text { font-family: 'Crimson Text', serif; font-style: italic; font-size: 12pt; color: #333; line-height: 1.4; }
        .hint-anchor-inverted { background-color: var(--color-black); color: var(--color-white); padding: 10px; font-family: 'JetBrains Mono', monospace; font-size: 9pt; margin-top: 20px; border: var(--border-thin) solid var(--color-black); }

        /* MODALS & OVERLAYS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 500px; background: #111; border: 1px solid #333; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; }
        #observer-layer { display:none; position:fixed; inset:0; background:var(--bg); z-index:5000; flex-direction:column; }
        
        @media print {
            body * { visibility: hidden; }
            .page-frame, .page-frame * { visibility: visible; }
            .page-frame { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
            @page { margin: 0; size: A4; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">VIA.<span>STACK</span> <span style="font-weight:400; color:#666; font-size:0.7rem; margin-left:10px;">// MASTER LAB v133.27</span></div>
    <div class="status-pill" onclick="checkLocalData()">
        <div class="dot" id="db-status-dot"></div>
        <span id="db-status-text">DB READY</span>
    </div>
</header>

<div id="master-scroll">
    <div class="zone">
        <div class="zone-title">01 // INGESTION ENGINE</div>
        <textarea id="raw-input" class="ingest-box" placeholder=">> PASTE RAW 25-COL TSV DATA HERE..."></textarea>
        <div class="action-bar">
            <button class="btn-pill" onclick="initiateAlignment()">INITIATE ALIGNMENT</button>
            <button class="btn-ghost" onclick="document.getElementById('raw-input').value=''">CLEAR</button>
        </div>
        <div class="terminal" id="console-log"><div class="log-entry">> WAITING FOR INPUT...</div></div>
    </div>

    <div class="zone">
        <div class="zone-title">02 // DEPLOYMENT DOCK</div>
        <div class="grid-6">
            <div class="tile gold-border" onclick="exportJSON()"><span class="tile-icon">ðŸ“¦</span><span class="tile-label">JSON BACKUP</span></div>
            <div class="tile" onclick="exportPDF()"><span class="tile-icon">ðŸ“„</span><span class="tile-label">EXPORT PROTOCOL</span></div>
            <div class="tile" onclick="exportTSV()"><span class="tile-icon">ðŸ“Š</span><span class="tile-label">EXPORT TSV</span></div>
            <div class="tile" onclick="exportCSV()"><span class="tile-icon">ðŸ“‘</span><span class="tile-label">EXPORT CSV</span></div>
        </div>
        <button class="push-btn" onclick="pushToIndex()">>>> PUSH TO OPERATOR INDEX >>></button>
    </div>

    </div>

<div id="pdf-render-area" class="page-frame"></div>

<script>
    let STAGED_DATA = [];
    const DB_KEY = 'ALCHEMIST_MASTER_DB';

    // --- RENDERING PIPELINE v132.55 ---
    function exportPDF() {
        const data = getDataFromStorage();
        if (data.length === 0) return log("NO DATA TO EXPORT.", "err");

        const renderArea = document.getElementById('pdf-render-area');
        let html = `
            <div class="header-thick-border">
                <span class="mono-bold">ALCHEMIST_RESEARCH_PROTOCOL // v133.27</span>
            </div>
            <div class="header-thin-border-pdf">
                <span class="mono-small">SESSION_DATE: ${new Date().toISOString().split('T')[0]}</span>
                <span class="mono-small">SOURCE: MASTER_VAULT</span>
            </div>
        `;

        data.forEach(item => {
            html += `
                <div class="research-unit-container">
                    <div class="unit-id-bar">[REF_ID: ${item.id}] // [${item.dom}] > ${item.topic}</div>
                    
                    <div class="section-block">
                        <div class="mono-label">QUESTION:</div>
                        <div class="serif-question-text">${item.q}</div>
                    </div>

                    <div class="options-grid-container">
                        <div class="grid-col"><span class="mono-label">[UP]</span> <span class="inter-value">${item.u}</span></div>
                        <div class="grid-col"><span class="mono-label">[RIGHT]</span> <span class="inter-value">${item.r}</span></div>
                        <div class="grid-col"><span class="mono-label">[LEFT]</span> <span class="inter-value">${item.l}</span></div>
                    </div>

                    <div class="section-block">
                        <div class="logic-separator mono-label">/ THEORETICAL LOGIC /</div>
                        <div class="serif-logic-text">${item.logic || 'No logic provided.'}</div>
                    </div>

                    <div class="section-block" style="margin-top:10px; display:flex; gap:20px;">
                        <div><span class="mono-label">EXECUTION A:</span> <span class="inter-value">${item.s1 || 'N/A'}</span></div>
                        <div><span class="mono-label">EXECUTION B:</span> <span class="inter-value">${item.s2 || 'N/A'}</span></div>
                    </div>

                    <div class="hint-anchor-inverted">
                        <span class="mono-bold">HINT:</span> ${item.hint}
                    </div>
                </div>
            `;
        });

        renderArea.innerHTML = html;
        window.print(); // Chromium-based rendering trigger
    }

    // --- CORE LOGIC (RETAINED) ---
    function initiateAlignment() {
        const raw = document.getElementById('raw-input').value;
        if(!raw.trim()) return log("NO INPUT.", "err");
        let lines = raw.split('\n').filter(l => l.trim() !== "" && !l.startsWith('ID\t'));
        
        STAGED_DATA = lines.map(line => {
            const cols = line.split('\t');
            return {
                id: cols[0], set: cols[1], dom: cols[2], topic: cols[3],
                q: cols[5], u: cols[6], r: cols[7], l: cols[8],
                logic: cols[10], hint: cols[11], s1: cols[22], s2: cols[23]
            };
        });
        log(`ALIGNED ${STAGED_DATA.length} UNITS.`, "success");
    }

    function pushToIndex() {
        if(STAGED_DATA.length === 0) return log("STAGE EMPTY.", "err");
        localStorage.setItem(DB_KEY, JSON.stringify(STAGED_DATA));
        log("PUSH SUCCESSFUL.", "success");
        checkLocalData();
    }

    function getDataFromStorage() { return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); }
    function log(m, t) { document.getElementById('console-log').innerHTML = `<div class="log-entry log-${t}">> ${m}</div>`; }
    function checkLocalData() {
        const hasData = !!localStorage.getItem(DB_KEY);
        document.getElementById('db-status-text').innerText = hasData ? "DB CONNECTED" : "DB EMPTY";
        document.getElementById('db-status-dot').className = hasData ? "dot" : "dot off";
    }

    window.onload = checkLocalData;
</script>

</body>
</html>
