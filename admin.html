<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIA.STACK | MASTER LAB v133.27-H</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { 
            --bg: #050505; --gold: #ffd600; --blue: #2979ff; --red: #ff4757; --green: #00e676;
            --font-book: 'Crimson Text', serif; 
            --font-ui: 'Inter', sans-serif; 
            --font-mono: 'JetBrains Mono', monospace; 
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: #ccc; font-family: var(--font-ui); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        sub { font-size: 0.75em; vertical-align: sub; line-height: 0; }
        sup { font-size: 0.75em; vertical-align: super; line-height: 0; }
        #master-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        header { position: sticky; top: 0; z-index: 100; background: rgba(5,5,5,0.98); border-bottom: 1px solid #222; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.1rem; font-weight: 900; color: #fff; }
        .brand span { color: var(--gold); }
        .zone { padding: 30px; border-bottom: 1px dashed #222; }
        .zone-title { font-size: 0.7rem; font-weight: 900; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .ingest-box { width: 100%; height: 200px; background: #080808; border: 1px solid #333; border-radius: 12px; padding: 20px; font-family: var(--font-mono); font-size: 0.7rem; color: var(--blue); resize: none; white-space: pre; }
        .btn-pill { background: var(--gold); color: #000; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 900; font-size: 0.8rem; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .grid-6 { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .tile { background: #0e0e0e; border: 1px solid #222; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .push-btn { width: 100%; background: var(--green); color: #000; padding: 20px; border-radius: 12px; font-weight: 900; text-transform: uppercase; margin-top: 20px; cursor: pointer; border: none; }
        .terminal { background: #000; border: 1px solid #222; border-radius: 8px; padding: 15px; font-family: var(--font-mono); font-size: 0.7rem; color: #666; height: 100px; overflow-y: auto; margin-top: 15px; }
        #observer-layer { display:none; position:fixed; inset:0; background:var(--bg); z-index:5000; flex-direction:column; }
        table { width:100%; border-collapse:collapse; font-family:var(--font-mono); font-size:0.7rem; }
        th { text-align:left; padding:10px; border-bottom:1px solid #444; color:var(--gold); position: sticky; top: 0; background: #000; }
        td { padding:10px; border-bottom:1px solid #222; font-family: var(--font-book); color: #fff; font-size: 0.9rem; }
    </style>
</head>
<body>
<header><div class="brand">VIA.<span>STACK</span> LAB</div><div id="status">DB READY</div></header>
<div id="master-scroll">
    <div class="zone">
        <div class="zone-title">01 // INGESTION (25-COL)</div>
        <textarea id="raw-input" class="ingest-box" placeholder="PASTE TSV DATA..."></textarea>
        <button class="btn-pill" onclick="initiateAlignment()">ALIGN DATA</button>
        <div class="terminal" id="console-log"></div>
    </div>
    <div class="zone">
        <div class="zone-title">02 // DEPLOYMENT</div>
        <div class="grid-6">
            <div class="tile" onclick="exportPDF()">üìÑ PDF PROTOCOL</div>
            <div class="tile" onclick="exportCSV()">üìë MASTER CSV</div>
            <div class="tile" onclick="openObserver()">üëÅÔ∏è OBSERVER</div>
        </div>
        <button class="push-btn" onclick="pushToIndex()">PUSH TO OPERATOR</button>
    </div>
</div>
<div id="observer-layer">
    <div style="padding:20px; border-bottom:1px solid #222; display:flex; justify-content:space-between;"><div class="brand">VAULT.<span>OBSERVER</span></div><button onclick="closeObserver()">EXIT</button></div>
    <div style="flex:1; overflow:auto; padding:20px;"><table id="observer-table"><thead><tr><th>ID</th><th>SET</th><th>QUESTION (RENDERED)</th></tr></thead><tbody id="observer-body"></tbody></table></div>
</div>
<script>
    /* --- FINAL BACKEND LOGIC --- */
    class TextFormatter {
        static parse(text) {
            if(!text) return '';
            return text.toString()
                .replace(/\|\|/g, '<br><br>') 
                .replace(/(\d+)([+\-])/g, '<sup>$1$2</sup>')
                .replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub>$2</sub>') 
                .replace(/\^([\-\d]+)/g, '<sup>$1</sup>') 
                .replace(/Delta/g, '&Delta;');
        }
    }

    const DB_KEY = 'ALCHEMIST_MASTER_DB';
    let STAGED = [], RAW_LINES = [];
    function log(m, t) { document.getElementById('console-log').innerHTML = `<div>> ${m}</div>` + document.getElementById('console-log').innerHTML; }
    function initiateAlignment() {
        RAW_LINES = document.getElementById('raw-input').value.split('\n').filter(l => !l.toUpperCase().startsWith('ID\t') && l.trim() !== "");
        STAGED = RAW_LINES.map(l => {
            const c = l.split('\t');
            return { id:c[0], set:c[1], dom:c[2], topic:c[3], level:c[4], q:c[5], u:c[6], r:c[7], l:c[8], correct:c[9], logic:c[10], hint:c[11], ctx:c[12], ref:c[13], tags:c[14], img:c[15], link:c[16], note:c[17], date:c[18], rev:c[19], w_up:c[20], w_side:c[21], s1:c[22], s2:c[23], raw25:c[24]||"N/A" };
        });
        log("ALIGNMENT SUCCESS.", 'ok');
    }
    function pushToIndex() { localStorage.setItem(DB_KEY, JSON.stringify(STAGED)); log("PUSHED.", 'ok'); }
    function exportCSV() {
        let csv = "ID,SET,DOM,TOPIC,LEVEL,Q,UP,RIGHT,LEFT,ANS,LOGIC,HINT,CTX,REF,TAGS,IMG,LINK,NOTE,DATE,REV,W_UP,W_SIDE,S1,S2,RAW25\n";
        STAGED.forEach(r => { const q = (t) => `"${String(t).replace(/"/g, '""')}"`; csv += `${Object.values(r).map(q).join(',')}\n`; });
        const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'MASTER.csv'; a.click();
    }
    function exportPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF(); const W = doc.internal.pageSize.getWidth(); let y = 20;
        STAGED.forEach(i => {
            if(y > 250) { doc.addPage(); y = 20; }
            doc.setFontSize(10); doc.text(`${i.id} // ${i.dom} > ${i.topic}`, 15, y); y += 10;
            const qL = doc.splitTextToSize(`Q: ${i.q}`, W-30); doc.text(qL, 15, y); y += (qL.length*5)+15;
        });
        doc.save('PROTOCOL.pdf');
    }
    function openObserver() { 
        const db = JSON.parse(localStorage.getItem(DB_KEY)||'[]'); 
        document.getElementById('observer-body').innerHTML = db.map(r => `<tr><td>${r.id}</td><td>${r.set}</td><td>${TextFormatter.parse(r.q)}</td></tr>`).join('');
        document.getElementById('observer-layer').style.display='flex'; 
    }
    function closeObserver() { document.getElementById('observer-layer').style.display='none'; }
</script>
</body>
</html>
